---
title: "Membership History - Bang Personal Training (Jan 2018 - Oct 2020)"
author: "Michael Hoang"
date: "01/01/2021"
output:
  html_document: default
  word_document: default
---

#                                                                       **INTRODUCTION**

  Since being hired in 2017, I've seen a numerous members walk-in through the doors of Bang Personal Training (formerly Bang Fitness).  Being in a fitness studio setting, it isn't too surprising to see clients come and go.  However, considering that we are located in Downtown Toronto where there is a surplus of both boutique fitness studio and big box gyms readily available, it is important to create/know our niche in this market space.  

  While working at Bang, there is very little to no impact that we can provide in terms of the training service working in the membership service team.  However, the same cannot be said as it pertains to non-training customer experience.  Time and again, customer experience has been shown to be an important determinant factor in impacting business performance across multiple industries & across various demographics as noted [here](https://www.emerald.com/insight/content/doi/10.1108/IJQSS-01-2015-0008/full/html) and [here](https://www.pwc.com/us/en/advisory-services/publications/consumer-intelligence-series/pwc-consumer-intelligence-series-customer-experience.pdf#page=8).  So, with our mission statement that "Big Box Gyms Suck", which has routinely been marked with notions of ["less than satisfactory" customer experience](https://www.lbbonline.com/news/research-reveals-gyms-need-to-workout-their-customer-experience), this is one area where boutique fitness studios (such as ourselves) can gain a footing in the market space.
  
  While boutique fitness studios tend to [excel over the big box gyms in this area](https://www.glofox.com/blog/defining-the-member-experience/) which is reflected in higher retention rates, it still doesn't absolve us from membership churn as this is something that is bound to happen.  Added to the fact that the 2020 Coronavirus pandemic impacting every industry, most notably the leisure-based industries [see here](https://www.spglobal.com/marketintelligence/en/news-insights/blog/industries-most-and-least-impacted-by-covid-19-from-a-probability-of-default-perspective-march-2020-update), there hasn't been a more important time to get some introspection to see what needs to be done to come out of this situation as unscathed as possible.  So, with the time spent over the initial Ontario lockdown in March 2020 learning Python + SQL + R (as there was only so much Netflix and YouTube content), I wanted to take a shot at examining the history of all members (past + present) to gleam some insight as it pertains to our demographics, membership type, attendance, types of customer-interactions, membership churn and their inter-relationship.  
  

  
#                                                                         **OBJECTIVE**

  Perform an exploratory analysis examining the demographics and membership behavior of past and current Bang Personal Training members.  The intention is to observe these factors in relation to membership retention as measured by length of membership before churn as well as measured by retention status at 3 major time points (3 months, 6 months and 12 months).  Ultimately, through looking at membership churn over the last two years, I would get an idea of which factors play a significant role in membership retention so as to revamp the on-boarding and membership service operating procedure going forward.  
  
  

#                                                                          **METHOD**

## **Data**

  For this analysis, I will be using a data set that I had created through the data that was *painfully* collected through the scheduling/payment software Wellness Living, entries from our CRM software Air Table, memory recall based on one-on-one interaction and the email history of all of the past/current members that existed between the period of January 1st, 2018 - October 5th, 2020.  However, it is important to note that that this data set had looked at the entire history of our members since their initial start date which could be as early as January 2012.   The following information that was collected for this dataset includes: 

^**Table1. Variables within the data set**^
  
|  **Variable Name**                                                     |   **Description**                                                               |
|------------------------------------------------------------------------|---------------------------------------------------------------------------------|
| name                                                                   | ~~Name of member~~ (redacted for privacy purposes)                              |
| id                                                                     | Identifier of the member                                                        |
| age_group                                                              | Age grouping for members                                                        |
| employment_sector                                                      | Employment sector for member                                                    |
| start_date                                                             | First ever day as a member of Bang Personal Training                            |
| end_date                                                               | Last ever day as a member of Bang Personal Training ^*^                         |
| length                                                                 | Total length of days as a member at Bang Personal Training                      |
| membership                                                             | Predominant membership type as a member at Bang Personal Training               |
| reason_to_leave                                                        | Reason to leave Bang Personal Training                                          |
| churn_type                                                             | Type of membership churn for former Bang Personal Training members              |
| lifetime_revenue                                                       | Lifetime revenue of a Bang Personal Training member                             |
| num_membership_change                                                  | Number of membership changes as a member of Bang Personal Training              |
| retention_3m/6m/12m                                                    | Retention status at 3 months, 6 months and 12 months                            |
| current                                                                | Membership status (as of 10-05-2020)                                            |
| active/former 1x/2x/3x/4x/unlimited/group/distance                     | Number of months at a given membership type as an active/former member          |
| active/former 1x/2x/3x/4x/unlimited/group/distance rate                | Weighted monthly rate at a given membership as an active/former member          |
| num_active_breaks / num_former_breaks                                  | Number of payment cycle breaks as an active/former member                       |
| num_active_reups / num_former_reups                                    | Number of membership renewals as an active/former member (per 66 days) ^**^     |
| num_ticket_billing                                                     | Number of email-interactions pertaining to billing issues                       |
| num_ticket_cx                                                          | Number of email-interactions not pertaining to billing/service/scheduling       |
| num_ticket_scheduling                                                  | Number of email-interactions pertaining to scheduling requests/changes ^***^    |
| num_ticket_service                                                     | Number of email-interactions pertaining to service-related requests ^****^      |
| total_sessions                                                         | Total possible number of sessions that could potentially be attended            |
| attended                                                               | Number of attended sessions                                                     |
| cancelled                                                              | Number of canceled sessions                                                     |
| lost                                                                   | Number of sessions lost                                                         |
| pending                                                                | Number of sessions with pending status (50:50)                                  |
| new_month                                                              | Was this the month that member started or returned                              |
| current_month                                                          | Was this the month that member was a member at Bang Personal Training           |
| leave_month                                                            | Was this the month that member left Bang Personal Training                      |

* For current members, this "end" will be listed at Oct 5th, 2020

** reupping the membership was based on 66 days as a baseline given its significance with behavior and habit adoption as noted by Lally P, van Jaarsveld CHM, Wardle J (2010). How are habits formed: modelling habit formation in the real world. Euro J Soc Psychol, 40: 998-1009; As long as member had at least 1 month of actual payments, will puy down "1" as an entry but will use analysis to clean this up. 

*** This does not include clincal based services like chiropractic, acupuncture, RMT or physiotherapy

**** This includes things like receipts, sending items, putting membership holds and whatever else. 


## **Tools Used** 

The data set was compiled into a CSV file using Excel and all statistical analyses were conducted using R and R Studio. 

```{r}

RNGkind(sample.kind = "Rounding")
setwd("~/MyDatasets")		# Used to set my working directory 
set.seed(123)             # Needed for the sake of replicability 

library(readr) 			# To read a rectangular data set in a fast and friendly way.
library(tidyverse) 	# A collection of packages that allow for ease in data analysis
library(dplyr) 			# A means to provide grammar for processes used in data manipulation 
library(tidyr) 			# A set of functions to help with tidying up the data
library(epiR) 			# A set of functions for demographic and empidemiologyical analysis 
library(ggplot2) 		# A system to allow for the creation of graphics based on the Grammar of Graphics 
library(stringr) 		# A set of functions to make it easier to work with strings
library(purrr) 			# A means for enhancing R's functional programming toolkit to allow for work on functions and vectors (i.e. replace the needs for loops)
library(tibble) 		# Essentially a new take on data frames that makes things easier to use when making data frames
library(carat) 			# Provides functions and command-line user interface to generate allocation sequence by covariate-adaptive randomization for clincal trials as well as ability to evaluate + compare the performance of randomization procedures and test based on various criteria
library(rmarkdown) 	# Turns my analysis into a document for reporting and presenting my work
library(plyr) 			# Makes it simple to split data apart, do stuff to it and mash it back together. 
library(magrittr) 	# A set of operators that improves code by operating as a pipe operator
library(aod) 			# A set of functions to analyze overdispersed counts or proportions to serve as complements to more sophisticated methods of modelling such as generalized estimating equations or generalized linear mixed effect models 
library(caret) 			# A set of functions to attempt to streamline the process for creating predictive models 
library(lubridate) 	# A set of functions to work with date-times and time-spans 
library(ggpubr) 		# A means to provide some easy-to-use functions for creating and customizing ggplot2-based publication ready plots. 
library(rstatix) 		# A simple and intuitive pipe-friendly framework for performing basic statistical tests like t-test, Wilcoxon Test, ANOVA, Kruskal-Wallis and Correlation Analyses. 
library(mgcv)  			# A package used to create generalized additive mixed models 
library(FSA)			  # Need it to perform post-hoc analysis for non-parametric distributions (i.e. Dunn Test)
library(caret)			# Contains functions to streamline the model training process for complex regression and classification problems
library(survival)		# Contains the core survival analysis routines, including definition of Surv objects, Kaplan-Meier and Aalen-Johansen (multi-state) curves, Cox models, and parametric accelerated failure time models.
library(survminer) 	# Contains the function 'ggsurvplot()' for drawing easily beautiful and 'ready-to-publish' survival curves with the 'number at risk' table and 'censoring count plot'. Other functions are also available to plot adjusted curves for ‘Cox' model and to visually examine ’Cox' model assumptions.
library(mgcv)       # Generalized additive (mixed) models, some of their extensions and other generalized ridge regression with multiple smoothing parameter estimation by (Restricted) Marginal Likelihood, Generalized Cross Validation and similar, or using iterated nested Laplace approximation for fully Bayesian inference
library(car)        # Need it to be able to use Variance Inflation Factor function
library(rms)        # Regression modeling, testing, estimation, validation, graphics, prediction, and typesetting by storing enhanced model design attributes in the fit
library(cowplot)    # provides various features that help with creating publication-quality figures, such as a set of themes, functions to align plots and arrange them into complex compound figures, and functions that make it easy to annotate plots and or mix plots with images
library(randomForest) # To make Random Forrest Plots
library(randomForestSRC) # Fast OpenMP parallel computing of Breiman's random forests for survival, competing risks, regression and classification based on Ishwaran and Kogalur's popular random survival forests (RSF) package
library(pec)        # Validation of risk predictions obtained from survival models and competing risk models based on censored data using inverse weighting and cross-validation
library(ggRandomForests)   # Graphic elements for exploring Random Forests using the 'randomForest' or 'randomForestSRC' package for survival, regression and classification forests and 'ggplot2' package plotting


bang = read.csv("CSM_Bang_no_names.csv", na = c(""))

```

## **Data cleaning** 

Upon loading this data set into R, the first process was to properly format every variable to its correct data type.  Each variable was formatted to the following type:

**Numeric**: id, length, lifetime revenue, number of membership change, active/former 1x/2x/3x/4x/unlimited/group/distance, active/former 1x/2x/3x/4x/unlimited/group/distance rate, number of breaks for active/former members, number of re-ups for active/former members, number of tickets for service/billing/scheduling/customer experience, total sessions, attended session, canceled sessions, lost sessions and pending sessions. 

**Categorical**: age groups, employment sectors, reason to leave, churn type, retention at 3m/6m/12m, current, new month, current month and leave month 


### AGE GROUPS

Age was determined based on birthday provided by member at time of signing up at Bang.  It was then classified within 5 groups to somewhat match the generation division.  These include (a) “Under 18”, (b) “18-29”, (c) “30-44”, (d) “45-64”, (e) “65+”.  For those with unknown age, they are listed as “NaN”.

```{r}

bang$age_group = ifelse(bang$age_group == 6, 5, bang$age_group)
bang$age_group = as.factor(bang$age_group) 
bang$age_group = revalue(bang$age_group, c('1' = 'Under 18', '2' = '18-29', '3' = '30-44', '4' = '45-64', '5' = '65+'))

```

### EMPLOYMENT SECTORS

Employment sectors was determined based on Google / LinkedIn search of the member (definitely not creepy at all).  Based on area of work, member’s were classified into one of the following options that best described their employment: (a) finance/insurance, (b) scientific/academic/educational, (c) technology/information, (d) social services/non-profits, (e) government/legal, (f) advertisement/media/art/culture, (g) real estate/construction/waste, (h) natural resources/energy, (i) manufacturing/trade, (j) transportation, (k) health care/health services, (l) professional/technical services, (m) hospitality/retail/accommodation, (n) student, (o) entrepreneur/owns business and (p) other.  For unknown entries, listed as “NaN”. 

```{r}
bang$employment_sector = as.factor(bang$employment_sector)
bang$employment_sector = revalue(
  bang$employment_sector, 
  c(
    '1' = 'Finance/Insurance',
    '2' = 'Scientific/Academic/Educational',
    '3' = 'Technology/Information',
    '4' = 'Social Services/Non-Profits',
    '5' = 'Government/Legal',
    '6' = 'Advertising/Media/Art/Culture',
    '7' = 'Real Estate/Construction/Waste',
    '8' = 'Natural Resource/Energy',
    '9' = 'Manufacturing/Trade',
    '10' = 'Transportation',
    '11' = 'Health Care/Services',
    '12' = 'Professional/Technical Services',
    '13' = 'Hospitality/Retail/Accomodation',
    '14' = 'Student',
    '15' = 'Entrepreneural/Owns Business',
    '16' = 'Other'
  )
)

```

### MEMBERSHIP

Seeing as some members had either increased or decreased their frequency, this can be a bit confusing. So in defining the membership of the member, it will be based on which membership the member had been frequently billed out as. 

```{r}

bang$membership = as.factor(bang$membership)
bang$membership = revalue(bang$membership, 
		c(
                            "1" = "1x",
                            '2' = '2x',
                            '3' = '3x',
                            '4' = '4x',
                            '5' = 'unlimited',
                            '6' = 'group',
                            '7' = 'distance')			
		 )

```

### ACTIVE / FORMER MONTH & RATES

In determining the bulk of the lifetime revenue of the member, their weighted monthly averages were determined from the total number of months at a particular membership type. This was further divided between those that were currently active and those that are not. This should be reflected as a numeric variable. 

```{r}

# Active and Former 
bang$active_1x = as.numeric(bang$active_1x)
bang$active_rate_1x = as.numeric(bang$active_rate_1x)
bang$active_2x = as.numeric(bang$active_2x)
bang$active_rate_2x = as.numeric(bang$active_rate_2x)
bang$active_3x = as.numeric(bang$active_3x)
bang$active_rate_3x = as.numeric(bang$active_rate_3x)
bang$active_4x = as.numeric(bang$active_4x)
bang$active_rate_4x = as.numeric(bang$active_rate_4x)
bang$active_rate_unlim  = as.numeric(bang$active_rate_unlim)
bang$active_unlim = as.numeric(bang$active_unlim)
bang$active_group = as.numeric(bang$active_group)
bang$active_rate_group = as.numeric(bang$active_rate_group)
bang$active_distance  = as.numeric(bang$active_distance)
bang$active_rate_distance =  as.numeric(bang$active_rate_distance)
bang$former_1x = as.numeric(bang$former_1x)
bang$former_rate_1x = as.numeric(bang$former_rate_1x)
bang$former_2x = as.numeric(bang$former_2x)
bang$former_rate_2x = as.numeric(bang$former_rate_2x)
bang$former_3x = as.numeric(bang$former_3x)
bang$former_rate_3x = as.numeric(bang$former_rate_3x)
bang$former_4x = as.numeric(bang$former_4x)
bang$former_rate_4x = as.numeric(bang$former_rate_4x)
bang$former_rate_unlim  = as.numeric(bang$former_rate_unlim)
bang$former_unlim = as.numeric(bang$former_unlim)
bang$former_group = as.numeric(bang$former_group)
bang$former_rate_group = as.numeric(bang$former_rate_group)
bang$former_distance  = as.numeric(bang$former_distance)
bang$former_rate_distance =  as.numeric(bang$former_rate_distance)

```

### REASON TO LEAVE

Based on email correspondence/exit surveys/CSM entries/memory recall, I’ve listed reasons for past members deciding to discontinue their membership at Bang based on the following categories: (a) loss of employment – unrelated to any global economic/pandemic reasonings, (b) finance/cost of membership, (c) medical/health-related reasons relating to themselves or immediate social circle, (d) moving away outside of neighbourhood area, (e) lack of accessibility or availability due to prior commitments in life, (f) pursuing other fitness interests, (g) just “ghosted” us, (h) was a time-based arrangement, (i) noted displeasure with Bang’s service or experience, (j) pandemic/global economic crisis or (k) anything other thing.  For unknown reasons, it is listed as “NaN”.

```{r}

bang$reason_to_leave = as.factor(bang$reason_to_leave)
bang$reason_to_leave = revalue(bang$reason_to_leave,
                               c(
                                 "1" = "loss of employment",
                                 '2' = 'financial',
                                 '3' = 'medical/health-related',
                                 '4' = 'moving away',
                                 '5' = 'lacking accessibility/availability',
                                 '6' = 'other fitness interest',
                                 '7' = 'ghosted us',
                                 '8' = 'time-based arrangement',
                                 '9' = 'noted displeasure with Bang',
                                 '10' = 'pandemic/global crisis', 
                                 '11' = 'other'
                               )
)

```

### CHURN TYPE

Using Lincoln Murphy’s description categorization of membership churn, which was originally used for software-as-a-service industry, former members were classified into one of four categories based on how they’ve left Bang through their email correspondence, recollection of exit, entries within CSM and other notes.  

These categories include: 
(a) unexpected and unavoidable (i.e. came out of nowhere and really no way of really “saving this”), 
(b) unexpected and avoidable (i.e. came out of nowhere, but intervention could have been done at any earlier time to have avoided this), 
(c) expected and unavoidable (i.e. we knew that this was coming for some time but there was no way of preventing this),
(d) expected and avoidable (i.e. we knew that this was coming, but could have been addressed earlier in some way to have prevented or at least acted upon it prior to notice)

```{r}

bang$churn_type = as.factor(bang$churn_type)

bang$churn_type = revalue(bang$churn_type, c('6' = '1'))

bang$churn_type = revalue(bang$churn_type, c(
  "1" = 'unexpected + unavoidable',
  '2' = 'unexpected + avoidable', 
  '3' = 'expected + unavoidable',
  '4' = 'expected + avoidable')
)

# Defining churn type 

bang = bang %>% 
	mutate(
		expected_churn = ifelse(c(churn_type == "expected + unavoidable" | churn_type == "expected + avoidable"), 'yes', 'no'),
		unexpected_churn = ifelse(c(churn_type == 'unexpected + unavoidable' | churn_type == "unexpected + avoidable"), 'yes', 'no'),
		avoidable_churn = ifelse(c(churn_type == 'unexpected + avoidable' | churn_type == "expected + avoidable"), 'yes', 'no'),
		unavoidable_churn = ifelse(c(churn_type == 'unexpected + unavoidable' | churn_type == "expected + unavoidable"), 'yes', 'no')
	) %>%
	mutate(
		expected_churn = as.factor(expected_churn),
		unexpected_churn = as.factor(unexpected_churn),
		avoidable_churn = as.factor(avoidable_churn),
		unavoidable_churn = as.factor(unavoidable_churn)
	) %>%
	mutate(
		expected_churn = relevel(expected_churn, ref = 'no'),
		unexpected_churn = relevel(unexpected_churn, ref = 'no'),
		avoidable_churn = relevel(avoidable_churn, ref = 'no'),
		unavoidable_churn = relevel(unavoidable_churn, ref = 'no')
	)

```

### RETENTION 3M/6M/12M

Often used within the area of clinical addiction research as significant time points for the adoption of a behavior change, these same timelines were used here as a measure of membership retention.   With a simple response of either “Yes” or “No”, it asks whether a member had continuously been a member at Bang for at least a 3-month, 6-month or 12-month stretch. 

```{r}

bang$retention_3m = as.factor(bang$retention_3m)
bang$retention_6m = as.factor(bang$retention_6m)
bang$retention_12m = as.factor(bang$retention_12m)

bang = bang %>% 
	mutate(
		retention_3m = revalue(retention_3m, c('0' = 'no', '1' = 'yes')),
		retention_6m = revalue(retention_6m, c('0' = 'no', '1' = 'yes')),
		retention_12m = revalue(retention_12m, c('0' = 'no', '1' = 'yes'))
		)

```

### CURRENT

This is just a determinant to see if said member is currently a Hybrid Training member currently attending sessions as of October 5th, 2020. 

```{r}

bang$current = as.factor(bang$current)
bang$current = revalue(bang$current,c("1" = "active", "0" = "former"))

```

### NEW / CURRENT / LEAVE STATUS

These variables were used in unison to determine the membership status from the period of January 1st 2018 to October 5th, 2020.  For each month in this period a member was listed as being either: (a) first-ever month at Bang or first month returning as a member at Bang, (b) are they still a member at Bang during this month or (c) did they leave Bang at this month.  Using the New/Current/Leave variables, which are either yes or no, there are 8 possible combinations.  However, this variable will have the following classifications:

^**Table2. Combinations of membership status across months/years**^

| NEW     | CURRENT   | LEAVE   | DESCRIPTION                                 |
|---------|-----------|---------|---------------------------------------------|
| No      | No        | No      | Was not a member during this month          |
| Yes     | No        | No      | First month as a new/returning member       |
| No      | Yes       | No      | Was already a member during this month      |
| No      | No        | Yes     | Last month as a member                      |
| No      | Yes       | Yes     | Last month as a member                      |
| Yes     | No        | Yes     | Started and Left Bang within the same month |
| Yes     | Yes       | No      | First month as a new/returning member       |
| Yes     | Yes       | Yes     | Started and left Bang within the same month |

From these options, the monthly status variable will classify each individual as being either (a) new/returning, (b) current member, (c) leaving or (d) started and left in the same month. 

```{r}

# membership_months 

bang = bang %>% 
  mutate(
    membership.01.18 = 
      ifelse(c(new_month_1 == 0 & current_month_1 == 0 & leave_month_1 == 0), "0",
             ifelse(c(new_month_1 == 0 & current_month_1 == 1 & leave_month_1 == 0), "1",
                    ifelse(c(new_month_1 == 1 & current_month_1 == 0 & leave_month_1 == 0), "1", 
                           ifelse(c(new_month_1 == 1 & current_month_1 == 1 & leave_month_1 == 0), '1', '2')))), 
    
    membership.02.18 = 
      ifelse(c(new_month_2 == 0 & current_month_2 == 0 & leave_month_2 == 0), "0",
             ifelse(c(new_month_2 == 0 & current_month_2 == 1 & leave_month_2 == 0), "1",
                    ifelse(c(new_month_2 == 1 & current_month_2 == 0 & leave_month_2 == 0), "1", 
                           ifelse(c(new_month_2 == 1 & current_month_2 == 1 & leave_month_2 == 0), '1', '2')))), 
    
    membership.03.18 = 
      ifelse(c(new_month_3 == 0 & current_month_3 == 0 & leave_month_3 == 0), "0",
             ifelse(c(new_month_3 == 0 & current_month_3 == 1 & leave_month_3 == 0), "1",
                    ifelse(c(new_month_3 == 1 & current_month_3 == 0 & leave_month_3 == 0), "1", 
                           ifelse(c(new_month_3 == 1 & current_month_3 == 1 & leave_month_3 == 0), '1', '2')))), 
    
    membership.04.18 = 
      ifelse(c(new_month_4 == 0 & current_month_4 == 0 & leave_month_4 == 0), "0",
             ifelse(c(new_month_4 == 0 & current_month_4 == 1 & leave_month_4 == 0), "1",
                    ifelse(c(new_month_4 == 1 & current_month_4 == 0 & leave_month_4 == 0), "1", 
                           ifelse(c(new_month_4 == 1 & current_month_4 == 1 & leave_month_4 == 0), '1', '2')))),
    
    membership.05.18 = 
      ifelse(c(new_month_5 == 0 & current_month_5 == 0 & leave_month_5 == 0), "0",
             ifelse(c(new_month_5 == 0 & current_month_5 == 1 & leave_month_5 == 0), "1",
                    ifelse(c(new_month_5 == 1 & current_month_5 == 0 & leave_month_5 == 0), "1", 
                           ifelse(c(new_month_5 == 1 & current_month_5 == 1 & leave_month_5 == 0), '1', '2')))), 
    
    membership.06.18 = 
      ifelse(c(new_month_6 == 0 & current_month_6 == 0 & leave_month_6 == 0), "0",
             ifelse(c(new_month_6 == 0 & current_month_6 == 1 & leave_month_6 == 0), "1",
                    ifelse(c(new_month_6 == 1 & current_month_6 == 0 & leave_month_6 == 0), "1", 
                           ifelse(c(new_month_6 == 1 & current_month_6 == 1 & leave_month_6 == 0), '1', '2')))), 
    
    membership.07.18 = 
      ifelse(c(new_month_7 == 0 & current_month_7 == 0 & leave_month_7 == 0), "0",
             ifelse(c(new_month_7 == 0 & current_month_7 == 1 & leave_month_7 == 0), "1",
                    ifelse(c(new_month_7 == 1 & current_month_7 == 0 & leave_month_7 == 0), "1", 
                           ifelse(c(new_month_7 == 1 & current_month_7 == 1 & leave_month_7 == 0), '1', '2')))), 
    
    membership.08.18 = 
      ifelse(c(new_month_8 == 0 & current_month_8 == 0 & leave_month_8 == 0), "0",
             ifelse(c(new_month_8 == 0 & current_month_8 == 1 & leave_month_8 == 0), "1",
                    ifelse(c(new_month_8 == 1 & current_month_8 == 0 & leave_month_8 == 0), "1", 
                           ifelse(c(new_month_8 == 1 & current_month_8 == 1 & leave_month_8 == 0), '1', '2')))),
    
    membership.09.18 = 
      ifelse(c(new_month_9 == 0 & current_month_9 == 0 & leave_month_9 == 0), "0",
             ifelse(c(new_month_9 == 0 & current_month_9 == 1 & leave_month_9 == 0), "1",
                    ifelse(c(new_month_9 == 1 & current_month_9 == 0 & leave_month_9 == 0), "1", 
                           ifelse(c(new_month_9 == 1 & current_month_9 == 1 & leave_month_9 == 0), '1', '2')))), 
    
    membership.10.18 = 
      ifelse(c(new_month_10 == 0 & current_month_10 == 0 & leave_month_10 == 0), "0",
             ifelse(c(new_month_10 == 0 & current_month_10 == 1 & leave_month_10 == 0), "1",
                    ifelse(c(new_month_10 == 1 & current_month_10 == 0 & leave_month_10 == 0), "1", 
                           ifelse(c(new_month_10 == 1 & current_month_10 == 1 & leave_month_10 == 0), '1', '2')))), 
    
    membership.11.18 = 
      ifelse(c(new_month_11 == 0 & current_month_11 == 0 & leave_month_11 == 0), "0",
             ifelse(c(new_month_11 == 0 & current_month_11 == 1 & leave_month_11 == 0), "1",
                    ifelse(c(new_month_11 == 1 & current_month_11 == 0 & leave_month_11 == 0), "1", 
                           ifelse(c(new_month_11 == 1 & current_month_11 == 1 & leave_month_11 == 0), '1', '2')))), 
    
    membership.12.18 = 
      ifelse(c(new_month_12 == 0 & current_month_12 == 0 & leave_month_12 == 0), "0",
             ifelse(c(new_month_12 == 0 & current_month_12 == 1 & leave_month_12 == 0), "1",
                    ifelse(c(new_month_12 == 1 & current_month_12 == 0 & leave_month_12 == 0), "1", 
                           ifelse(c(new_month_12 == 1 & current_month_12 == 1 & leave_month_12 == 0), '1', '2')))),
    
    membership.01.19 = 
      ifelse(c(new_month_13 == 0 & current_month_13 == 0 & leave_month_13 == 0), "0",
             ifelse(c(new_month_13 == 0 & current_month_13 == 1 & leave_month_13 == 0), "1",
                    ifelse(c(new_month_13 == 1 & current_month_13 == 0 & leave_month_13 == 0), "1", 
                           ifelse(c(new_month_13 == 1 & current_month_13 == 1 & leave_month_13 == 0), '1', '2')))), 
    
    membership.02.19 = 
      ifelse(c(new_month_14 == 0 & current_month_14 == 0 & leave_month_14 == 0), "0",
             ifelse(c(new_month_14 == 0 & current_month_14 == 1 & leave_month_14 == 0), "1",
                    ifelse(c(new_month_14 == 1 & current_month_14 == 0 & leave_month_14 == 0), "1", 
                           ifelse(c(new_month_14 == 1 & current_month_14 == 1 & leave_month_14 == 0), '1', '2')))), 
    
    membership.03.19 = 
      ifelse(c(new_month_15 == 0 & current_month_15 == 0 & leave_month_15 == 0), "0",
             ifelse(c(new_month_15 == 0 & current_month_15 == 1 & leave_month_15 == 0), "1",
                    ifelse(c(new_month_15 == 1 & current_month_15 == 0 & leave_month_15 == 0), "1", 
                           ifelse(c(new_month_15 == 1 & current_month_15 == 1 & leave_month_15 == 0), '1', '2')))), 
    
    membership.04.19 = 
      ifelse(c(new_month_16 == 0 & current_month_16 == 0 & leave_month_16 == 0), "0",
             ifelse(c(new_month_16 == 0 & current_month_16 == 1 & leave_month_16 == 0), "1",
                    ifelse(c(new_month_16 == 1 & current_month_16 == 0 & leave_month_16 == 0), "1", 
                           ifelse(c(new_month_16 == 1 & current_month_16 == 1 & leave_month_16 == 0), '1', '2')))), 
    
    membership.05.19 = 
      ifelse(c(new_month_17 == 0 & current_month_17 == 0 & leave_month_17 == 0), "0",
             ifelse(c(new_month_17 == 0 & current_month_17 == 1 & leave_month_17 == 0), "1",
                    ifelse(c(new_month_17 == 1 & current_month_17 == 0 & leave_month_17 == 0), "1", 
                           ifelse(c(new_month_17 == 1 & current_month_17 == 1 & leave_month_17 == 0), '1', '2')))), 
    
    membership.06.19 = 
      ifelse(c(new_month_18 == 0 & current_month_18 == 0 & leave_month_18 == 0), "0",
             ifelse(c(new_month_18 == 0 & current_month_18 == 1 & leave_month_18 == 0), "1",
                    ifelse(c(new_month_18 == 1 & current_month_18 == 0 & leave_month_18 == 0), "1", 
                           ifelse(c(new_month_18 == 1 & current_month_18 == 1 & leave_month_18 == 0), '1', '2')))),
    
    membership.07.19 = 
      ifelse(c(new_month_19 == 0 & current_month_19 == 0 & leave_month_19 == 0), "0",
             ifelse(c(new_month_19 == 0 & current_month_19 == 1 & leave_month_19 == 0), "1",
                    ifelse(c(new_month_19 == 1 & current_month_19 == 0 & leave_month_19 == 0), "1", 
                           ifelse(c(new_month_19 == 1 & current_month_19 == 1 & leave_month_19 == 0), '1', '2')))), 
    
    membership.08.19 = 
      ifelse(c(new_month_20 == 0 & current_month_20 == 0 & leave_month_20 == 0), "0",
             ifelse(c(new_month_20 == 0 & current_month_20 == 1 & leave_month_20 == 0), "1",
                    ifelse(c(new_month_20 == 1 & current_month_20 == 0 & leave_month_20 == 0), "1", 
                           ifelse(c(new_month_20 == 1 & current_month_20 == 1 & leave_month_20 == 0), '1', '2')))), 
    
    membership.09.19 = 
      ifelse(c(new_month_21 == 0 & current_month_21 == 0 & leave_month_21 == 0), "0",
             ifelse(c(new_month_21 == 0 & current_month_21 == 1 & leave_month_21 == 0), "1",
                    ifelse(c(new_month_21 == 1 & current_month_21 == 0 & leave_month_21 == 0), "1", 
                           ifelse(c(new_month_21 == 1 & current_month_21 == 1 & leave_month_21 == 0), '1', '2')))), 
    
    membership.10.19 = 
      ifelse(c(new_month_22 == 0 & current_month_22 == 0 & leave_month_22 == 0), "0",
             ifelse(c(new_month_22 == 0 & current_month_22 == 1 & leave_month_22 == 0), "1",
                    ifelse(c(new_month_22 == 1 & current_month_22 == 0 & leave_month_22 == 0), "1", 
                           ifelse(c(new_month_22 == 1 & current_month_22 == 1 & leave_month_22 == 0), '1', '2')))),
    
    membership.11.19 = 
      ifelse(c(new_month_23 == 0 & current_month_23 == 0 & leave_month_23 == 0), "0",
             ifelse(c(new_month_23 == 0 & current_month_23 == 1 & leave_month_23 == 0), "1",
                    ifelse(c(new_month_23 == 1 & current_month_23 == 0 & leave_month_23 == 0), "1", 
                           ifelse(c(new_month_23 == 1 & current_month_23 == 1 & leave_month_23 == 0), '1', '2')))), 
    
    membership.12.19 = 
      ifelse(c(new_month_24 == 0 & current_month_24 == 0 & leave_month_24 == 0), "0",
             ifelse(c(new_month_24 == 0 & current_month_24 == 1 & leave_month_24 == 0), "1",
                    ifelse(c(new_month_24 == 1 & current_month_24 == 0 & leave_month_24 == 0), "1", 
                           ifelse(c(new_month_24 == 1 & current_month_24 == 1 & leave_month_24 == 0), '1', '2')))), 
    
    membership.01.20 = 
      ifelse(c(new_month_25 == 0 & current_month_25 == 0 & leave_month_25 == 0), "0",
             ifelse(c(new_month_25 == 0 & current_month_25 == 1 & leave_month_25 == 0), "1",
                    ifelse(c(new_month_25 == 1 & current_month_25 == 0 & leave_month_25 == 0), "1", 
                           ifelse(c(new_month_25 == 1 & current_month_25 == 1 & leave_month_25 == 0), '1', '2')))), 
    
    membership.02.20 = 
      ifelse(c(new_month_26 == 0 & current_month_26 == 0 & leave_month_26 == 0), "0",
             ifelse(c(new_month_26 == 0 & current_month_26 == 1 & leave_month_26 == 0), "1",
                    ifelse(c(new_month_26 == 1 & current_month_26 == 0 & leave_month_26 == 0), "1", 
                           ifelse(c(new_month_26 == 1 & current_month_26 == 1 & leave_month_26 == 0), '1', '2')))),
    
    membership.03.20 = 
      ifelse(c(new_month_27 == 0 & current_month_27 == 0 & leave_month_27 == 0), "0",
             ifelse(c(new_month_27 == 0 & current_month_27 == 1 & leave_month_27 == 0), "1",
                    ifelse(c(new_month_27 == 1 & current_month_27 == 0 & leave_month_27 == 0), "1", 
                           ifelse(c(new_month_27 == 1 & current_month_27 == 1 & leave_month_27 == 0), '1', '2')))), 
    
    membership.04.20 = 
      ifelse(c(new_month_28 == 0 & current_month_28 == 0 & leave_month_28 == 0), "0",
             ifelse(c(new_month_28 == 0 & current_month_28 == 1 & leave_month_28 == 0), "1",
                    ifelse(c(new_month_28 == 1 & current_month_28 == 0 & leave_month_28 == 0), "1", 
                           ifelse(c(new_month_28 == 1 & current_month_28 == 1 & leave_month_28 == 0), '1', '2')))),
    
    membership.05.20 = 
      ifelse(c(new_month_29 == 0 & current_month_29 == 0 & leave_month_29 == 0), "0",
             ifelse(c(new_month_29 == 0 & current_month_29 == 1 & leave_month_29 == 0), "1",
                    ifelse(c(new_month_29 == 1 & current_month_29 == 0 & leave_month_29 == 0), "1", 
                           ifelse(c(new_month_29 == 1 & current_month_29 == 1 & leave_month_29 == 0), '1', '2')))), 
    
    membership.06.20 = 
      ifelse(c(new_month_30 == 0 & current_month_30 == 0 & leave_month_30 == 0), "0",
             ifelse(c(new_month_30 == 0 & current_month_30 == 1 & leave_month_30 == 0), "1",
                    ifelse(c(new_month_30 == 1 & current_month_30 == 0 & leave_month_30 == 0), "1", 
                           ifelse(c(new_month_30 == 1 & current_month_30 == 1 & leave_month_30 == 0), '1', '2')))), 
    
    membership.07.20 = 
      ifelse(c(new_month_31 == 0 & current_month_31 == 0 & leave_month_31 == 0), "0",
             ifelse(c(new_month_31 == 0 & current_month_31 == 1 & leave_month_31 == 0), "1",
                    ifelse(c(new_month_31 == 1 & current_month_31 == 0 & leave_month_31 == 0), "1", 
                           ifelse(c(new_month_31 == 1 & current_month_31 == 1 & leave_month_31 == 0), '1', '2')))),
    
    membership.08.20 = 
      ifelse(c(new_month_32 == 0 & current_month_32 == 0 & leave_month_32 == 0), "0",
             ifelse(c(new_month_32 == 0 & current_month_32 == 1 & leave_month_32 == 0), "1",
                    ifelse(c(new_month_32 == 1 & current_month_32 == 0 & leave_month_32 == 0), "1", 
                           ifelse(c(new_month_32 == 1 & current_month_32 == 1 & leave_month_32 == 0), '1', '2')))), 
    
    membership.09.20 = 
      ifelse(c(new_month_33 == 0 & current_month_33 == 0 & leave_month_33 == 0), "0",
             ifelse(c(new_month_33 == 0 & current_month_33 == 1 & leave_month_33 == 0), "1",
                    ifelse(c(new_month_33 == 1 & current_month_33 == 0 & leave_month_33 == 0), "1", 
                           ifelse(c(new_month_33 == 1 & current_month_33 == 1 & leave_month_33 == 0), '1', '2')))), 
    
    membership.10.20 = 
      ifelse(c(new_month_34 == 0 & current_month_34 == 0 & leave_month_34 == 0), "0",
             ifelse(c(new_month_34 == 0 & current_month_34 == 1 & leave_month_34 == 0), "1",
                    ifelse(c(new_month_34 == 1 & current_month_34 == 0 & leave_month_34 == 0), "1", 
                           ifelse(c(new_month_34 == 1 & current_month_34 == 1 & leave_month_34 == 0), '1', '2'))))
  )

bang = bang %>% 
  mutate(
    membership.01.18 = as.factor(membership.01.18),
    membership.03.18 = as.factor(membership.03.18),
    membership.04.18 = as.factor(membership.04.18),
    membership.05.18 = as.factor(membership.05.18),
    membership.06.18 = as.factor(membership.06.18),
    membership.07.18 = as.factor(membership.07.18),
    membership.08.18 = as.factor(membership.08.18),
    membership.09.18 = as.factor(membership.09.18),
    membership.02.18 = as.factor(membership.02.18),
    membership.10.18 = as.factor(membership.10.18),
    membership.11.18 = as.factor(membership.11.18),
    membership.12.18 = as.factor(membership.12.18),
    membership.01.19 = as.factor(membership.01.19),
    membership.03.19 = as.factor(membership.03.19),
    membership.04.19 = as.factor(membership.04.19),
    membership.05.19 = as.factor(membership.05.19),
    membership.06.19 = as.factor(membership.06.19),
    membership.07.19 = as.factor(membership.07.19),
    membership.08.19 = as.factor(membership.08.19),
    membership.09.19 = as.factor(membership.09.19),
    membership.02.19 = as.factor(membership.02.19),
    membership.10.19 = as.factor(membership.10.19),
    membership.11.19 = as.factor(membership.11.19),
    membership.12.19 = as.factor(membership.12.19),
    membership.01.20 = as.factor(membership.01.20),
    membership.03.20 = as.factor(membership.03.20),
    membership.04.20 = as.factor(membership.04.20),
    membership.05.20 = as.factor(membership.05.20),
    membership.06.20 = as.factor(membership.06.20),
    membership.07.20 = as.factor(membership.07.20),
    membership.08.20 = as.factor(membership.08.20),
    membership.09.20 = as.factor(membership.09.20),
    membership.02.20 = as.factor(membership.02.20),
    membership.10.20 = as.factor(membership.10.20)
  )

bang = bang %>% 
  mutate(
    membership.01.18 = revalue(membership.01.18, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.02.18 = revalue(membership.02.18, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.03.18 = revalue(membership.03.18, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.04.18 = revalue(membership.04.18, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.05.18 = revalue(membership.05.18, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.06.18 = revalue(membership.06.18, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.07.18 = revalue(membership.07.18, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.08.18 = revalue(membership.08.18, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.09.18 = revalue(membership.09.18, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.10.18 = revalue(membership.10.18, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.11.18 = revalue(membership.11.18, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.12.18 = revalue(membership.12.18, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.01.19 = revalue(membership.01.19, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.02.19 = revalue(membership.02.19, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.03.19 = revalue(membership.03.19, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.04.19 = revalue(membership.04.19, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.05.19 = revalue(membership.05.19, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.06.19 = revalue(membership.06.19, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.07.19 = revalue(membership.07.19, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.08.19 = revalue(membership.08.19, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.09.19 = revalue(membership.09.19, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.10.19 = revalue(membership.10.19, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.11.19 = revalue(membership.11.19, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.12.19 = revalue(membership.12.19, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.01.20 = revalue(membership.01.20, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.02.20 = revalue(membership.02.20, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.03.20 = revalue(membership.03.20, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.04.20 = revalue(membership.04.20, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.05.20 = revalue(membership.05.20, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.06.20 = revalue(membership.06.20, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.07.20 = revalue(membership.07.20, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.08.20 = revalue(membership.08.20, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.09.20 = revalue(membership.09.20, c('0' = "no", "1" = 'yes', '2' = 'was but left')),
    membership.10.20 = revalue(membership.10.20, c('0' = "no", "1" = 'yes', '2' = 'was but left'))
  )


bang <- bang %>% 
  mutate(
    status.01.18 =  ifelse(c(new_month_1 == 0 & current_month_1 == 0 & leave_month_1 == 0), 0,
                    ifelse(c(new_month_1 == 1 & current_month_1 == 0 & leave_month_1 == 0), 1, 
                    ifelse(c(new_month_1 == 0 & current_month_1 == 1 & leave_month_1 == 0), 2, 
                    ifelse(c(new_month_1 == 0 & current_month_1 == 0 & leave_month_1 == 1), 4,
                    ifelse(c(new_month_1 == 1 & current_month_1 == 1 & leave_month_1 == 0), 1,
                    ifelse(c(new_month_1 == 1 & current_month_1 == 0 & leave_month_1 == 1), 3,
                    ifelse(c(new_month_1 == 0 & current_month_1 == 1 & leave_month_1 == 1), 4, 3))))))), 
    
    status.02.18 =  ifelse(c(new_month_2 == 0 & current_month_2 == 0 & leave_month_2 == 0), 0,
                    ifelse(c(new_month_2 == 1 & current_month_2 == 0 & leave_month_2 == 0), 1, 
                    ifelse(c(new_month_2 == 0 & current_month_2 == 1 & leave_month_2 == 0), 2, 
                    ifelse(c(new_month_2 == 0 & current_month_2 == 0 & leave_month_2 == 1), 4,
                    ifelse(c(new_month_2 == 1 & current_month_2 == 1 & leave_month_2 == 0), 1,
                    ifelse(c(new_month_2 == 1 & current_month_2 == 0 & leave_month_2 == 1), 3,
                    ifelse(c(new_month_2 == 0 & current_month_2 == 1 & leave_month_2 == 1), 4, 3))))))),
    
    status.03.18 =  ifelse(c(new_month_3 == 0 & current_month_3 == 0 & leave_month_3 == 0), 0,
                    ifelse(c(new_month_3 == 1 & current_month_3 == 0 & leave_month_3 == 0), 1, 
                    ifelse(c(new_month_3 == 0 & current_month_3 == 1 & leave_month_3 == 0), 2, 
                    ifelse(c(new_month_3 == 0 & current_month_3 == 0 & leave_month_3 == 1), 4,
                    ifelse(c(new_month_3 == 1 & current_month_3 == 1 & leave_month_3 == 0), 1,
                    ifelse(c(new_month_3 == 1 & current_month_3 == 0 & leave_month_3 == 1), 3,
                    ifelse(c(new_month_3 == 0 & current_month_3 == 1 & leave_month_3 == 1), 4, 3))))))),
    
    status.04.18 =  ifelse(c(new_month_4 == 0 & current_month_4 == 0 & leave_month_4 == 0), 0,
                    ifelse(c(new_month_4 == 1 & current_month_4 == 0 & leave_month_4 == 0), 1, 
                    ifelse(c(new_month_4 == 0 & current_month_4 == 1 & leave_month_4 == 0), 2, 
                    ifelse(c(new_month_4 == 0 & current_month_4 == 0 & leave_month_4 == 1), 4,
                    ifelse(c(new_month_4 == 1 & current_month_4 == 1 & leave_month_4 == 0), 1,
                    ifelse(c(new_month_4 == 1 & current_month_4 == 0 & leave_month_4 == 1), 3,
                    ifelse(c(new_month_4 == 0 & current_month_4 == 1 & leave_month_4 == 1), 4, 3))))))),
    
    status.05.18 =  ifelse(c(new_month_5 == 0 & current_month_5 == 0 & leave_month_5 == 0), 0,
                    ifelse(c(new_month_5 == 1 & current_month_5 == 0 & leave_month_5 == 0), 1, 
                    ifelse(c(new_month_5 == 0 & current_month_5 == 1 & leave_month_5 == 0), 2, 
                    ifelse(c(new_month_5 == 0 & current_month_5 == 0 & leave_month_5 == 1), 4,
                    ifelse(c(new_month_5 == 1 & current_month_5 == 1 & leave_month_5 == 0), 1,
                    ifelse(c(new_month_5 == 1 & current_month_5 == 0 & leave_month_5 == 1), 3,
                    ifelse(c(new_month_5 == 0 & current_month_5 == 1 & leave_month_5 == 1), 4, 3))))))),
    
    status.06.18 =  ifelse(c(new_month_6 == 0 & current_month_6 == 0 & leave_month_6 == 0), 0,
                    ifelse(c(new_month_6 == 1 & current_month_6 == 0 & leave_month_6 == 0), 1, 
                    ifelse(c(new_month_6 == 0 & current_month_6 == 1 & leave_month_6 == 0), 2, 
                    ifelse(c(new_month_6 == 0 & current_month_6 == 0 & leave_month_6 == 1), 4,
                    ifelse(c(new_month_6 == 1 & current_month_6 == 1 & leave_month_6 == 0), 1,
                    ifelse(c(new_month_6 == 1 & current_month_6 == 0 & leave_month_6 == 1), 3,
                    ifelse(c(new_month_6 == 0 & current_month_6 == 1 & leave_month_6 == 1), 4, 3))))))),
    
    status.07.18 =  ifelse(c(new_month_7 == 0 & current_month_7 == 0 & leave_month_7 == 0), 0,
                    ifelse(c(new_month_7 == 1 & current_month_7 == 0 & leave_month_7 == 0), 1, 
                    ifelse(c(new_month_7 == 0 & current_month_7 == 1 & leave_month_7 == 0), 2, 
                    ifelse(c(new_month_7 == 0 & current_month_7 == 0 & leave_month_7 == 1), 4,
                    ifelse(c(new_month_7 == 1 & current_month_7 == 1 & leave_month_7 == 0), 1,
                    ifelse(c(new_month_7 == 1 & current_month_7 == 0 & leave_month_7 == 1), 3,
                    ifelse(c(new_month_7 == 0 & current_month_7 == 1 & leave_month_7 == 1), 4, 3))))))),
    
    status.08.18 =  ifelse(c(new_month_8 == 0 & current_month_8 == 0 & leave_month_8 == 0), 0,
                    ifelse(c(new_month_8 == 1 & current_month_8 == 0 & leave_month_8 == 0), 1, 
                    ifelse(c(new_month_8 == 0 & current_month_8 == 1 & leave_month_8 == 0), 2, 
                    ifelse(c(new_month_8 == 0 & current_month_8 == 0 & leave_month_8 == 1), 4,
                    ifelse(c(new_month_8 == 1 & current_month_8 == 1 & leave_month_8 == 0), 1,
                    ifelse(c(new_month_8 == 1 & current_month_8 == 0 & leave_month_8 == 1), 3,
                    ifelse(c(new_month_8 == 0 & current_month_8 == 1 & leave_month_8 == 1), 4, 3))))))),
    
    status.09.18 =  ifelse(c(new_month_9 == 0 & current_month_9 == 0 & leave_month_9 == 0), 0,
                    ifelse(c(new_month_9 == 1 & current_month_9 == 0 & leave_month_9 == 0), 1, 
                    ifelse(c(new_month_9 == 0 & current_month_9 == 1 & leave_month_9 == 0), 2, 
                    ifelse(c(new_month_9 == 0 & current_month_9 == 0 & leave_month_9 == 1), 4,
                    ifelse(c(new_month_9 == 1 & current_month_9 == 1 & leave_month_9 == 0), 1,
                    ifelse(c(new_month_9 == 1 & current_month_9 == 0 & leave_month_9 == 1), 3,
                    ifelse(c(new_month_9 == 0 & current_month_9 == 1 & leave_month_9 == 1), 4, 3))))))),
    
    status.10.18 =  ifelse(c(new_month_10 == 0 & current_month_10 == 0 & leave_month_10 == 0), 0,
                    ifelse(c(new_month_10 == 1 & current_month_10 == 0 & leave_month_10 == 0), 1, 
                    ifelse(c(new_month_10 == 0 & current_month_10 == 1 & leave_month_10 == 0), 2, 
                    ifelse(c(new_month_10 == 0 & current_month_10 == 0 & leave_month_10 == 1), 4,
                    ifelse(c(new_month_10 == 1 & current_month_10 == 1 & leave_month_10 == 0), 1,
                    ifelse(c(new_month_10 == 1 & current_month_10 == 0 & leave_month_10 == 1), 3,
                    ifelse(c(new_month_10 == 0 & current_month_10 == 1 & leave_month_10 == 1), 4, 3))))))),
    
    status.11.18 =  ifelse(c(new_month_11 == 0 & current_month_11 == 0 & leave_month_11 == 0), 0,
                    ifelse(c(new_month_11 == 1 & current_month_11 == 0 & leave_month_11 == 0), 1, 
                    ifelse(c(new_month_11 == 0 & current_month_11 == 1 & leave_month_11 == 0), 2, 
                    ifelse(c(new_month_11 == 0 & current_month_11 == 0 & leave_month_11 == 1), 4,
                    ifelse(c(new_month_11 == 1 & current_month_11 == 1 & leave_month_11 == 0), 1,
                    ifelse(c(new_month_11 == 1 & current_month_11 == 0 & leave_month_11 == 1), 3,
                    ifelse(c(new_month_11 == 0 & current_month_11 == 1 & leave_month_11 == 1), 4, 3))))))),
    
    status.12.18 =  ifelse(c(new_month_12 == 0 & current_month_12 == 0 & leave_month_12 == 0), 0,
                    ifelse(c(new_month_12 == 1 & current_month_12 == 0 & leave_month_12 == 0), 1, 
                    ifelse(c(new_month_12 == 0 & current_month_12 == 1 & leave_month_12 == 0), 2, 
                    ifelse(c(new_month_12 == 0 & current_month_12 == 0 & leave_month_12 == 1), 4,
                    ifelse(c(new_month_12 == 1 & current_month_12 == 1 & leave_month_12 == 0), 1,
                    ifelse(c(new_month_12 == 1 & current_month_12 == 0 & leave_month_12 == 1), 3,
                    ifelse(c(new_month_12 == 0 & current_month_12 == 1 & leave_month_12 == 1), 4, 3))))))),
    
    
    
    status.01.19 =  ifelse(c(new_month_13 == 0 & current_month_13 == 0 & leave_month_13 == 0), 0,
                    ifelse(c(new_month_13 == 1 & current_month_13 == 0 & leave_month_13 == 0), 1, 
                    ifelse(c(new_month_13 == 0 & current_month_13 == 1 & leave_month_13 == 0), 2, 
                    ifelse(c(new_month_13 == 0 & current_month_13 == 0 & leave_month_13 == 1), 4,
                    ifelse(c(new_month_13 == 1 & current_month_13 == 1 & leave_month_13 == 0), 1,
                    ifelse(c(new_month_13 == 1 & current_month_13 == 0 & leave_month_13 == 1), 3,
                    ifelse(c(new_month_13 == 0 & current_month_13 == 1 & leave_month_13 == 1), 4, 3))))))),
    
    status.02.19 =  ifelse(c(new_month_14 == 0 & current_month_14 == 0 & leave_month_14 == 0), 0,
                    ifelse(c(new_month_14 == 1 & current_month_14 == 0 & leave_month_14 == 0), 1, 
                    ifelse(c(new_month_14 == 0 & current_month_14 == 1 & leave_month_14 == 0), 2, 
                    ifelse(c(new_month_14 == 0 & current_month_14 == 0 & leave_month_14 == 1), 4,
                    ifelse(c(new_month_14 == 1 & current_month_14 == 1 & leave_month_14 == 0), 1,
                    ifelse(c(new_month_14 == 1 & current_month_14 == 0 & leave_month_14 == 1), 3,
                    ifelse(c(new_month_14 == 0 & current_month_14 == 1 & leave_month_14 == 1), 4, 3))))))),
    
    status.03.19 =  ifelse(c(new_month_15 == 0 & current_month_15 == 0 & leave_month_15 == 0), 0,
                    ifelse(c(new_month_15 == 1 & current_month_15 == 0 & leave_month_15 == 0), 1, 
                    ifelse(c(new_month_15 == 0 & current_month_15 == 1 & leave_month_15 == 0), 2, 
                    ifelse(c(new_month_15 == 0 & current_month_15 == 0 & leave_month_15 == 1), 4,
                    ifelse(c(new_month_15 == 1 & current_month_15 == 1 & leave_month_15 == 0), 1,
                    ifelse(c(new_month_15 == 1 & current_month_15 == 0 & leave_month_15 == 1), 3,
                    ifelse(c(new_month_15 == 0 & current_month_15 == 1 & leave_month_15 == 1), 4, 3))))))),
    
    status.04.19 =  ifelse(c(new_month_16 == 0 & current_month_16 == 0 & leave_month_16 == 0), 0,
                    ifelse(c(new_month_16 == 1 & current_month_16 == 0 & leave_month_16 == 0), 1, 
                    ifelse(c(new_month_16 == 0 & current_month_16 == 1 & leave_month_16 == 0), 2, 
                    ifelse(c(new_month_16 == 0 & current_month_16 == 0 & leave_month_16 == 1), 4,
                    ifelse(c(new_month_16 == 1 & current_month_16 == 1 & leave_month_16 == 0), 1,
                    ifelse(c(new_month_16 == 1 & current_month_16 == 0 & leave_month_16 == 1), 3,
                    ifelse(c(new_month_16 == 0 & current_month_16 == 1 & leave_month_16 == 1), 4, 3))))))),
    
    status.05.19 =  ifelse(c(new_month_17 == 0 & current_month_17 == 0 & leave_month_17 == 0), 0,
                    ifelse(c(new_month_17 == 1 & current_month_17 == 0 & leave_month_17 == 0), 1, 
                    ifelse(c(new_month_17 == 0 & current_month_17 == 1 & leave_month_17 == 0), 2, 
                    ifelse(c(new_month_17 == 0 & current_month_17 == 0 & leave_month_17 == 1), 4,
                    ifelse(c(new_month_17 == 1 & current_month_17 == 1 & leave_month_17 == 0), 1,
                    ifelse(c(new_month_17 == 1 & current_month_17 == 0 & leave_month_17 == 1), 3,
                    ifelse(c(new_month_17 == 0 & current_month_17 == 1 & leave_month_17 == 1), 4, 3))))))),
    
    status.06.19 =  ifelse(c(new_month_18 == 0 & current_month_18 == 0 & leave_month_18 == 0), 0,
                    ifelse(c(new_month_18 == 1 & current_month_18 == 0 & leave_month_18 == 0), 1, 
                    ifelse(c(new_month_18 == 0 & current_month_18 == 1 & leave_month_18 == 0), 2, 
                    ifelse(c(new_month_18 == 0 & current_month_18 == 0 & leave_month_18 == 1), 4,
                    ifelse(c(new_month_18 == 1 & current_month_18 == 1 & leave_month_18 == 0), 1,
                    ifelse(c(new_month_18 == 1 & current_month_18 == 0 & leave_month_18 == 1), 3,
                    ifelse(c(new_month_18 == 0 & current_month_18 == 1 & leave_month_18 == 1), 4, 3))))))),
    
    status.07.19 =  ifelse(c(new_month_19 == 0 & current_month_19 == 0 & leave_month_19 == 0), 0,
                    ifelse(c(new_month_19 == 1 & current_month_19 == 0 & leave_month_19 == 0), 1, 
                    ifelse(c(new_month_19 == 0 & current_month_19 == 1 & leave_month_19 == 0), 2, 
                    ifelse(c(new_month_19 == 0 & current_month_19 == 0 & leave_month_19 == 1), 4,
                    ifelse(c(new_month_19 == 1 & current_month_19 == 1 & leave_month_19 == 0), 1,
                    ifelse(c(new_month_19 == 1 & current_month_19 == 0 & leave_month_19 == 1), 3,
                    ifelse(c(new_month_19 == 0 & current_month_19 == 1 & leave_month_19 == 1), 4, 3))))))),
    
    status.08.19 =  ifelse(c(new_month_20 == 0 & current_month_20 == 0 & leave_month_20 == 0), 0,
                    ifelse(c(new_month_20 == 1 & current_month_20 == 0 & leave_month_20 == 0), 1, 
                    ifelse(c(new_month_20 == 0 & current_month_20 == 1 & leave_month_20 == 0), 2, 
                    ifelse(c(new_month_20 == 0 & current_month_20 == 0 & leave_month_20 == 1), 4,
                    ifelse(c(new_month_20 == 1 & current_month_20 == 1 & leave_month_20 == 0), 1,
                    ifelse(c(new_month_20 == 1 & current_month_20 == 0 & leave_month_20 == 1), 3,
                    ifelse(c(new_month_20 == 0 & current_month_20 == 1 & leave_month_20 == 1), 4, 3))))))),
    
    status.09.19 =  ifelse(c(new_month_21 == 0 & current_month_21 == 0 & leave_month_21 == 0), 0,
                    ifelse(c(new_month_21 == 1 & current_month_21 == 0 & leave_month_21 == 0), 1, 
                    ifelse(c(new_month_21 == 0 & current_month_21 == 1 & leave_month_21 == 0), 2, 
                    ifelse(c(new_month_21 == 0 & current_month_21 == 0 & leave_month_21 == 1), 4,
                    ifelse(c(new_month_21 == 1 & current_month_21 == 1 & leave_month_21 == 0), 1,
                    ifelse(c(new_month_21 == 1 & current_month_21 == 0 & leave_month_21 == 1), 3,
                    ifelse(c(new_month_21 == 0 & current_month_21 == 1 & leave_month_21 == 1), 4, 3))))))),
    
    status.10.19 =  ifelse(c(new_month_22 == 0 & current_month_22 == 0 & leave_month_22 == 0), 0,
                    ifelse(c(new_month_22 == 1 & current_month_22 == 0 & leave_month_22 == 0), 1, 
                    ifelse(c(new_month_22 == 0 & current_month_22 == 1 & leave_month_22 == 0), 2, 
                    ifelse(c(new_month_22 == 0 & current_month_22 == 0 & leave_month_22 == 1), 4,
                    ifelse(c(new_month_22 == 1 & current_month_22 == 1 & leave_month_22 == 0), 1,
                    ifelse(c(new_month_22 == 1 & current_month_22 == 0 & leave_month_22 == 1), 3,
                    ifelse(c(new_month_22 == 0 & current_month_22 == 1 & leave_month_22 == 1), 4, 3))))))),
    
    status.11.19 =  ifelse(c(new_month_23 == 0 & current_month_23 == 0 & leave_month_23 == 0), 0,
                    ifelse(c(new_month_23 == 1 & current_month_23 == 0 & leave_month_23 == 0), 1, 
                    ifelse(c(new_month_23 == 0 & current_month_23 == 1 & leave_month_23 == 0), 2, 
                    ifelse(c(new_month_23 == 0 & current_month_23 == 0 & leave_month_23 == 1), 4,
                    ifelse(c(new_month_23 == 1 & current_month_23 == 1 & leave_month_23 == 0), 1,
                    ifelse(c(new_month_23 == 1 & current_month_23 == 0 & leave_month_23 == 1), 3,
                    ifelse(c(new_month_23 == 0 & current_month_23 == 1 & leave_month_23 == 1), 4, 3))))))),
    
    status.12.19 =  ifelse(c(new_month_24 == 0 & current_month_24 == 0 & leave_month_24 == 0), 0,
                    ifelse(c(new_month_24 == 1 & current_month_24 == 0 & leave_month_24 == 0), 1, 
                    ifelse(c(new_month_24 == 0 & current_month_24 == 1 & leave_month_24 == 0), 2, 
                    ifelse(c(new_month_24 == 0 & current_month_24 == 0 & leave_month_24 == 1), 4,
                    ifelse(c(new_month_24 == 1 & current_month_24 == 1 & leave_month_24 == 0), 1,
                    ifelse(c(new_month_24 == 1 & current_month_24 == 0 & leave_month_24 == 1), 3,
                    ifelse(c(new_month_24 == 0 & current_month_24 == 1 & leave_month_24 == 1), 4, 3))))))),
    
    
    status.01.20 =  ifelse(c(new_month_25 == 0 & current_month_25 == 0 & leave_month_25 == 0), 0,
                    ifelse(c(new_month_25 == 1 & current_month_25 == 0 & leave_month_25 == 0), 1, 
                    ifelse(c(new_month_25 == 0 & current_month_25 == 1 & leave_month_25 == 0), 2, 
                    ifelse(c(new_month_25 == 0 & current_month_25 == 0 & leave_month_25 == 1), 4,
                    ifelse(c(new_month_25 == 1 & current_month_25 == 1 & leave_month_25 == 0), 1,
                    ifelse(c(new_month_25 == 1 & current_month_25 == 0 & leave_month_25 == 1), 3,
                    ifelse(c(new_month_25 == 0 & current_month_25 == 1 & leave_month_25 == 1), 4, 3))))))),
    
    status.02.20 =  ifelse(c(new_month_26 == 0 & current_month_26 == 0 & leave_month_26 == 0), 0,
                    ifelse(c(new_month_26 == 1 & current_month_26 == 0 & leave_month_26 == 0), 1, 
                    ifelse(c(new_month_26 == 0 & current_month_26 == 1 & leave_month_26 == 0), 2, 
                    ifelse(c(new_month_26 == 0 & current_month_26 == 0 & leave_month_26 == 1), 4,
                    ifelse(c(new_month_26 == 1 & current_month_26 == 1 & leave_month_26 == 0), 1,
                    ifelse(c(new_month_26 == 1 & current_month_26 == 0 & leave_month_26 == 1), 3,
                    ifelse(c(new_month_26 == 0 & current_month_26 == 1 & leave_month_26 == 1), 4, 3))))))),
    
    status.03.20 =  ifelse(c(new_month_27 == 0 & current_month_27 == 0 & leave_month_27 == 0), 0,
                    ifelse(c(new_month_27 == 1 & current_month_27 == 0 & leave_month_27 == 0), 1, 
                    ifelse(c(new_month_27 == 0 & current_month_27 == 1 & leave_month_27 == 0), 2, 
                    ifelse(c(new_month_27 == 0 & current_month_27 == 0 & leave_month_27 == 1), 4,
                    ifelse(c(new_month_27 == 1 & current_month_27 == 1 & leave_month_27 == 0), 1,
                    ifelse(c(new_month_27 == 1 & current_month_27 == 0 & leave_month_27 == 1), 3,
                    ifelse(c(new_month_27 == 0 & current_month_27 == 1 & leave_month_27 == 1), 4, 3))))))),
    
    status.04.20 =  ifelse(c(new_month_28 == 0 & current_month_28 == 0 & leave_month_28 == 0), 0,
                    ifelse(c(new_month_28 == 1 & current_month_28 == 0 & leave_month_28 == 0), 1, 
                    ifelse(c(new_month_28 == 0 & current_month_28 == 1 & leave_month_28 == 0), 2, 
                    ifelse(c(new_month_28 == 0 & current_month_28 == 0 & leave_month_28 == 1), 4,
                    ifelse(c(new_month_28 == 1 & current_month_28 == 1 & leave_month_28 == 0), 1,
                    ifelse(c(new_month_28 == 1 & current_month_28 == 0 & leave_month_28 == 1), 3,
                    ifelse(c(new_month_28 == 0 & current_month_28 == 1 & leave_month_28 == 1), 4, 3))))))),
    
    status.05.20 =  ifelse(c(new_month_29 == 0 & current_month_29 == 0 & leave_month_29 == 0), 0,
                    ifelse(c(new_month_29 == 1 & current_month_29 == 0 & leave_month_29 == 0), 1, 
                    ifelse(c(new_month_29 == 0 & current_month_29 == 1 & leave_month_29 == 0), 2, 
                    ifelse(c(new_month_29 == 0 & current_month_29 == 0 & leave_month_29 == 1), 4,
                    ifelse(c(new_month_29 == 1 & current_month_29 == 1 & leave_month_29 == 0), 1,
                    ifelse(c(new_month_29 == 1 & current_month_29 == 0 & leave_month_29 == 1), 3,
                    ifelse(c(new_month_29 == 0 & current_month_29 == 1 & leave_month_29 == 1), 4, 3))))))),
    
    status.06.20 =  ifelse(c(new_month_30 == 0 & current_month_30 == 0 & leave_month_30 == 0), 0,
                    ifelse(c(new_month_30 == 1 & current_month_30 == 0 & leave_month_30 == 0), 1, 
                    ifelse(c(new_month_30 == 0 & current_month_30 == 1 & leave_month_30 == 0), 2, 
                    ifelse(c(new_month_30 == 0 & current_month_30 == 0 & leave_month_30 == 1), 4,
                    ifelse(c(new_month_30 == 1 & current_month_30 == 1 & leave_month_30 == 0), 1,
                    ifelse(c(new_month_30 == 1 & current_month_30 == 0 & leave_month_30 == 1), 3,
                    ifelse(c(new_month_30 == 0 & current_month_30 == 1 & leave_month_30 == 1), 4, 3))))))),
    
    status.07.20 =  ifelse(c(new_month_31 == 0 & current_month_31 == 0 & leave_month_31 == 0), 0,
                    ifelse(c(new_month_31 == 1 & current_month_31 == 0 & leave_month_31 == 0), 1, 
                    ifelse(c(new_month_31 == 0 & current_month_31 == 1 & leave_month_31 == 0), 2, 
                    ifelse(c(new_month_31 == 0 & current_month_31 == 0 & leave_month_31 == 1), 4,
                    ifelse(c(new_month_31 == 1 & current_month_31 == 1 & leave_month_31 == 0), 1,
                    ifelse(c(new_month_31 == 1 & current_month_31 == 0 & leave_month_31 == 1), 3,
                    ifelse(c(new_month_31 == 0 & current_month_31 == 1 & leave_month_31 == 1), 4, 3))))))),
    
    status.08.20 =  ifelse(c(new_month_32 == 0 & current_month_32 == 0 & leave_month_32 == 0), 0,
                    ifelse(c(new_month_32 == 1 & current_month_32 == 0 & leave_month_32 == 0), 1, 
                    ifelse(c(new_month_32 == 0 & current_month_32 == 1 & leave_month_32 == 0), 2, 
                    ifelse(c(new_month_32 == 0 & current_month_32 == 0 & leave_month_32 == 1), 4,
                    ifelse(c(new_month_32 == 1 & current_month_32 == 1 & leave_month_32 == 0), 1,
                    ifelse(c(new_month_32 == 1 & current_month_32 == 0 & leave_month_32 == 1), 3,
                    ifelse(c(new_month_32 == 0 & current_month_32 == 1 & leave_month_32 == 1), 4, 3))))))),
    
    status.09.20 =  ifelse(c(new_month_33 == 0 & current_month_33 == 0 & leave_month_33 == 0), 0,
                    ifelse(c(new_month_33 == 1 & current_month_33 == 0 & leave_month_33 == 0), 1, 
                    ifelse(c(new_month_33 == 0 & current_month_33 == 1 & leave_month_33 == 0), 2, 
                    ifelse(c(new_month_33 == 0 & current_month_33 == 0 & leave_month_33 == 1), 4,
                    ifelse(c(new_month_33 == 1 & current_month_33 == 1 & leave_month_33 == 0), 1,
                    ifelse(c(new_month_33 == 1 & current_month_33 == 0 & leave_month_33 == 1), 3,
                    ifelse(c(new_month_33 == 0 & current_month_33 == 1 & leave_month_33 == 1), 4, 3))))))),
    
    status.10.20 =  ifelse(c(new_month_34 == 0 & current_month_34 == 0 & leave_month_34 == 0), 0,
                    ifelse(c(new_month_34 == 1 & current_month_34 == 0 & leave_month_34 == 0), 1, 
                    ifelse(c(new_month_34 == 0 & current_month_34 == 1 & leave_month_34 == 0), 2, 
                    ifelse(c(new_month_34 == 0 & current_month_34 == 0 & leave_month_34 == 1), 4,
                    ifelse(c(new_month_34 == 1 & current_month_34 == 1 & leave_month_34 == 0), 1,
                    ifelse(c(new_month_34 == 1 & current_month_34 == 0 & leave_month_34 == 1), 3,
                    ifelse(c(new_month_34 == 0 & current_month_34 == 1 & leave_month_34 == 1), 4, 3)))))))
  )

bang = bang %>% 
  mutate(
    status.01.18 = as.factor(status.01.18),
    status.02.18 = as.factor(status.02.18),
    status.03.18 = as.factor(status.03.18),
    status.04.18 = as.factor(status.04.18),
    status.05.18 = as.factor(status.05.18),
    status.06.18 = as.factor(status.06.18),
    status.07.18 = as.factor(status.07.18),
    status.08.18 = as.factor(status.08.18),
    status.09.18 = as.factor(status.09.18),
    status.10.18 = as.factor(status.10.18),
    status.11.18 = as.factor(status.11.18),
    status.12.18 = as.factor(status.12.18),
    status.01.19 = as.factor(status.01.19),
    status.02.19 = as.factor(status.02.19),
    status.03.19 = as.factor(status.03.19),
    status.04.19 = as.factor(status.04.19),
    status.05.19 = as.factor(status.05.19),
    status.06.19 = as.factor(status.06.19),
    status.07.19 = as.factor(status.07.19),
    status.08.19 = as.factor(status.08.19),
    status.09.19 = as.factor(status.09.19),
    status.10.19 = as.factor(status.10.19),
    status.11.19 = as.factor(status.11.19),
    status.12.19 = as.factor(status.12.19),
    status.01.20 = as.factor(status.01.20),
    status.02.20 = as.factor(status.02.20),
    status.03.20 = as.factor(status.03.20),
    status.04.20 = as.factor(status.04.20),
    status.05.20 = as.factor(status.05.20),
    status.06.20 = as.factor(status.06.20),
    status.07.20 = as.factor(status.07.20),
    status.08.20 = as.factor(status.08.20),
    status.09.20 = as.factor(status.09.20),
    status.10.20 = as.factor(status.10.20)
  )


bang = bang %>% 
  mutate(
    status.01.18 = revalue(status.01.18, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.02.18 = revalue(status.02.18, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.03.18 = revalue(status.03.18, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.04.18 = revalue(status.04.18, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.05.18 = revalue(status.05.18, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.06.18 = revalue(status.06.18, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.07.18 = revalue(status.07.18, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.08.18 = revalue(status.08.18, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.09.18 = revalue(status.09.18, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.10.18 = revalue(status.10.18, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.11.18 = revalue(status.11.18, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.12.18 = revalue(status.12.18, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.01.19 = revalue(status.01.19, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.02.19 = revalue(status.02.19, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.03.19 = revalue(status.03.19, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.04.19 = revalue(status.04.19, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.05.19 = revalue(status.05.19, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.06.19 = revalue(status.06.19, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.07.19 = revalue(status.07.19, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.08.19 = revalue(status.08.19, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.09.19 = revalue(status.09.19, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.10.19 = revalue(status.10.19, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.11.19 = revalue(status.11.19, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.12.19 = revalue(status.12.19, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.01.20 = revalue(status.01.20, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.02.20 = revalue(status.02.20, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.03.20 = revalue(status.03.20, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.04.20 = revalue(status.04.20, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.05.20 = revalue(status.05.20, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.06.20 = revalue(status.06.20, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.07.20 = revalue(status.07.20, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.08.20 = revalue(status.08.20, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.09.20 = revalue(status.09.20, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving')),
    status.10.20 = revalue(status.10.20, c('0' = 'no', '1' = 'new/returning', '2' = 'current', '3' = 'start and left', '4' = 'leaving'))
  )

```

### MEMBERSHIP RENEWAL

	In determining the number of renewals, it was operated on the idea that it takes a minimum of 66 days to adopt a health behavior change, based on a study by [Lally et al. 2010](https://psycnet.apa.org/record/2010-22273-010).  Despite our memberships are month-to-month, which would make sense to account as every month of continuation = 1 renewal, I have set it up so that renewals were all based on 2-month intervals throughout instead.  Now the troublesome part comes with those that undergone less than 66 days (i.e. only stayed for one month).  For those members, the renewals will now be set as 0.  So, going through fixing this variable, I made the cut-off that those that engaged in less than 66 days will be listed as 0. 

```{r}

bang = bang %>% 
	mutate(
	   former_renewal = ifelse(c(length < 66 & !is.na(num_former_reups)), 0, num_former_reups), 
	   active_renewal = ifelse(c(length < 66 & !is.na(num_active_reups)), 0, num_active_reups)
	)

bang = bang %>% 
	mutate(
	   num_renewals = ifelse(current == 'active', active_renewal, 
			  ifelse(current == 'former', former_renewal, NA))
	) %>% 
  mutate(
    num_renewals = as.numeric(num_renewals)
  )
```


### NUMBER OF PAYMENT BREAKS

  As it was inevitable that there were cases where some members will have a break in their payment cycle due to various reasons.  So we want to also take note of the number of times that this has happened. This will be recorded as a numeric. 

```{r}

bang = bang %>% 
	mutate(
	   num_breaks = ifelse(c(current == "active" & !is.na(num_active_breaks)), num_active_breaks,
			ifelse(c(current == 'former' & !is.na(num_former_breaks)), num_former_breaks, NA)) 
	) %>% 
  mutate(
    num_breaks = as.numeric(num_breaks)
  )

```

### MISSINGNESS 

  In making the data set, there were cases where I was not able to attain information on certain demographic variables (on a side note: this was pretty creepy and also scary to think that anyone can find stuff on you).  So will create a variable to identify those with or without these pieces of information.  This will be used in determining how we will be able to handle missing variables for our analysis. 
  
```{r}

# Missingness Variable

bang = bang %>% 
	mutate(
	  missing_value =  ifelse(c(age_group == 'na' | employment_sector == 'na'), 'missing', 'not')
	)

bang = bang %>% mutate(
	missing_value = as.factor(missing_value)
	)

```
  
### START DATE & END DATE

  I will be converting the information on start + end date of membership for each member.  However, it should be noted that for the purpose of this analysis, those that are current members will have their end date listed as Oct 5th, 2020. 
  
```{r}

bang$start_date = ymd(bang$start_date)
bang$end_date = ymd(bang$end_date)

```

### NUMBER OF SESSIONS

  In order to calculate the attendance of the member, I've collected information pertaining to their attendance history such as number of attended sessions, number of cancelled classes (as confirmed on the scheduling software Wellness Living), number of lost session (based upon the projected theoretical total of sessions that could've been attended) and number of unconfirmed attendance. These variables should be reflected as numeric variables.  

```{r}

bang = bang %>% 
  mutate(
    total_sessions = as.numeric(total_sessions),
    attended = as.numeric(attended),
    cancelled = as.numeric(cancelled),
    lost = as.numeric(lost),
    pending = as.numeric(pending)
  )

```

  
### ATTENDANCE & CANCELLATION RATE

This variable is a numeric variable that sums up the attendance history of the member based on the following formulas: 
(a)	Attendance rate = (Attended + (1/2 pending)) / Total Sessions
(b)	Cancellation rate = (canceled + lost + (1/2 pending)) / Total Sessions

The use of the “pending” items is based on the theoretical likelihood that there is a 50% chance that the member attended the appointment or not have attended the appointment. 

```{r}

# Attendance_Rate + Cancellation_Rate

bang = bang %>% 
  mutate(
	attendance_rate = round(((attended + (0.5*pending)) / total_sessions) * 100, 2),
	cancellation_rate = round(((cancelled + lost + (0.5*pending))/total_sessions)  * 100, 2)
	) 

```

(FUTURE MIKE) When doing preliminary analysis, I realized that I will be handling non-normally distributed data.  Considering how this would cause violations in certain regression analyses, I will need to transform this data through multiple means to allow these assumptions to hold. 

```{r}

bang = bang %>% 
    mutate(
        attendance_rate_group = ifelse(c(attendance_rate >= 0 & attendance_rate < 10), "0-9.99",
                                ifelse(c(attendance_rate >= 10 & attendance_rate < 20), "10-19.99",
                                ifelse(c(attendance_rate >= 20 & attendance_rate < 30), "20-29.99",
                                ifelse(c(attendance_rate >= 30 & attendance_rate < 40), "30-39.99",
                                ifelse(c(attendance_rate >= 40 & attendance_rate < 50), "40-49.99",
                                ifelse(c(attendance_rate >= 50 & attendance_rate < 60), "50-59.99",
                                ifelse(c(attendance_rate >= 60 & attendance_rate < 70), "60-69.99",
                                ifelse(c(attendance_rate >= 70 & attendance_rate < 80), "70-79.99",
                                ifelse(c(attendance_rate >= 80 & attendance_rate < 90), "80-89.99",
                                ifelse(c(attendance_rate >= 90 & attendance_rate <= 100), "90-100", NA)))))))))), 
        
        attendance_grouping_ver.1 = ifelse(c(attendance_rate >= 0 & attendance_rate < 50), '0-49.99',
                                    ifelse(c(attendance_rate >= 50 & attendance_rate < 60), "50-59.99",
                                    ifelse(c(attendance_rate >= 60 & attendance_rate < 70), "60-69.99", 
                                    ifelse(c(attendance_rate >= 70 & attendance_rate < 80), "70-79.99", 
                                    ifelse(c(attendance_rate >= 80 & attendance_rate < 90), "80-89.99", 
                                    ifelse(attendance_rate >= 90, '90-100', NA)))))), 
        
        attendance_cutoff = ifelse(attendance_rate < 60, 'no', 'yes'), 
        
        attendance_rate_cutoff = ifelse(c(attendance_rate >= 68.97 & membership == '1x'), "yes",
					ifelse(c(attendance_rate < 68.97 & membership == '1x'), 'no', 
					ifelse(c(attendance_rate >= 75.00 & membership == '2x'), 'yes', 
					ifelse(c(attendance_rate < 75.00 & membership == '2x'), 'no',
					ifelse(c(attendance_rate >= 61.81 & membership == '3x'), 'yes',
					ifelse(c(attendance_rate < 61.81 & membership == '3x'), 'no',
					ifelse(c(attendance_rate >= 47.13 & membership == '4x'), 'yes',
					ifelse(c(attendance_rate < 47.13 & membership == '4x'), 'no',
					ifelse(c(attendance_rate >= 36.41 & membership == 'unlimited'), 'yes',
					ifelse(c(attendance_rate < 36.41 & membership == 'unlimited'), 'no',
					ifelse(c(attendance_rate >= 50 & membership == 'group'), 'yes',
					ifelse(c(attendance_rate < 50 & membership == 'group'), 'no',
					ifelse(c(attendance_rate >= 42.71 & membership == 'distance'), 'yes', 'no')))))))))))))
    ) %>% 
  mutate(
    attendance_rate_cutoff = as.factor(attendance_rate_cutoff),
    attendance_cutoff = as.factor(attendance_cutoff),
    attendance_grouping_ver.1 = as.factor(attendance_grouping_ver.1),
    attendance_rate_group = as.factor(attendance_rate_group)
  )

```

### EMAIL INTERACTIONS

  In assessing the sort of interactions that membership service teams have with members, I've exclusively used Emails as that was the only thing that had a paper trail.  By paper-trail, I basically mean that counting the number of a particular email interactions from the inbox.  I've categorized this into 4 categories: 
  
^**Table3. Types of Email Interactions**^

| ** Email Type  **                | ** Description **                                                                                                               |
|----------------------------------|---------------------------------------------------------------------------------------------------------------------------------|
| Billing                          | Refers to any email interaction relating to any inquiries or events of unknown charge and/or billing errors                     |
| CX                               | Refers to Customer Experience interactions that relate to check-in or anything not related to providing service or rescheduling |
| Scheduling                       | Refers to any email interactions that pertain to request for rescheduling or scheduling appointments (Hybrid Training Only)     |
| Service                          | Refers to any requests or inquiries pertaining to administrative tasks, memberships, etc. that isn't relating to scheduling     |

Realizing that some folks may not have any other emails types than one particular kind, I will look at this in terms of percentage of total emails. 

```{r}

bang = bang %>%
  mutate(
    num_ticket_billing = as.numeric(num_ticket_billing),
    num_ticket_scheduling = as.numeric(num_ticket_scheduling),
    num_ticket_service = as.numeric(num_ticket_service),
    num_ticket_cx = as.numeric(num_ticket_cx)
  )

bang = bang %>% 
	mutate(
		num_ticket_total = c(num_ticket_billing + num_ticket_cx + num_ticket_scheduling + num_ticket_service)
	) %>% 
	mutate(
		per_ticket_billing = round( (num_ticket_billing/num_ticket_total)*100 , 2),
		per_ticket_cx = round( (num_ticket_cx/num_ticket_total)*100 , 2),
		per_ticket_scheduling = round( (num_ticket_scheduling/num_ticket_total)*100 , 2),
		per_ticket_service = round( (num_ticket_service/num_ticket_total)*100 , 2)
	) %>% 
	mutate(

		per_ticket_billing = ifelse(!is.na(per_ticket_billing), per_ticket_billing, 0),
		per_ticket_cx = ifelse(!is.na(per_ticket_cx), per_ticket_cx, 0),
		per_ticket_scheduling = ifelse(!is.na(per_ticket_scheduling), per_ticket_scheduling, 0),
		per_ticket_service = ifelse(!is.na(per_ticket_service), per_ticket_service, 0)
	)

```

(FUTURE MIKE) I realized that billing-related emails isn't really great in terms of treating it as a percentage since it's fairly rare occurrence and will throw off the analyses downstream.  So I will instead create two new variables to break this aspect down and separate it from the inclusion of email types. I've also rearranged percentage to only assess CX, Scheduling and Service-related emails. This will lead to having a new sum total of emails which include all types EXCEPT for Billing-related emails.  Lastly, I realize that the total number of these emails may not be as useful considering that it's an absolute number.  Thus, I've create a measure of mean number of emails per month. 

```{r}

bang = bang %>% 
	mutate(
		ever_billing_issue = ifelse(num_ticket_billing > 0, 'yes', 'no')
	) %>% 
	mutate(
		ever_billing_issue = as.factor(ever_billing_issue)
	)

bang = bang %>% 
	mutate(
		num_billing_issue = 	ifelse(num_ticket_billing == 0, "no billing issue",
					ifelse(c(num_ticket_billing >= 0 & num_ticket_billing < 2), "one billing issue", "two or more billing issue"))			
	) %>% 
	mutate(
		num_billing_issue = as.factor(num_billing_issue)
	)

bang = bang %>% 
	mutate(
		new_num_total = c(num_ticket_cx + num_ticket_scheduling + num_ticket_service)
	) %>% 
	mutate(
		new_per_ticket_cx = round((num_ticket_cx / new_num_total)*100, 2),
		new_per_ticket_scheduling = round((num_ticket_scheduling / new_num_total)*100, 2),
		new_per_ticket_service = round((num_ticket_service / new_num_total)*100, 2)
	) %>%
	mutate(
		new_per_ticket_cx = ifelse(!is.na(new_per_ticket_cx), new_per_ticket_cx, 0), 
 		new_per_ticket_scheduling = ifelse(!is.na(new_per_ticket_scheduling), new_per_ticket_scheduling, 0),
 		new_per_ticket_service = ifelse(!is.na(new_per_ticket_service), new_per_ticket_service, 0)
	)

bang = bang %>% 
  mutate(
    num_emails_month = round((new_num_total / length) * 30.5, 3) # avg number of days in a month 
  ) %>%
  mutate(
    num_emails_month = as.numeric(num_emails_month)
  )

 
```

### MONTHLY MEMBERSHIP RATES

In order to determine the monthly rates of a member, it will be based on the weighted average of monthly rates across each membership type that the member had engaged in. 

```{r}

bang = bang %>% 
	mutate(
		active_1x_total = 	ifelse(c(active_1x > 0 & active_rate_1x > 0), c(active_1x * active_rate_1x),		
					ifelse(c(active_1x >  0	& active_rate_1x == 0),	c(active_1x * active_rate_1x),		
					ifelse(c(active_1x == 0	& active_rate_1x > 0), c(active_1x * active_rate_1x), 
					ifelse(c(active_1x == 0 & active_rate_1x == 0), 0, NA))))
	) %>%
	mutate(
		active_2x_total = 	ifelse(c(active_2x > 0 & active_rate_2x > 0), c(active_2x * active_rate_2x),		
					ifelse(c(active_2x >  0	& active_rate_2x == 0),	c(active_2x * active_rate_2x),		
					ifelse(c(active_2x == 0	& active_rate_2x > 0), c(active_2x * active_rate_2x), 
					ifelse(c(active_2x == 0 & active_rate_2x == 0), 0, NA))))
	) %>% 
	mutate(
		active_3x_total = 	ifelse(c(active_3x > 0 & active_rate_3x > 0), c(active_3x * active_rate_3x),		
					ifelse(c(active_3x >  0	& active_rate_3x == 0),	c(active_3x * active_rate_3x),		
					ifelse(c(active_3x == 0	& active_rate_3x > 0), c(active_3x * active_rate_3x), 
					ifelse(c(active_3x == 0 & active_rate_3x == 0), 0, NA))))
	) %>% 
	mutate(
		active_4x_total = 	ifelse(c(active_4x > 0 & active_rate_4x > 0), c(active_4x * active_rate_4x),		
					ifelse(c(active_4x >  0	& active_rate_4x == 0),	c(active_4x * active_rate_4x),		
					ifelse(c(active_4x == 0	& active_rate_4x > 0), c(active_4x * active_rate_4x), 
					ifelse(c(active_4x == 0 & active_rate_4x == 0), 0, NA))))
	) %>% 
	mutate(
		active_unlim_total = 	ifelse(c(active_unlim > 0 & active_rate_unlim > 0), c(active_unlim * active_rate_unlim),		
					ifelse(c(active_unlim >  0 & active_rate_unlim == 0), c(active_unlim * active_rate_unlim),		
					ifelse(c(active_unlim == 0 & active_rate_unlim > 0), c(active_unlim * active_rate_unlim), 
					ifelse(c(active_unlim == 0 & active_rate_unlim == 0), 0, NA))))
	) %>%
	mutate(
		active_group_total = 	ifelse(c(active_group > 0 & active_rate_group > 0), c(active_group * active_rate_group),		
					ifelse(c(active_group >  0 & active_rate_group == 0), c(active_group * active_rate_group),		
					ifelse(c(active_group == 0 & active_rate_group > 0), c(active_group * active_rate_group), 
					ifelse(c(active_group == 0 & active_rate_group == 0), 0, NA))))
	) %>% 
	mutate(
		active_distance_total = ifelse(c(active_distance > 0 & active_rate_distance > 0), c(active_distance * active_rate_distance),		
					ifelse(c(active_distance >  0 & active_rate_distance == 0), c(active_distance * active_rate_distance),		
					ifelse(c(active_distance == 0 & active_rate_distance > 0), c(active_distance * active_rate_distance), 
					ifelse(c(active_distance == 0 & active_rate_distance == 0), 0, NA))))
	) %>% 
	mutate(
		former_1x_total = 	ifelse(c(former_1x > 0 & former_rate_1x > 0), c(former_1x * former_rate_1x),		
					ifelse(c(former_1x >  0	& former_rate_1x == 0),	c(former_1x * former_rate_1x),		
					ifelse(c(former_1x == 0	& former_rate_1x > 0), c(former_1x * former_rate_1x), 
					ifelse(c(former_1x == 0 & former_rate_1x == 0), 0, NA))))
	) %>%
	mutate(
		former_2x_total = 	ifelse(c(former_2x > 0 & former_rate_2x > 0), c(former_2x * former_rate_2x),		
					ifelse(c(former_2x >  0	& former_rate_2x == 0),	c(former_2x * former_rate_2x),		
					ifelse(c(former_2x == 0	& former_rate_2x > 0), c(former_2x * former_rate_2x), 
					ifelse(c(former_2x == 0 & former_rate_2x == 0), 0, NA))))
	) %>% 
	mutate(
		former_3x_total = 	ifelse(c(former_3x > 0 & former_rate_3x > 0), c(former_3x * former_rate_3x),		
					ifelse(c(former_3x >  0	& former_rate_3x == 0),	c(former_3x * former_rate_3x),		
					ifelse(c(former_3x == 0	& former_rate_3x > 0), c(former_3x * former_rate_3x), 
					ifelse(c(former_3x == 0 & former_rate_3x == 0), 0, NA))))
	) %>% 
	mutate(
		former_4x_total = 	ifelse(c(former_4x > 0 & former_rate_4x > 0), c(former_4x * former_rate_4x),		
					ifelse(c(former_4x >  0	& former_rate_4x == 0),	c(former_4x * former_rate_4x),		
					ifelse(c(former_4x == 0	& former_rate_4x > 0), c(former_4x * former_rate_4x), 
					ifelse(c(former_4x == 0 & former_rate_4x == 0), 0, NA))))
	) %>% 
	mutate(
		former_unlim_total = 	ifelse(c(former_unlim > 0 & former_rate_unlim > 0), c(former_unlim * former_rate_unlim),		
					ifelse(c(former_unlim >  0 & former_rate_unlim == 0), c(former_unlim * former_rate_unlim),		
					ifelse(c(former_unlim == 0 & former_rate_unlim > 0), c(former_unlim * former_rate_unlim), 
					ifelse(c(former_unlim == 0 & former_rate_unlim == 0), 0, NA))))
	) %>%
	mutate(
		former_group_total = 	ifelse(c(former_group > 0 & former_rate_group > 0), c(former_group * former_rate_group),		
					ifelse(c(former_group >  0 & former_rate_group == 0), c(former_group * former_rate_group),		
					ifelse(c(former_group == 0 & former_rate_group > 0), c(former_group * former_rate_group), 
					ifelse(c(former_group == 0 & former_rate_group == 0), 0, NA))))
	) %>% 
	mutate(
		former_distance_total = ifelse(c(former_distance > 0 & former_rate_distance > 0), c(former_distance * former_rate_distance),		
					ifelse(c(former_distance >  0 & former_rate_distance == 0), c(former_distance * former_rate_distance),		
					ifelse(c(former_distance == 0 & former_rate_distance > 0), c(former_distance * former_rate_distance), 
					ifelse(c(former_distance == 0 & former_rate_distance == 0), 0, NA))))
	)


bang = bang %>% 
	mutate(
		avg_monthly_rate 	= ifelse(current == 'active', round((active_1x_total + active_2x_total + active_3x_total + active_4x_total + active_unlim_total + active_group_total + active_distance_total) / (active_1x + active_2x + active_3x + active_4x + active_unlim + active_group + active_distance), 2),
					  ifelse(current == 'former', round((former_1x_total + former_2x_total + former_3x_total + former_4x_total + former_unlim_total + former_group_total + former_distance_total) / (former_1x + former_2x + former_3x + former_4x + former_unlim + former_group + former_distance), 2), NA))
	) 

```

(Future Mike here) Realized that I will run into issues with making regression models due to issues of assumptions not being met (like linearity, proportionality, etc.) So to correct for these issues, I will try to categorize monthly rate in the same way that I had done earlier with attendance rate.

```{r}

bang = bang %>% 
    mutate(
        monthly_rate_group = ifelse(c(avg_monthly_rate >= 0 & avg_monthly_rate < 50), "0-99.99",
                             ifelse(c(avg_monthly_rate >= 50 & avg_monthly_rate < 100), "0-99.99",
                             ifelse(c(avg_monthly_rate >= 100 & avg_monthly_rate < 150), "100-149.99",
                             ifelse(c(avg_monthly_rate >= 150 & avg_monthly_rate < 200), "150-199.99",
                             ifelse(c(avg_monthly_rate >= 200 & avg_monthly_rate < 250), "200-249.99",
                             ifelse(c(avg_monthly_rate >= 250 & avg_monthly_rate < 300), "250-299.99",
                             ifelse(c(avg_monthly_rate >= 300 & avg_monthly_rate < 350), "300-349.99",
                             ifelse(c(avg_monthly_rate >= 350 & avg_monthly_rate < 400), "350-399.99",
                             ifelse(c(avg_monthly_rate >= 400 & avg_monthly_rate < 450), "400-449.99",
                             ifelse(c(avg_monthly_rate >= 450 & avg_monthly_rate < 500), "450-499.99",
                             ifelse(c(avg_monthly_rate >= 500 & avg_monthly_rate < 550), "500-549.99",
                             ifelse(c(avg_monthly_rate >= 550 & avg_monthly_rate < 600), "550-599.99",
                             ifelse(c(avg_monthly_rate >= 600), "600+", NA ))))))))))))),
        
        monthly_grouping_ver.1  =  ifelse(c(avg_monthly_rate >= 0 & avg_monthly_rate < 150), "0-149.99",
                           ifelse(c(avg_monthly_rate >= 150 & avg_monthly_rate < 200), "150-199.99", 
                           ifelse(c(avg_monthly_rate >= 200 & avg_monthly_rate < 300), "200-299.99", 
                           ifelse(c(avg_monthly_rate >= 300 & avg_monthly_rate < 350), "300-349.99",
                           ifelse(c(avg_monthly_rate >= 350 & avg_monthly_rate < 400), "350-399.99",
                           ifelse(c(avg_monthly_rate >= 400 & avg_monthly_rate < 450), "400-449.99",
                           ifelse(c(avg_monthly_rate >= 450 & avg_monthly_rate < 500), "450-499.99", 
                           ifelse(avg_monthly_rate >= 500, "500+", NA)))))))), 
      
        monthly_rate_cutoff = 	ifelse(c(avg_monthly_rate >= 246.76 & membership == '1x'), 'yes',
					ifelse(c(avg_monthly_rate <  246.76 & membership == '1x'), 'no',
					ifelse(c(avg_monthly_rate >= 340.10 & membership == '2x'), 'yes',
					ifelse(c(avg_monthly_rate < 340.10 & membership == '2x'), 'no',
					ifelse(c(avg_monthly_rate >= 377.60 & membership == '3x'), 'yes',
					ifelse(c(avg_monthly_rate < 377.60 & membership == '3x'), 'no',
					ifelse(c(avg_monthly_rate >= 412.90 & membership == '4x'), 'yes',
					ifelse(c(avg_monthly_rate < 412.90 & membership == '4x'), 'no',
					ifelse(c(avg_monthly_rate >= 450.90 & membership == 'unlimited'), 'yes',
					ifelse(c(avg_monthly_rate < 450.90 & membership == 'unlimited'), 'no',
					ifelse(c(avg_monthly_rate >= 226 & membership == 'group'), 'yes',
					ifelse(c(avg_monthly_rate < 226 & membership == 'group'), 'no',
					ifelse(c(avg_monthly_rate >= 231.50 & membership == 'distance'), 'yes', 'no')))))))))))))
    ) %>% 
  mutate(
        monthly_rate_group = as.factor(monthly_rate_group),
        monthly_grouping_ver.1 = as.factor(monthly_grouping_ver.1),
        monthly_rate_cutoff = as.factor(monthly_rate_cutoff)
  )

```

(Future Mike here) At some point in analysing the distribution of certain data, namely the non-billing related emails. There happens to be some evidence of zero-inflation, which is to be expected since some folks are just not the email type of folks.  Seeing as this will inevitably give me some suspect findings down the road, I'll use the advice found [here](https://stats.stackexchange.com/questions/56306/time-spent-in-an-activity-as-an-independent-variable) and [here](https://stats.stackexchange.com/questions/62983/zero-inflated-predictors-in-regression) to have **both** a continuous variable of percent composition of a specific non-billing type of email interaction along with a variable that dictates whether there is a particular type of email interaction or not.  Hopefully, this will give some clarity on the impact of that variable once we get into regression analyses. 

```{r}

bang = bang %>% 
  mutate(
    ever_email_month = ifelse(num_emails_month < 0.5, '0', '1'),
    ever_cx = ifelse(new_per_ticket_cx == 0, "0", "1"),
    ever_scheduling = ifelse(new_per_ticket_scheduling == 0, "0", "1"),
    ever_service = ifelse(new_per_ticket_service == 0, "0", "1")
  ) %>% 
  mutate(
    ever_email_month = as.factor(ever_email_month),
    ever_cx = as.factor(ever_cx),
    ever_scheduling = as.factor(ever_scheduling),
    ever_service = as.factor(ever_service),
  ) %>% 
  mutate(
    ever_email_month = revalue(ever_email_month, c('0' = 'no', '1' = 'yes')),
    ever_cx = revalue(ever_cx, c('0' = "no", '1' = "yes")), 
    ever_scheduling = revalue(ever_scheduling, c('0' = "no", '1' = "yes")), 
    ever_service = revalue(ever_service, c('0' = "no", '1' = "yes")), 
  )

```


## **Creating Multiple Data Sets**

In order to be observe and perform our analysis the way that is intended, I've divided the data across multiple data sets.The initial data set will only include the necessary data for our analysis. This will be considered our "final" data set that includes those with missing demographics variables.  I've also made a series of data sets based on the month and year. 

```{r}

finalized_bang = bang %>% 
  select(id, age_group, employment_sector, missing_value, current, 
         start_date, end_date, length, retention_3m, retention_6m, retention_12m, revenue_lifetime,
         reason_to_leave, expected_churn, unexpected_churn, avoidable_churn, unavoidable_churn,
         churn_type, membership, num_membership_change, num_breaks, num_active_breaks,
         num_former_breaks, num_renewals, avg_monthly_rate, monthly_rate_group, monthly_grouping_ver.1, monthly_rate_cutoff,
	 active_1x, active_rate_1x, active_2x, active_rate_2x, active_3x, active_rate_3x, active_4x, active_rate_4x, active_unlim, active_rate_unlim,
         active_group, active_rate_group, active_distance, active_rate_distance, active_renewal, former_1x, former_rate_1x,
         former_2x, former_rate_2x, former_3x, former_rate_3x, former_4x, former_rate_4x, former_unlim, former_rate_unlim, 
         former_group, former_rate_group, former_distance, former_rate_distance, former_renewal, total_sessions, attended, 
         cancelled, lost, pending, attendance_rate, attendance_rate_group, attendance_grouping_ver.1, attendance_rate_cutoff, cancellation_rate, num_ticket_billing,
	 num_ticket_cx, num_ticket_scheduling, num_ticket_service, num_ticket_total, per_ticket_billing, per_ticket_cx, per_ticket_scheduling, per_ticket_service,
	 ever_billing_issue, num_billing_issue, new_num_total, num_emails_month, ever_email_month, new_per_ticket_cx, ever_cx, new_per_ticket_scheduling, ever_scheduling,
	  new_per_ticket_service, ever_service, status.01.18,status.02.18, status.03.18, status.04.18, status.05.18, status.06.18, 
	 status.07.18, status.08.18, status.09.18, status.10.18, status.11.18, status.12.18, status.01.19, status.02.19, status.03.19, status.04.19, 
	 status.05.19, status.06.19, status.07.19, status.08.19, status.09.19, status.10.19, status.11.19, status.12.19, status.01.20, status.02.20, 
	 status.03.20, status.04.20, status.05.20, status.06.20, status.07.20, status.08.20, status.09.20, status.10.20)

January_2018 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.05.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.01.18 != "no")


February_2018 = finalized_bang %>% 
  select(-status.01.18, -status.03.18, -status.04.18, -status.05.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.02.18 != "no")


March_2018 = finalized_bang %>% 
  select(-status.02.18, -status.01.18, -status.04.18, -status.05.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.03.18 != "no")

April_2018 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.01.18, -status.05.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.04.18 != "no")


May_2018 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.05.18 != "no")

June_2018 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.01.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.06.18 != "no")

July_2018 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.01.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.07.18 != "no")

August_2018 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.07.18, 
         -status.01.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.08.18 != "no")

September_2018 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.01.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.09.18 != "no")

October_2018 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.01.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.10.18 != "no")

November_2018 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.01.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.11.18 != "no")

December_2018 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.01.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.12.18 != "no")



January_2019 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.05.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.18,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.01.19 != "no")


February_2019 = finalized_bang %>% 
  select(-status.01.18, -status.03.18, -status.04.18, -status.05.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.01.18, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.02.19 != "no")


March_2019 = finalized_bang %>% 
  select(-status.02.18, -status.01.18, -status.04.18, -status.05.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.01.18, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.03.19 != "no")

April_2019 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.01.18, -status.05.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.01.18, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.04.19 != "no")


May_2019 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.01.18, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.05.19 != "no")

June_2019 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.01.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.01.18, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.06.19 != "no")

July_2019 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.01.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.01.18,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.07.19 != "no")

August_2019 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.07.18, 
         -status.01.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.01.18, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.08.19 != "no")

September_2019 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.01.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.01.18, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.09.19 != "no")

October_2019 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.01.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.01.18, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.10.19 != "no")

November_2019 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.01.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.01.18, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.11.19 != "no")

December_2019 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.01.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.01.18, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.12.19 != "no")



January_2020 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.05.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.18,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.18,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.01.20 != "no")


February_2020 = finalized_bang %>% 
  select(-status.01.18, -status.03.18, -status.04.18, -status.05.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.01.18, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.01.18, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.02.20 != "no")


March_2020 = finalized_bang %>% 
  select(-status.02.18, -status.01.18, -status.04.18, -status.05.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.01.18, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.01.18, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.03.20 != "no")

April_2020 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.01.18, -status.05.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.01.18, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.01.18, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.04.20 != "no")


May_2020 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.01.18, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.01.18, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.05.20 != "no")

June_2020 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.01.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.01.18, -status.07.19,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.01.18, -status.07.20,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.06.20 != "no")

July_2020 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.01.18, 
         -status.08.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.01.18,
         -status.08.19, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.01.18,
         -status.08.20, -status.09.20, -status.10.20) %>% 
  filter(status.07.20 != "no")

August_2020 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.07.18, 
         -status.01.18, -status.09.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.01.18, -status.09.19, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.01.18, -status.09.20, -status.10.20) %>% 
  filter(status.08.20 != "no")

September_2020 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.01.18, -status.10.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.01.18, -status.10.19, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.01.18, -status.10.20) %>% 
  filter(status.09.20 != "no")

October_2020 = finalized_bang %>% 
  select(-status.02.18, -status.03.18, -status.04.18, -status.01.18, -status.06.18, -status.07.18, 
         -status.08.18, -status.09.18, -status.01.18, -status.11.18, -status.12.18, -status.01.19,
         -status.02.19, -status.03.19, -status.04.19, -status.05.19, -status.06.19, -status.07.19,
         -status.08.19, -status.09.19, -status.01.18, -status.11.19, -status.12.19, -status.01.20,
         -status.02.20, -status.03.20, -status.04.20, -status.05.20, -status.06.20, -status.07.20,
         -status.08.20, -status.09.20, -status.01.18) %>% 
  filter(status.10.20 != "no")


```

### HANDLING INCONSISTENT FINDINGS & MISSINGNESS

  Now, as this data set was compiled by me, there would definitely be typo errors, missing values and irregularities with some of the entries.  Using both Wellness Living and Air Table as a final check for entries in the data set, adjustment were made in filling out incorrect entries.  As for unknown variables, they only pertain to demographics (i.e. age and/or employment sector).  Looking at the make up of this group, it seems to account for 7.45% of the entire data set.  While the best bet is to just drop this subset, there could potentially be some bias introduced as a result.  So, the plan is to create an entire subset of this data and compare its descriptive findings with the non-missing data to assert if there is any noted difference.  However, for the sake of performing inferential statistics, we will only keep entries with no missing variables in the age and employment sector. 


```{r}

clean_bang = finalized_bang %>% filter(missing_value == 'not')

clean_bang = clean_bang %>% 
		mutate(
		age_group = ifelse(age_group == "Under 18", "Under 18",
			    ifelse(age_group == "18-29", "18-29",
			    ifelse(age_group == "30-44", "30-44",
			    ifelse(age_group == "45-64", "45-64",
			    ifelse(age_group == "65+", "65+", NA)))))
		)

clean_bang = clean_bang %>% 
	        mutate(		
		employment_sector = ifelse(employment_sector == "Finance/Insurance", "Finance/Insurance",
				    ifelse(employment_sector == "Transportation", 'Transportation', 
				    ifelse(employment_sector == "Health Care/Services", "Health Care/Services",
				    ifelse(employment_sector == "Professional/Technical Services", "Professional/Technical Services",
				    ifelse(employment_sector == "Hospitality/Retail/Accomodation", "Hospitality/Retail/Accomodation",
				    ifelse(employment_sector == "Student", "Student",
				    ifelse(employment_sector == "Entrepreneural/Owns Business", "Entrepreneural/Owns Business",
				    ifelse(employment_sector == "Other", "Other",
				    ifelse(employment_sector == "Scientific/Academic/Educational", "Scientific/Academic/Educational",
				    ifelse(employment_sector == "Technology/Information", "Technology/Information",
				    ifelse(employment_sector == "Social Services/Non-Profits", "Social Services/Non-Profits",
				    ifelse(employment_sector == "Government/Legal", "Government/Legal",
				    ifelse(employment_sector == "Advertising/Media/Art/Culture", "Advertising/Media/Art/Culture",					  
				    ifelse(employment_sector == "Real Estate/Construction/Waste", "Real Estate/Construction/Waste",
				    ifelse(employment_sector == "Natural Resource/Energy", "Natural Resource/Energy",
				    ifelse(employment_sector == "Manufacturing/Trade", "Manufacturing/Trade", NA))))))))))))))))
		)
		
clean_bang = clean_bang %>% 
		mutate(
		reason_to_leave = ifelse(reason_to_leave == "loss of employment", "loss of employment",
				  ifelse(reason_to_leave == "pandemic/global crisis", "pandemic/global crisis",
				  ifelse(reason_to_leave == "other", "other",
				  ifelse(reason_to_leave == "financial", "financial",
				  ifelse(reason_to_leave == "medical/health-related", "medical/health-related",
				  ifelse(reason_to_leave == "moving away", "moving away",
				  ifelse(reason_to_leave == "lacking accessibility/availability", "lacking accessibility/availability",
				  ifelse(reason_to_leave == "other fitness interest", "other fitness interest",
				  ifelse(reason_to_leave == "ghosted us", "ghosted us",
				  ifelse(reason_to_leave == "time-based arrangement", "time-based arrangement",
				  ifelse(reason_to_leave == "noted displeasure with Bang", "noted displeasure with Bang", NA)))))))))))
			)

clean_bang = clean_bang %>% 
		mutate(		
		churn_type = ifelse(churn_type == "unexpected + unavoidable", "unexpected + unavoidable",
			     ifelse(churn_type == "unexpected + avoidable", "unexpected + avoidable",
			     ifelse(churn_type == "expected + unavoidable", "expected + unavoidable",
			     ifelse(churn_type == "expected + avoidable", "expected + avoidable", NA))))
		)


clean_bang = clean_bang %>% 
		mutate(
			age_group = as.factor(age_group),
			employment_sector = as.factor(employment_sector),
			reason_to_leave = as.factor(reason_to_leave),
			churn_type = as.factor(churn_type)
		)


clean_bang = clean_bang %>% 
		mutate(
			age_group = relevel(age_group, ref = "Under 18"),
			employment_sector = relevel(employment_sector, ref = "Other"),
			current = relevel(current, ref = "former"),
			retention_3m = relevel(retention_3m, ref = 'no'),
			retention_6m = relevel(retention_6m, ref = 'no'),
			retention_12m = relevel(retention_12m, ref = 'no'),
			reason_to_leave = relevel(reason_to_leave, ref = "other"),
			churn_type = relevel(churn_type, ref = "unexpected + unavoidable"),
			membership = relevel(membership, ref = "1x")
		)

clean_bang_final <- clean_bang %>% 
  mutate(
    reason_to_leave = ifelse(c(!is.na(reason_to_leave) & reason_to_leave == "loss of employment"), "loss of employment",
                      ifelse(c(!is.na(reason_to_leave) & reason_to_leave == "pandemic/global crisis"), "pandemic/global crisis",
                      ifelse(c(!is.na(reason_to_leave) & reason_to_leave == "other"), "other",
                      ifelse(c(!is.na(reason_to_leave) & reason_to_leave == "financial"), "financial",
                      ifelse(c(!is.na(reason_to_leave) & reason_to_leave == "medical/health-related"), "medical/health-related",
                      ifelse(c(!is.na(reason_to_leave) & reason_to_leave == "moving away"), "moving away",
                      ifelse(c(!is.na(reason_to_leave) & reason_to_leave == "lacking accessibility/availability"), "lacking accessibility/availability",
                      ifelse(c(!is.na(reason_to_leave) & reason_to_leave == "other fitness interest"), "other fitness interest",
                      ifelse(c(!is.na(reason_to_leave) & reason_to_leave == "ghosted us"), "ghosted us",
                      ifelse(c(!is.na(reason_to_leave) & reason_to_leave == "time-based arrangement"), "time-based arrangement",
                      ifelse(c(!is.na(reason_to_leave) & reason_to_leave == "noted displeasure with Bang"), "noted displeasure with Bang", "still a member")))))))))))
    ) %>% 
  mutate(
    churn_type = ifelse(c(!is.na(churn_type) & churn_type == "unexpected + unavoidable"), "unexpected + unavoidable",
                 ifelse(c(!is.na(churn_type) & churn_type == "expected + unavoidable"), "expected + unavoidable",
                 ifelse(c(!is.na(churn_type) & churn_type == "unexpected + avoidable"), "unexpected + avoidable",
                 ifelse(c(!is.na(churn_type) & churn_type == "expected + avoidable"), "expected + avoidable", "still a member" ))))
    
    ) %>% 
  mutate(
    reason_to_leave = as.factor(reason_to_leave),
    churn_type = as.factor(churn_type)
    )

clean_bang_final = clean_bang_final %>% 
	mutate(
		reason_to_leave = relevel(reason_to_leave, ref = "still a member"),
		churn_type = relevel(churn_type, ref = "still a member")
	) 

clean_bang_final = clean_bang_final %>%
	mutate(
		expected_churn = ifelse(c(churn_type != 'still a member' & expected_churn == "yes"), "yes", 
				 ifelse(c(churn_type != 'still a member' & expected_churn == "no"), "no", NA)),
		unexpected_churn = ifelse(c(churn_type != 'still a member' & unexpected_churn == "yes"), "yes", 
				   ifelse(c(churn_type != 'still a member' & unexpected_churn == "no"), "no", NA)),
		avoidable_churn = ifelse(c(churn_type != 'still a member' & avoidable_churn == "yes"), "yes", 
				  ifelse(c(churn_type != 'still a member' & avoidable_churn == "no"), "no", NA)),
		unavoidable_churn = ifelse(c(churn_type != 'still a member' & unavoidable_churn == "yes"), "yes", 
				    ifelse(c(churn_type != 'still a member' & unavoidable_churn == "no"), "no", NA))
	) 

clean_bang_final = clean_bang_final %>%
	mutate(
		expected_churn = as.factor(expected_churn),
		unexpected_churn = as.factor(unexpected_churn),
		avoidable_churn = as.factor(avoidable_churn),
		unavoidable_churn = as.factor(unavoidable_churn)
	) %>% 
	mutate(
		expected_churn = relevel(expected_churn, ref = "no"),
		unexpected_churn = relevel(unexpected_churn, ref = "no"),
		unavoidable_churn = relevel(unavoidable_churn, ref = "no"),
		avoidable_churn = relevel(avoidable_churn, ref = 'no')
	)


clean_bang_final = clean_bang_final %>% 
		mutate(
			num_ticket_total = c(num_ticket_billing + num_ticket_cx + num_ticket_scheduling + num_ticket_service)
		) %>% 
		mutate(
			per_ticket_billing = round( (num_ticket_billing/num_ticket_total)*100 , 2),
			per_ticket_cx = round( (num_ticket_cx/num_ticket_total)*100 , 2),
			per_ticket_scheduling = round( (num_ticket_scheduling/num_ticket_total)*100 , 2),
			per_ticket_service = round( (num_ticket_service/num_ticket_total)*100 , 2)
		) %>% 
		mutate(

			per_ticket_billing = ifelse(!is.na(per_ticket_billing), per_ticket_billing, 0),
			per_ticket_cx = ifelse(!is.na(per_ticket_cx), per_ticket_cx, 0),
			per_ticket_scheduling = ifelse(!is.na(per_ticket_scheduling), per_ticket_scheduling, 0),
			per_ticket_service = ifelse(!is.na(per_ticket_service), per_ticket_service, 0)
		)


clean_bang_final = clean_bang_final %>% 
			mutate(
				became_former_member = ifelse(current == "active", 0, 1)
			)

```


## CREATING MULTIPLE DATA SETS

Additional data sets will be created that are divided based on: 

(1) only Hybrid vs Group vs Distance 
(2) former vs active members
(3) age groups
(4) employment sectors
(5) membership types 
(6) retention status at 3/6/12 months
(7) reasons to leave Bang Personal Training
(8) churn type
(9) membership status at a given month/year
(10) monthly membership rates
(11) attendance rates

I've also created pivoted data sets which stack related data together to get a more comprehensive look at the distribution of data.  These include types of email interactions, monthly membership updates, etc. 

```{r}

clean_bang_hybrid_only =  clean_bang_final %>% filter((active_group == 0 & active_distance == 0) | (former_group == 0 & former_distance == 0)) 

clean_bang_distance_only = clean_bang_final %>% 
  filter(
    (active_group == 0 & (active_1x == 0 & active_2x == 0 & active_3x == 0 & active_4x == 0 & active_unlim == 0)) | 
    (former_group == 0 & (former_1x == 0 & former_2x == 0 & former_3x == 0 & former_4x == 0 & former_unlim == 0))  
    )

clean_bang_group_only = clean_bang_final %>% 
  filter(
    (active_distance == 0 & (active_1x == 0 & active_2x == 0 & active_3x == 0 & active_4x == 0 & active_unlim == 0)) | 
    (former_distance == 0 & (former_1x == 0 & former_2x == 0 & former_3x == 0 & former_4x == 0 & former_unlim == 0))  
    )      

unclean_bang_hybrid_only = finalized_bang %>% filter((active_group == 0 & active_distance == 0) | (former_group == 0 & former_distance == 0))

unclean_bang_distance_only = finalized_bang %>% 
    filter(
    (active_group == 0 & (active_1x == 0 & active_2x == 0 & active_3x == 0 & active_4x == 0 & active_unlim == 0)) | 
    (former_group == 0 & (former_1x == 0 & former_2x == 0 & former_3x == 0 & former_4x == 0 & former_unlim == 0))  
    )

unclean_bang_group_only = finalized_bang %>% 
  filter(
    (active_distance == 0 & (active_1x == 0 & active_2x == 0 & active_3x == 0 & active_4x == 0 & active_unlim == 0)) | 
    (former_distance == 0 & (former_1x == 0 & former_2x == 0 & former_3x == 0 & former_4x == 0 & former_unlim == 0))  
    ) 


unclean_former_bang = finalized_bang %>% filter(current == "former")
unclean_active_bang = finalized_bang %>% filter(current == 'active')
former_bang = clean_bang_final %>% filter(current == "former")
active_bang = clean_bang_final %>% filter(current == 'active')

unclean_bang_under_18 = finalized_bang %>% filter(age_group == "Under 18")
unclean_bang_30_to_44 = finalized_bang %>% filter(age_group == "30-44")
unclean_bang_45_to_64 = finalized_bang %>% filter(age_group == "45-64")
unclean_bang_65 = finalized_bang %>% filter(age_group == "65+")
unclean_bang_na = finalized_bang %>% filter(age_group == "na")
bang_under_18 = clean_bang_final %>% filter(age_group == "Under 18")
bang_30_to_44 = clean_bang_final %>% filter(age_group == "30-44")
bang_45_to_64 = clean_bang_final %>% filter(age_group == "45-64")
bang_65 = clean_bang_final %>% filter(age_group == "65+")


unclean_bang_finance = finalized_bang %>% filter(employment_sector == "Finance/Insurance")
unclean_bang_transport = finalized_bang %>% filter(employment_sector == "Transportation")
unclean_bang_health = finalized_bang %>% filter(employment_sector == "Health Care/Services")
unclean_bang_pro = finalized_bang%>% filter(employment_sector == "Professional/Technical Services")
unclean_bang_stu = finalized_bang %>% filter(employment_sector == "Student")
unclean_bang_hra = finalized_bang %>% filter(employment_sector == "Hospitality/Retail/Accomodation")
unclean_bang_entra = finalized_bang %>% filter(employment_sector == "Entrepreneural/Owns Business")
unclean_bang_oth = finalized_bang %>% filter(employment_sector == "Other")
unclean_bang_scixedu = finalized_bang %>% filter(employment_sector == "Scientific/Academic/Education")
unclean_bang_tech = finalized_bang %>% filter(employment_sector == "Technology/Information")
unclean_bang_soc = finalized_bang %>% filter(employment_sector == "Social Services/Non-Profits")
unclean_bang_govxleg = finalized_bang %>% filter(employment_sector == "Government/Legal")
unclean_bang_art = finalized_bang %>% filter(employment_sector == "Advertising/Media/Art/Culture")
unclean_bang_rcw = finalized_bang %>% filter(employment_sector == "Real Estate/Construction/Waste")
unclean_bang_nr = finalized_bang %>% filter(employment_sector == "Natural Resource/Energy")
unclean_bang_manu = finalized_bang %>% filter(employment_sector == "Manufacturing/Trade")
unclean_bang_na = finalized_bang %>% filter(employment_sector == "na")
bang_finance = clean_bang_final %>% filter(employment_sector == "Finance/Insurance")
bang_transport = clean_bang_final %>% filter(employment_sector == "Transportation")
bang_health = clean_bang_final %>% filter(employment_sector == "Health Care/Services")
bang_pro = clean_bang_final %>% filter(employment_sector == "Professional/Technical Services")
bang_stu = clean_bang_final %>% filter(employment_sector == "Student")
bang_hra = clean_bang_final %>% filter(employment_sector == "Hospitality/Retail/Accomodation")
bang_entra = clean_bang_final %>% filter(employment_sector == "Entrepreneural/Owns Business")
bang_oth = clean_bang_final %>% filter(employment_sector == "Other")
bang_scixedu = clean_bang_final %>% filter(employment_sector == "Scientific/Academic/Education")
bang_tech = clean_bang_final %>% filter(employment_sector == "Technology/Information")
bang_soc = clean_bang_final %>% filter(employment_sector == "Social Services/Non-Profits")
bang_govxleg = clean_bang_final %>% filter(employment_sector == "Government/Legal")
bang_art = clean_bang_final %>% filter(employment_sector == "Advertising/Media/Art/Culture")
bang_rcw = clean_bang_final %>% filter(employment_sector == "Real Estate/Construction/Waste")
bang_nr = clean_bang_final %>% filter(employment_sector == "Natural Resource/Energy")
bang_manu = clean_bang_final %>% filter(employment_sector == "Manufacturing/Trade")


unclean_bang_1x = finalized_bang %>% filter(membership == '1x')
unclean_bang_2x = finalized_bang %>% filter(membership == '2x')
unclean_bang_3x = finalized_bang %>% filter(membership == '3x')
unclean_bang_4x = finalized_bang %>% filter(membership == '4x')
unclean_bang_unlim = finalized_bang %>% filter(membership == 'unlimited')
unclean_bang_group = finalized_bang %>% filter(membership == 'group')
unclean_bang_distance = finalized_bang %>% filter(membership == 'distance')
bang_1x = clean_bang_final %>% filter(membership == '1x')
bang_2x = clean_bang_final %>% filter(membership == '2x')
bang_3x = clean_bang_final %>% filter(membership == '3x')
bang_4x = clean_bang_final %>% filter(membership == '4x')
bang_unlim = clean_bang_final %>% filter(membership == 'unlimited')
bang_group = clean_bang_final %>% filter(membership == 'group')
bang_distance = clean_bang_final %>% filter(membership == 'distance')


unclean_bang_retain_3m = finalized_bang %>% filter(retention_3m == 'yes')
unclean_bang_not_retain_3m = finalized_bang %>% filter(retention_3m == 'no')
unclean_bang_retain_6m = finalized_bang %>% filter(retention_6m == 'yes')
unclean_bang_not_retain_6m = finalized_bang %>% filter(retention_6m == 'no')
unclean_bang_retain_12m = finalized_bang %>% filter(retention_12m == 'yes')
unclean_bang_not_retain_12m = finalized_bang %>% filter(retention_12m == 'no')
clean_bang_retain_3m = clean_bang_final %>% filter(retention_3m == 'yes')
clean_bang_not_retain_3m = clean_bang_final %>% filter(retention_3m == 'no')
clean_bang_retain_6m = clean_bang_final %>% filter(retention_6m == 'yes')
clean_bang_not_retain_6m = clean_bang_final %>% filter(retention_6m == 'no')
clean_bang_retain_12m = clean_bang_final %>% filter(retention_12m == 'yes')
clean_bang_not_retain_12m = clean_bang_final %>% filter(retention_12m == 'no')


unclean_bang_job = finalized_bang %>% filter(reason_to_leave == "loss of employment")
unclean_bang_covid = finalized_bang %>% filter(reason_to_leave == "pandemic/global crisis")
unclean_bang_oth = finalized_bang %>% filter(reason_to_leave == "other")
unclean_bang_cost = finalized_bang %>% filter(reason_to_leave == "financial")
unclean_bang_health = finalized_bang %>% filter(reason_to_leave == "medical/health-related")
unclean_bang_move = finalized_bang %>% filter(reason_to_leave == "moving away")
unclean_bang_interest = finalized_bang %>% filter(reason_to_leave == "other fitness interest")
unclean_bang_ghost = finalized_bang %>% filter(reason_to_leave == "ghosted us")
unclean_bang_time = finalized_bang %>% filter(reason_to_leave == "time-based arrangement")
unclean_bang_dislike = finalized_bang %>% filter(reason_to_leave == "noted displeasure with Bang")
unclean_bang_access = finalized_bang %>% filter(reason_to_leave == "lacking accessibility/availability")
bang_job = clean_bang_final %>% filter(reason_to_leave == "loss of employment")
bang_covid = clean_bang_final %>% filter(reason_to_leave == "pandemic/global crisis")
bang_oth = clean_bang_final %>% filter(reason_to_leave == "other")
bang_cost = clean_bang_final %>% filter(reason_to_leave == "financial")
bang_health = clean_bang_final %>% filter(reason_to_leave == "medical/health-related")
bang_move = clean_bang_final %>% filter(reason_to_leave == "moving away")
bang_interest = clean_bang_final %>% filter(reason_to_leave == "other fitness interest")
bang_ghost = clean_bang_final %>% filter(reason_to_leave == "ghosted us")
bang_time = clean_bang_final %>% filter(reason_to_leave == "time-based arrangement")
bang_dislike = clean_bang_final %>% filter(reason_to_leave == "noted displeasure with Bang")
bang_access = clean_bang_final %>% filter(reason_to_leave == "lacking accessibility/availability")

bang_unexpxunavoid = clean_bang_final %>% filter(churn_type == "unexpected + unavoidable")
bang_expxunavoid = clean_bang_final %>% filter(churn_type == "expected + unavoidable")
bang_unexpxavoid = clean_bang_final %>% filter(churn_type == "unexpected + avoidable")
bang_expxavoid = clean_bang_final %>% filter(churn_type == "expected + avoidable")
bang_avoid =  clean_bang_final %>% filter(churn_type == "unexpected + avoidable" | churn_type == "expected + avoidable")
bang_unavoid =  clean_bang_final %>% filter(churn_type == "expected + unavoidable" | churn_type == "unexpected + unavoidable")
bang_exp =  clean_bang_final %>% filter(churn_type == "expected + unavoidable" | churn_type == "expected + avoidable")
bang_unexp =  clean_bang_final %>% filter(churn_type == "unexpected + avoidable" | churn_type == "unexpected + unavoidable")

bang_new_01.18 = clean_bang_final %>% filter(status.01.18 == "new/returning")
bang_current_01.18 = clean_bang_final %>% filter(status.01.18 == "current")
bang_leave_01.18 = clean_bang_final %>% filter(status.01.18 == "leaving")
bang_member_01.18 = clean_bang_final %>% filter(status.01.18 != 'no')
bang_new_02.18 = clean_bang_final %>% filter(status.02.18 == "new/returning")
bang_current_02.18 = clean_bang_final %>% filter(status.02.18 == "current")
bang_leave_02.18 = clean_bang_final %>% filter(status.02.18 == "leaving")
bang_member_02.18 = clean_bang_final %>% filter(status.02.18 != 'no')
bang_new_03.18 = clean_bang_final %>% filter(status.03.18 == "new/returning")
bang_current_03.18 = clean_bang_final %>% filter(status.03.18 == "current")
bang_leave_03.18 = clean_bang_final %>% filter(status.03.18 == "leaving")
bang_member_03.18 = clean_bang_final %>% filter(status.03.18 != 'no')
bang_new_04.18 = clean_bang_final %>% filter(status.04.18 == "new/returning")
bang_current_04.18 = clean_bang_final %>% filter(status.04.18 == "current")
bang_leave_04.18 = clean_bang_final %>% filter(status.04.18 == "leaving")
bang_member_04.18 = clean_bang_final %>% filter(status.04.18 != 'no')
bang_new_05.18 = clean_bang_final %>% filter(status.05.18 == "new/returning")
bang_current_05.18 = clean_bang_final %>% filter(status.05.18 == "current")
bang_leave_05.18 = clean_bang_final %>% filter(status.05.18 == "leaving")
bang_member_05.18 = clean_bang_final %>% filter(status.05.18 != 'no')
bang_new_06.18 = clean_bang_final %>% filter(status.06.18 == "new/returning")
bang_current_06.18 = clean_bang_final %>% filter(status.06.18 == "current")
bang_leave_06.18 = clean_bang_final %>% filter(status.06.18 == "leaving")
bang_member_06.18 = clean_bang_final %>% filter(status.06.18 != 'no')
bang_new_07.18 = clean_bang_final %>% filter(status.07.18 == "new/returning")
bang_current_07.18 = clean_bang_final %>% filter(status.07.18 == "current")
bang_leave_07.18 = clean_bang_final %>% filter(status.07.18 == "leaving")
bang_member_07.18 = clean_bang_final %>% filter(status.07.18 != 'no')
bang_new_08.18 = clean_bang_final %>% filter(status.08.18 == "new/returning")
bang_current_08.18 = clean_bang_final %>% filter(status.08.18 == "current")
bang_leave_08.18 = clean_bang_final %>% filter(status.08.18 == "leaving")
bang_member_08.18 = clean_bang_final %>% filter(status.08.18 != 'no')
bang_new_09.18 = clean_bang_final %>% filter(status.09.18 == "new/returning")
bang_current_09.18 = clean_bang_final %>% filter(status.09.18 == "current")
bang_leave_09.18 = clean_bang_final %>% filter(status.09.18 == "leaving")
bang_member_09.18 = clean_bang_final %>% filter(status.09.18 != 'no')
bang_new_10.18 = clean_bang_final %>% filter(status.10.18 == "new/returning")
bang_current_10.18 = clean_bang_final %>% filter(status.10.18 == "current")
bang_leave_10.18 = clean_bang_final %>% filter(status.10.18 == "leaving")
bang_member_10.18 = clean_bang_final %>% filter(status.10.18 != 'no')
bang_new_11.18 = clean_bang_final %>% filter(status.11.18 == "new/returning")
bang_current_11.18 = clean_bang_final %>% filter(status.11.18 == "current")
bang_leave_11.18 = clean_bang_final %>% filter(status.11.18 == "leaving")
bang_member_11.18 = clean_bang_final %>% filter(status.11.18 != 'no')
bang_new_12.18 = clean_bang_final %>% filter(status.12.18 == "new/returning")
bang_current_12.18 = clean_bang_final %>% filter(status.12.18 == "current")
bang_leave_12.18 = clean_bang_final %>% filter(status.12.18 == "leaving")
bang_member_12.18 = clean_bang_final %>% filter(status.12.18 != 'no')
bang_new_01.19 = clean_bang_final %>% filter(status.01.19 == "new/returning")
bang_current_01.19 = clean_bang_final %>% filter(status.01.19 == "current")
bang_leave_01.19 = clean_bang_final %>% filter(status.01.19 == "leaving")
bang_member_01.19 = clean_bang_final %>% filter(status.01.19 != 'no')
bang_new_02.19 = clean_bang_final %>% filter(status.02.19 == "new/returning")
bang_current_02.19 = clean_bang_final %>% filter(status.02.19 == "current")
bang_leave_02.19 = clean_bang_final %>% filter(status.02.19 == "leaving")
bang_member_02.19 = clean_bang_final %>% filter(status.02.19 != 'no')
bang_new_03.19 = clean_bang_final %>% filter(status.03.19 == "new/returning")
bang_current_03.19 = clean_bang_final %>% filter(status.03.19 == "current")
bang_leave_03.19 = clean_bang_final %>% filter(status.03.19 == "leaving")
bang_member_03.19 = clean_bang_final %>% filter(status.03.19 != 'no')
bang_new_04.19 = clean_bang_final %>% filter(status.04.19 == "new/returning")
bang_current_04.19 = clean_bang_final %>% filter(status.04.19 == "current")
bang_leave_04.19 = clean_bang_final %>% filter(status.04.19 == "leaving")
bang_member_04.19 = clean_bang_final %>% filter(status.04.19 != 'no')
bang_new_05.19 = clean_bang_final %>% filter(status.05.19 == "new/returning")
bang_current_05.19 = clean_bang_final %>% filter(status.05.19 == "current")
bang_leave_05.19 = clean_bang_final %>% filter(status.05.19 == "leaving")
bang_member_05.19 = clean_bang_final %>% filter(status.05.19 != 'no')
bang_new_06.19 = clean_bang_final %>% filter(status.06.19 == "new/returning")
bang_current_06.19 = clean_bang_final %>% filter(status.06.19 == "current")
bang_leave_06.19 = clean_bang_final %>% filter(status.06.19 == "leaving")
bang_member_06.19 = clean_bang_final %>% filter(status.06.19 != 'no')
bang_new_07.19 = clean_bang_final %>% filter(status.07.19 == "new/returning")
bang_current_07.19 = clean_bang_final %>% filter(status.07.19 == "current")
bang_leave_07.19 = clean_bang_final %>% filter(status.07.19 == "leaving")
bang_member_07.19 = clean_bang_final %>% filter(status.07.19 != 'no')
bang_new_08.19 = clean_bang_final %>% filter(status.08.19 == "new/returning")
bang_current_08.19 = clean_bang_final %>% filter(status.08.19 == "current")
bang_leave_08.19 = clean_bang_final %>% filter(status.08.19 == "leaving")
bang_member_08.19 = clean_bang_final %>% filter(status.08.19 != 'no')
bang_new_09.19 = clean_bang_final %>% filter(status.09.19 == "new/returning")
bang_current_09.19 = clean_bang_final %>% filter(status.09.19 == "current")
bang_leave_09.19 = clean_bang_final %>% filter(status.09.19 == "leaving")
bang_member_09.19 = clean_bang_final %>% filter(status.09.19 != 'no')
bang_new_10.19 = clean_bang_final %>% filter(status.10.19 == "new/returning")
bang_current_10.19 = clean_bang_final %>% filter(status.10.19 == "current")
bang_leave_10.19 = clean_bang_final %>% filter(status.10.19 == "leaving")
bang_member_10.19 = clean_bang_final %>% filter(status.10.19 != 'no')
bang_new_11.19 = clean_bang_final %>% filter(status.11.19 == "new/returning")
bang_current_11.19 = clean_bang_final %>% filter(status.11.19 == "current")
bang_leave_11.19 = clean_bang_final %>% filter(status.11.19 == "leaving")
bang_member_11.19 = clean_bang_final %>% filter(status.11.19 != 'no')
bang_new_12.19 = clean_bang_final %>% filter(status.12.19 == "new/returning")
bang_current_12.19 = clean_bang_final %>% filter(status.12.19 == "current")
bang_leave_12.19 = clean_bang_final %>% filter(status.12.19 == "leaving")
bang_member_12.19 = clean_bang_final %>% filter(status.12.19 != 'no')
bang_new_01.20 = clean_bang_final %>% filter(status.01.20 == "new/returning")
bang_current_01.20 = clean_bang_final %>% filter(status.01.20 == "current")
bang_leave_01.20 = clean_bang_final %>% filter(status.01.20 == "leaving")
bang_member_01.20 = clean_bang_final %>% filter(status.01.20 != 'no')
bang_new_02.20 = clean_bang_final %>% filter(status.02.20 == "new/returning")
bang_current_02.20 = clean_bang_final %>% filter(status.02.20 == "current")
bang_leave_02.20 = clean_bang_final %>% filter(status.02.20 == "leaving")
bang_member_02.20 = clean_bang_final %>% filter(status.02.20 != 'no')
bang_new_03.20 = clean_bang_final %>% filter(status.03.20 == "new/returning")
bang_current_03.20 = clean_bang_final %>% filter(status.03.20 == "current")
bang_leave_03.20 = clean_bang_final %>% filter(status.03.20 == "leaving")
bang_member_03.20 = clean_bang_final %>% filter(status.03.20 != 'no')
bang_new_04.20 = clean_bang_final %>% filter(status.04.20 == "new/returning")
bang_current_04.20 = clean_bang_final %>% filter(status.04.20 == "current")
bang_leave_04.20 = clean_bang_final %>% filter(status.04.20 == "leaving")
bang_member_04.20 = clean_bang_final %>% filter(status.04.20 != 'no')
bang_new_05.20 = clean_bang_final %>% filter(status.05.20 == "new/returning")
bang_current_05.20 = clean_bang_final %>% filter(status.05.20 == "current")
bang_leave_05.20 = clean_bang_final %>% filter(status.05.20 == "leaving")
bang_member_05.20 = clean_bang_final %>% filter(status.05.20 != 'no')
bang_new_06.20 = clean_bang_final %>% filter(status.06.20 == "new/returning")
bang_current_06.20 = clean_bang_final %>% filter(status.06.20 == "current")
bang_leave_06.20 = clean_bang_final %>% filter(status.06.20 == "leaving")
bang_member_06.20 = clean_bang_final %>% filter(status.06.20 != 'no')
bang_new_07.20 = clean_bang_final %>% filter(status.07.20 == "new/returning")
bang_current_07.20 = clean_bang_final %>% filter(status.07.20 == "current")
bang_leave_07.20 = clean_bang_final %>% filter(status.07.20 == "leaving")
bang_member_07.20 = clean_bang_final %>% filter(status.07.20 != 'no')
bang_new_08.20 = clean_bang_final %>% filter(status.08.20 == "new/returning")
bang_current_08.20 = clean_bang_final %>% filter(status.08.20 == "current")
bang_leave_08.20 = clean_bang_final %>% filter(status.08.20 == "leaving")
bang_member_08.20 = clean_bang_final %>% filter(status.08.20 != 'no')
bang_new_09.20 = clean_bang_final %>% filter(status.09.20 == "new/returning")
bang_current_09.20 = clean_bang_final %>% filter(status.09.20 == "current")
bang_leave_09.20 = clean_bang_final %>% filter(status.09.20 == "leaving")
bang_member_09.20 = clean_bang_final %>% filter(status.09.20 != 'no')
bang_new_10.20 = clean_bang_final %>% filter(status.10.20 == "new/returning")
bang_current_10.20 = clean_bang_final %>% filter(status.10.20 == "current")
bang_leave_10.20 = clean_bang_final %>% filter(status.10.20 == "leaving")
bang_member_10.20 = clean_bang_final %>% filter(status.10.20 != 'no')


unclean_bang_new_01.18 = finalized_bang %>% filter(status.01.18 == "new/returning")
unclean_bang_current_01.18 = finalized_bang %>% filter(status.01.18 == "current")
unclean_bang_leave_01.18 = finalized_bang %>% filter(status.01.18 == "leaving")
unclean_bang_member_01.18 = finalized_bang %>% filter(status.01.18 != 'no')
unclean_bang_new_02.18 = finalized_bang %>% filter(status.02.18 == "new/returning")
unclean_bang_current_02.18 = finalized_bang %>% filter(status.02.18 == "current")
unclean_bang_leave_02.18 = finalized_bang %>% filter(status.02.18 == "leaving")
unclean_bang_member_02.18 = finalized_bang %>% filter(status.02.18 != 'no')
unclean_bang_new_03.18 = finalized_bang %>% filter(status.03.18 == "new/returning")
unclean_bang_current_03.18 = finalized_bang %>% filter(status.03.18 == "current")
unclean_bang_leave_03.18 = finalized_bang %>% filter(status.03.18 == "leaving")
unclean_bang_member_03.18 = finalized_bang %>% filter(status.03.18 != 'no')
unclean_bang_new_04.18 = finalized_bang %>% filter(status.04.18 == "new/returning")
unclean_bang_current_04.18 = finalized_bang %>% filter(status.04.18 == "current")
unclean_bang_leave_04.18 = finalized_bang %>% filter(status.04.18 == "leaving")
unclean_bang_member_04.18 = finalized_bang %>% filter(status.04.18 != 'no')
unclean_bang_new_05.18 = finalized_bang %>% filter(status.05.18 == "new/returning")
unclean_bang_current_05.18 = finalized_bang %>% filter(status.05.18 == "current")
unclean_bang_leave_05.18 = finalized_bang %>% filter(status.05.18 == "leaving")
unclean_bang_member_05.18 = finalized_bang %>% filter(status.05.18 != 'no')
unclean_bang_new_06.18 = finalized_bang %>% filter(status.06.18 == "new/returning")
unclean_bang_current_06.18 = finalized_bang %>% filter(status.06.18 == "current")
unclean_bang_leave_06.18 = finalized_bang %>% filter(status.06.18 == "leaving")
unclean_bang_member_06.18 = finalized_bang %>% filter(status.06.18 != 'no')
unclean_bang_new_07.18 = finalized_bang %>% filter(status.07.18 == "new/returning")
unclean_bang_current_07.18 = finalized_bang %>% filter(status.07.18 == "current")
unclean_bang_leave_07.18 = finalized_bang %>% filter(status.07.18 == "leaving")
unclean_bang_member_07.18 = finalized_bang %>% filter(status.07.18 != 'no')
unclean_bang_new_08.18 = finalized_bang %>% filter(status.08.18 == "new/returning")
unclean_bang_current_08.18 = finalized_bang %>% filter(status.08.18 == "current")
unclean_bang_leave_08.18 = finalized_bang %>% filter(status.08.18 == "leaving")
unclean_bang_member_08.18 = finalized_bang %>% filter(status.08.18 != 'no')
unclean_bang_new_09.18 = finalized_bang %>% filter(status.09.18 == "new/returning")
unclean_bang_current_09.18 = finalized_bang %>% filter(status.09.18 == "current")
unclean_bang_leave_09.18 = finalized_bang %>% filter(status.09.18 == "leaving")
unclean_bang_member_09.18 = finalized_bang %>% filter(status.09.18 != 'no')
unclean_bang_new_10.18 = finalized_bang %>% filter(status.10.18 == "new/returning")
unclean_bang_current_10.18 = finalized_bang %>% filter(status.10.18 == "current")
unclean_bang_leave_10.18 = finalized_bang %>% filter(status.10.18 == "leaving")
unclean_bang_member_10.18 = finalized_bang %>% filter(status.10.18 != 'no')
unclean_bang_new_11.18 = finalized_bang %>% filter(status.11.18 == "new/returning")
unclean_bang_current_11.18 = finalized_bang %>% filter(status.11.18 == "current")
unclean_bang_leave_11.18 = finalized_bang %>% filter(status.11.18 == "leaving")
unclean_bang_member_11.18 = finalized_bang %>% filter(status.11.18 != 'no')
unclean_bang_new_12.18 = finalized_bang %>% filter(status.12.18 == "new/returning")
unclean_bang_current_12.18 = finalized_bang %>% filter(status.12.18 == "current")
unclean_bang_leave_12.18 = finalized_bang %>% filter(status.12.18 == "leaving")
unclean_bang_member_12.18 = finalized_bang %>% filter(status.12.18 != 'no')
unclean_bang_new_01.19 = finalized_bang %>% filter(status.01.19 == "new/returning")
unclean_bang_current_01.19 = finalized_bang %>% filter(status.01.19 == "current")
unclean_bang_leave_01.19 = finalized_bang %>% filter(status.01.19 == "leaving")
unclean_bang_member_01.19 = finalized_bang %>% filter(status.01.19 != 'no')
unclean_bang_new_02.19 = finalized_bang %>% filter(status.02.19 == "new/returning")
unclean_bang_current_02.19 = finalized_bang %>% filter(status.02.19 == "current")
unclean_bang_leave_02.19 = finalized_bang %>% filter(status.02.19 == "leaving")
unclean_bang_member_02.19 = finalized_bang %>% filter(status.02.19 != 'no')
unclean_bang_new_03.19 = finalized_bang %>% filter(status.03.19 == "new/returning")
unclean_bang_current_03.19 = finalized_bang %>% filter(status.03.19 == "current")
unclean_bang_leave_03.19 = finalized_bang %>% filter(status.03.19 == "leaving")
unclean_bang_member_03.19 = finalized_bang %>% filter(status.03.19 != 'no')
unclean_bang_new_04.19 = finalized_bang %>% filter(status.04.19 == "new/returning")
unclean_bang_current_04.19 = finalized_bang %>% filter(status.04.19 == "current")
unclean_bang_leave_04.19 = finalized_bang %>% filter(status.04.19 == "leaving")
unclean_bang_member_04.19 = finalized_bang %>% filter(status.04.19 != 'no')
unclean_bang_new_05.19 = finalized_bang %>% filter(status.05.19 == "new/returning")
unclean_bang_current_05.19 = finalized_bang %>% filter(status.05.19 == "current")
unclean_bang_leave_05.19 = finalized_bang %>% filter(status.05.19 == "leaving")
unclean_bang_member_05.19 = finalized_bang %>% filter(status.05.19 != 'no')
unclean_bang_new_06.19 = finalized_bang %>% filter(status.06.19 == "new/returning")
unclean_bang_current_06.19 = finalized_bang %>% filter(status.06.19 == "current")
unclean_bang_leave_06.19 = finalized_bang %>% filter(status.06.19 == "leaving")
unclean_bang_member_06.19 = finalized_bang %>% filter(status.06.19 != 'no')
unclean_bang_new_07.19 = finalized_bang %>% filter(status.07.19 == "new/returning")
unclean_bang_current_07.19 = finalized_bang %>% filter(status.07.19 == "current")
unclean_bang_leave_07.19 = finalized_bang %>% filter(status.07.19 == "leaving")
unclean_bang_member_07.19 = finalized_bang %>% filter(status.07.19 != 'no')
unclean_bang_new_08.19 = finalized_bang %>% filter(status.08.19 == "new/returning")
unclean_bang_current_08.19 = finalized_bang %>% filter(status.08.19 == "current")
unclean_bang_leave_08.19 = finalized_bang %>% filter(status.08.19 == "leaving")
unclean_bang_member_08.19 = finalized_bang %>% filter(status.08.19 != 'no')
unclean_bang_new_09.19 = finalized_bang %>% filter(status.09.19 == "new/returning")
unclean_bang_current_09.19 = finalized_bang %>% filter(status.09.19 == "current")
unclean_bang_leave_09.19 = finalized_bang %>% filter(status.09.19 == "leaving")
unclean_bang_member_09.19 = finalized_bang %>% filter(status.09.19 != 'no')
unclean_bang_new_10.19 = finalized_bang %>% filter(status.10.19 == "new/returning")
unclean_bang_current_10.19 = finalized_bang %>% filter(status.10.19 == "current")
unclean_bang_leave_10.19 = finalized_bang %>% filter(status.10.19 == "leaving")
unclean_bang_member_10.19 = finalized_bang %>% filter(status.10.19 != 'no')
unclean_bang_new_11.19 = finalized_bang %>% filter(status.11.19 == "new/returning")
unclean_bang_current_11.19 = finalized_bang %>% filter(status.11.19 == "current")
unclean_bang_leave_11.19 = finalized_bang %>% filter(status.11.19 == "leaving")
unclean_bang_member_11.19 = finalized_bang %>% filter(status.11.19 != 'no')
unclean_bang_new_12.19 = finalized_bang %>% filter(status.12.19 == "new/returning")
unclean_bang_current_12.19 = finalized_bang %>% filter(status.12.19 == "current")
unclean_bang_leave_12.19 = finalized_bang %>% filter(status.12.19 == "leaving")
unclean_bang_member_12.19 = finalized_bang %>% filter(status.12.19 != 'no')
unclean_bang_new_01.20 = finalized_bang %>% filter(status.01.20 == "new/returning")
unclean_bang_current_01.20 = finalized_bang %>% filter(status.01.20 == "current")
unclean_bang_leave_01.20 = finalized_bang %>% filter(status.01.20 == "leaving")
unclean_bang_member_01.20 = finalized_bang %>% filter(status.01.20 != 'no')
unclean_bang_new_02.20 = finalized_bang %>% filter(status.02.20 == "new/returning")
unclean_bang_current_02.20 = finalized_bang %>% filter(status.02.20 == "current")
unclean_bang_leave_02.20 = finalized_bang %>% filter(status.02.20 == "leaving")
unclean_bang_member_02.20 = finalized_bang %>% filter(status.02.20 != 'no')
unclean_bang_new_03.20 = finalized_bang %>% filter(status.03.20 == "new/returning")
unclean_bang_current_03.20 = finalized_bang %>% filter(status.03.20 == "current")
unclean_bang_leave_03.20 = finalized_bang %>% filter(status.03.20 == "leaving")
unclean_bang_member_03.20 = finalized_bang %>% filter(status.03.20 != 'no')
unclean_bang_new_04.20 = finalized_bang %>% filter(status.04.20 == "new/returning")
unclean_bang_current_04.20 = finalized_bang %>% filter(status.04.20 == "current")
unclean_bang_leave_04.20 = finalized_bang %>% filter(status.04.20 == "leaving")
unclean_bang_member_04.20 = finalized_bang %>% filter(status.04.20 != 'no')
unclean_bang_new_05.20 = finalized_bang %>% filter(status.05.20 == "new/returning")
unclean_bang_current_05.20 = finalized_bang %>% filter(status.05.20 == "current")
unclean_bang_leave_05.20 = finalized_bang %>% filter(status.05.20 == "leaving")
unclean_bang_member_05.20 = finalized_bang %>% filter(status.05.20 != 'no')
unclean_bang_new_06.20 = finalized_bang %>% filter(status.06.20 == "new/returning")
unclean_bang_current_06.20 = finalized_bang %>% filter(status.06.20 == "current")
unclean_bang_leave_06.20 = finalized_bang %>% filter(status.06.20 == "leaving")
unclean_bang_member_06.20 = finalized_bang %>% filter(status.06.20 != 'no')
unclean_bang_new_07.20 = finalized_bang %>% filter(status.07.20 == "new/returning")
unclean_bang_current_07.20 = finalized_bang %>% filter(status.07.20 == "current")
unclean_bang_leave_07.20 = finalized_bang %>% filter(status.07.20 == "leaving")
unclean_bang_member_07.20 = finalized_bang %>% filter(status.07.20 != 'no')
unclean_bang_new_08.20 = finalized_bang %>% filter(status.08.20 == "new/returning")
unclean_bang_current_08.20 = finalized_bang %>% filter(status.08.20 == "current")
unclean_bang_leave_08.20 = finalized_bang %>% filter(status.08.20 == "leaving")
unclean_bang_member_08.20 = finalized_bang %>% filter(status.08.20 != 'no')
unclean_bang_new_09.20 = finalized_bang %>% filter(status.09.20 == "new/returning")
unclean_bang_current_09.20 = finalized_bang %>% filter(status.09.20 == "current")
unclean_bang_leave_09.20 = finalized_bang %>% filter(status.09.20 == "leaving")
unclean_bang_member_09.20 = finalized_bang %>% filter(status.09.20 != 'no')
unclean_bang_new_10.20 = finalized_bang %>% filter(status.10.20 == "new/returning")
unclean_bang_current_10.20 = finalized_bang %>% filter(status.10.20 == "current")
unclean_bang_leave_10.20 = finalized_bang %>% filter(status.10.20 == "leaving")
unclean_bang_member_10.20 = finalized_bang %>% filter(status.10.20 != 'no')

unclean_bang_less.than.100 = finalized_bang %>% filter(monthly_rate_group == '0-99.99')
unclean_bang_100_to_150 = finalized_bang %>% filter(monthly_rate_group == '100-149.99')
unclean_bang_150_to_200 = finalized_bang %>% filter(monthly_rate_group == '150-199.99')
unclean_bang_200_to_250 = finalized_bang %>% filter(monthly_rate_group == '200-249.99')
unclean_bang_250_to_300 = finalized_bang %>% filter(monthly_rate_group == '250-299.99')
unclean_bang_300_to_350 = finalized_bang %>% filter(monthly_rate_group == '300-349.99')
unclean_bang_350_to_400 = finalized_bang %>% filter(monthly_rate_group == '350-399.99')
unclean_bang_400_to_450 = finalized_bang %>% filter(monthly_rate_group == '400-449.99')
unclean_bang_450_to_500 = finalized_bang %>% filter(monthly_rate_group == '450-499.99')
unclean_bang_500_to_550 = finalized_bang %>% filter(monthly_rate_group == '500-549.99')
unclean_bang_550_to_600 = finalized_bang %>% filter(monthly_rate_group == '550-599.99')
unclean_bang_more.than.600 = finalized_bang %>% filter(monthly_rate_group == '600+')

clean_bang_less.than.100 = clean_bang_final %>% filter(monthly_rate_group == '0-99.99')
clean_bang_100_to_150 = clean_bang_final %>% filter(monthly_rate_group == '100-149.99')
clean_bang_150_to_200 = clean_bang_final %>% filter(monthly_rate_group == '150-199.99')
clean_bang_200_to_250 = clean_bang_final %>% filter(monthly_rate_group == '200-249.99')
clean_bang_250_to_300 = clean_bang_final %>% filter(monthly_rate_group == '250-299.99')
clean_bang_300_to_350 = clean_bang_final %>% filter(monthly_rate_group == '300-349.99')
clean_bang_350_to_400 = clean_bang_final %>% filter(monthly_rate_group == '350-399.99')
clean_bang_400_to_450 = clean_bang_final %>% filter(monthly_rate_group == '400-449.99')
clean_bang_450_to_500 = clean_bang_final %>% filter(monthly_rate_group == '450-499.99')
clean_bang_500_to_550 = clean_bang_final %>% filter(monthly_rate_group == '500-549.99')
clean_bang_550_to_600 = clean_bang_final %>% filter(monthly_rate_group == '550-599.99')
clean_bang_more.than.600 = clean_bang_final %>% filter(monthly_rate_group == '600+')

unclean_bang_monthly_0.to.150 = finalized_bang %>% filter(monthly_grouping_ver.1 == '0-149.99')
unclean_bang_monthly_150.to.200 = finalized_bang %>% filter(monthly_grouping_ver.1 == '150-199.99')
unclean_bang_monthly_200.to.300 = finalized_bang %>% filter(monthly_grouping_ver.1 == '200-299.99')
unclean_bang_monthly_300.to.350 = finalized_bang %>% filter(monthly_grouping_ver.1 == '300-349.99')
unclean_bang_monthly_350.to.400 = finalized_bang %>% filter(monthly_grouping_ver.1 == '350-399.99')
unclean_bang_monthly_400.to.450 = finalized_bang %>% filter(monthly_grouping_ver.1 == '400-449.99')
unclean_bang_monthly_450.to.500 = finalized_bang %>% filter(monthly_grouping_ver.1 == '450-499.99')
unclean_bang_monthly_more.than.500 = finalized_bang %>% filter(monthly_grouping_ver.1 == '500+')

clean_bang_monthly_0.to.150 = clean_bang_final %>% filter(monthly_grouping_ver.1 == '0-149.99')
clean_bang_monthly_150.to.200 = clean_bang_final %>% filter(monthly_grouping_ver.1 == '150-199.99')
clean_bang_monthly_200.to.300 = clean_bang_final %>% filter(monthly_grouping_ver.1 == '200-299.99')
clean_bang_monthly_300.to.350 = clean_bang_final %>% filter(monthly_grouping_ver.1 == '300-349.99')
clean_bang_monthly_350.to.400 = clean_bang_final %>% filter(monthly_grouping_ver.1 == '350-399.99')
clean_bang_monthly_400.to.450 = clean_bang_final %>% filter(monthly_grouping_ver.1 == '400-449.99')
clean_bang_monthly_450.to.500 = clean_bang_final %>% filter(monthly_grouping_ver.1 == '450-499.99')
clean_bang_monthly_more.than.500 = clean_bang_final %>% filter(monthly_grouping_ver.1 == '500+')

unclean_bang_monthly_cutoff.yes = finalized_bang %>% filter(monthly_rate_cutoff == "yes")
unclean_bang_monthly_cutoff.no = finalized_bang %>% filter(monthly_rate_cutoff == "no")
clean_bang_monthly_cutoff.yes = clean_bang_final %>% filter(monthly_rate_cutoff == "yes")
clean_bang_monthly_cutoff.no = clean_bang_final %>% filter(monthly_rate_cutoff == "no")



unclean_bang_less.than.50 = finalized_bang %>% filter(attendance_rate_group == '0-9.99' | attendance_rate_group == '10-19.99' | attendance_rate_group == '20-29.99' | attendance_rate_group == '30-39.99' | attendance_rate_group == '40-49.99')
unclean_bang_50_to_60 = finalized_bang %>% filter(attendance_rate_group == '50-59.99')
unclean_bang_60_to_70 = finalized_bang %>% filter(attendance_rate_group == '60-69.99')
unclean_bang_70_to_80 = finalized_bang %>% filter(attendance_rate_group == '70-79.99')
unclean_bang_more.than.80 = finalized_bang %>% filter(attendance_rate_group == '80-89.99' | attendance_rate_group == "90-100")

clean_bang_less.than.50 = clean_bang_final %>% filter(attendance_rate_group == '0-9.99' | attendance_rate_group == '10-19.99' | attendance_rate_group == '20-29.99' | attendance_rate_group == '30-39.99' | attendance_rate_group == '40-49.99')
clean_bang_50_to_60 = clean_bang_final %>% filter(attendance_rate_group == '50-59.99')
clean_bang_60_to_70 = clean_bang_final %>% filter(attendance_rate_group == '60-69.99')
clean_bang_70_to_80 = clean_bang_final %>% filter(attendance_rate_group == '70-79.99')
clean_bang_more.than.80 = clean_bang_final %>% filter(attendance_rate_group == '80-89.99' | attendance_rate_group == "90-100")

unclean_bang_monthly_cutoff.yes = finalized_bang %>% filter(attendance_rate_cutoff == "yes")
unclean_bang_monthly_cutoff.no = finalized_bang %>% filter(attendance_rate_cutoff == "no")
clean_bang_monthly_cutoff.yes = clean_bang_final %>% filter(attendance_rate_cutoff == "yes")
clean_bang_monthly_cutoff.no = clean_bang_final %>% filter(attendance_rate_cutoff == "no")


unclean_bang_longer_retention = finalized_bang %>% 
				  pivot_longer(
					cols = c(retention_3m, retention_6m, retention_12m), 
					names_to = "retention_type",
					values_to = "retention_status"
				)
clean_bang_longer_retention = clean_bang_final %>% 
				pivot_longer(
					cols = c(retention_3m, retention_6m, retention_12m), 
					names_to = "retention_type",
					values_to = "retention_status"
				)
unclean_bang_longer_retention = unclean_bang_longer_retention %>% 
				  mutate(
					retention_type = as.factor(retention_type)
				) %>% 
				  mutate(
					retention_type = factor(retention_type, levels = c('retention_3m', 'retention_6m', 'retention_12m'))
				)
clean_bang_longer_retention = clean_bang_longer_retention %>% 
				mutate(
					retention_type = as.factor(retention_type)
				) %>% 
				mutate(
					retention_type = factor(retention_type, levels = c('retention_3m', 'retention_6m', 'retention_12m'))
				)


unclean_bang_longer_attendance = finalized_bang %>% 
				   pivot_longer(
					cols = c(attendance_rate, cancellation_rate),
					names_to = "type",
					values_to = "rates"
				   )
clean_bang_longer_attendance = clean_bang_final %>% 
				pivot_longer(
					cols = c(attendance_rate, cancellation_rate),
					names_to = "type",
					values_to = "rates"
				)


unclean_bang_longer_num_emails = finalized_bang %>% 
				  pivot_longer(
					cols = c(num_ticket_billing, num_ticket_cx, num_ticket_scheduling, num_ticket_service),
					names_to = "email_type",
					values_to = "email_amount"
				  )
clean_bang_longer_num_emails = clean_bang_final %>% 
				pivot_longer(
					cols = c(num_ticket_billing, num_ticket_cx, num_ticket_scheduling, num_ticket_service),
					names_to = "email_type",
					values_to = "email_amount"
				)


unclean_bang_longer_per_emails = finalized_bang %>% 
				   pivot_longer(
					cols = c(per_ticket_billing, per_ticket_cx, per_ticket_scheduling, per_ticket_service),
					names_to = "email_type",
					values_to = "email_percent"
				   )
clean_bang_longer_per_emails = clean_bang_final %>% 
				pivot_longer(
					cols = c(per_ticket_billing, per_ticket_cx, per_ticket_scheduling, per_ticket_service),
					names_to = "email_type",
					values_to = "email_percent"
				)


unclean_bang_longer_new_per_emails = finalized_bang %>% 
          pivot_longer(
            cols = c(new_per_ticket_cx, new_per_ticket_scheduling, new_per_ticket_service),
            names_to = "email_type",
            values_to = 'email_percent'
          )
clean_bang_longer_new_per_emails = clean_bang_final %>% 
          pivot_longer(
            cols = c(new_per_ticket_cx, new_per_ticket_scheduling, new_per_ticket_service),
            names_to = "email_type",
            values_to = 'email_percent'
          )



unclean_bang_longer_status = finalized_bang %>% 
				pivot_longer(
					cols = c(
							status.01.18, status.02.18, status.03.18, status.04.18, status.05.18, 
							status.06.18, status.07.18, status.08.18, status.09.18, status.10.18, 
							status.11.18, status.12.18, status.01.19, status.02.19, status.03.19, 
							status.04.19, status.05.19, status.06.19, status.07.19, status.08.19, 
							status.09.19, status.10.19, status.11.19, status.12.19, status.01.20, 
							status.02.20, status.03.20, status.04.20, status.05.20, status.06.20, 
							status.07.20, status.08.20, status.09.20, status.10.20
						),
					names_to = "membership_period",
					values_to = "membership_status"
				)
clean_bang_longer_status = clean_bang_final %>% 
				pivot_longer(
					cols = c(
							status.01.18, status.02.18, status.03.18, status.04.18, status.05.18, 
							status.06.18, status.07.18, status.08.18, status.09.18, status.10.18, 
							status.11.18, status.12.18, status.01.19, status.02.19, status.03.19, 
							status.04.19, status.05.19, status.06.19, status.07.19, status.08.19, 
							status.09.19, status.10.19, status.11.19, status.12.19, status.01.20, 
							status.02.20, status.03.20, status.04.20, status.05.20, status.06.20, 
							status.07.20, status.08.20, status.09.20, status.10.20
						),
					names_to = "membership_period",
					values_to = "membership_status"
				)

unclean_bang_longer_status = unclean_bang_longer_status %>% 
				mutate(
					membership_period = factor(membership_period, levels = c("status.01.18", "status.02.18","status.03.18", "status.04.18","status.05.18", "status.06.18",
												 "status.07.18", "status.08.18","status.09.18", "status.10.18","status.11.18", "status.12.18",
												 "status.01.19", "status.02.19","status.03.19", "status.04.19","status.05.19", "status.06.19",
												 "status.07.19", "status.08.19","status.09.19", "status.10.19","status.11.19", "status.12.19",
												 "status.01.20", "status.02.20","status.03.20", "status.04.20","status.05.20", "status.06.20",
												 "status.07.20", "status.08.20","status.09.20", "status.10.20"))
					)

clean_bang_longer_status = clean_bang_longer_status %>% 
				mutate(
					membership_period = factor(membership_period, levels = c("status.01.18", "status.02.18","status.03.18", "status.04.18","status.05.18", "status.06.18",
												 "status.07.18", "status.08.18","status.09.18", "status.10.18","status.11.18", "status.12.18",
												 "status.01.19", "status.02.19","status.03.19", "status.04.19","status.05.19", "status.06.19",
												 "status.07.19", "status.08.19","status.09.19", "status.10.19","status.11.19", "status.12.19",
												 "status.01.20", "status.02.20","status.03.20", "status.04.20","status.05.20", "status.06.20",
												 "status.07.20", "status.08.20","status.09.20", "status.10.20"))
					)

```


(Future Mike Here) I will also be creating a separate data set that will contain only the necessary variable that would be used in formulating models based on our data set. However, knowing that most of these variable will be not normally distributed and this will cause problems down the line, I will also be doing some data transformation in order to be able to build models that meet their own assumptions. 

NOTE: Since I will be log transforming these data, there will be issues with entries of 0 which creates an undefined entry.  A workaround that I've chosen to do is to add a constant that with a magnitude that is small enough as to not influence the overall impact of said variable.  In this case, we will be doing the following: 

* weighted average monthly membership rate will add 0.1, which is the equivalent of $0.10 
* attendance rate will add 0.1, which is the equivalent of 0.1% 
* total non-billing email interactions will add 1, which is the equivalent of 1 email
* percentage of total emails pertaining to CX-/scheduling-/service-related email interactions will add 0.1, which is the equivalent of 0.1%
* number of email-interactions per month will add 0.1, which is the equivalent of 0.1

```{r}

clean_bang_select = clean_bang_final %>% 
			select(id,
				age_group,
				employment_sector,
				current,
				became_former_member,
				churn_type,
				length,
				retention_3m,
				retention_6m,
				retention_12m, 
				revenue_lifetime,
				membership, 
				avg_monthly_rate,
				monthly_rate_group,
				monthly_grouping_ver.1,
				monthly_rate_cutoff,
				num_breaks,
				num_renewals,
				attendance_rate,
				attendance_rate_group,
				attendance_grouping_ver.1,
				attendance_rate_cutoff,
				ever_billing_issue,
				num_billing_issue,
				new_num_total,
				num_emails_month,
				ever_email_month,
				ever_cx,
				new_per_ticket_cx,
				ever_scheduling,
				new_per_ticket_scheduling,
				ever_service,
				new_per_ticket_service	
			)

clean_bang_select = clean_bang_select %>% 
			mutate(
				log_monthly_rate = log(avg_monthly_rate + 0.1),
				log_attendance_rate = log(attendance_rate + 0.1),
				log_new_num_total = log(new_num_total + 1),
				log_new_per_ticket_cx = log(new_per_ticket_cx + 0.1),
				log_new_per_ticket_scheduling = log(new_per_ticket_scheduling + 0.1),
				log_new_per_ticket_service = log(new_per_ticket_service + 0.1),
				num_emails_group = ifelse(new_num_total < 1, 0,
					           ifelse(c(new_num_total >= 1 & new_num_total < 10), 1,
					           ifelse(c(new_num_total >= 10 & new_num_total < 20), 2,
					           ifelse(c(new_num_total >= 20 & new_num_total < 50), 3,
					           ifelse(new_num_total >= 50, 4, NA))))),
				log_num_emails_month = log(num_emails_month + 0.1)
			) %>% mutate (
				num_emails_group = as.factor(num_emails_group)	
			) 

clean_bang_select = clean_bang_select %>% 
        mutate(
				num_emails_group = revalue(num_emails_group, 
							            c("0" = "less than 1",
							              '1' = "1-9",
							              '2' = '10-19',
							              '3' = '20-49',
							              '4' = '50+'))
			) 

clean_bang_select = clean_bang_select %>% 
  mutate(
			  num_emails_month_group = ifelse(num_emails_month < 0.5, '0',
			                           ifelse(c(num_emails_month >= 0.5 & num_emails_month < 1.5), "1",
			                           ifelse(c(num_emails_month >= 1.5 & num_emails_month < 2.5), "2",
			                           ifelse(num_emails_month >= 2.5, "3", NA))))               
			 ) %>% mutate(
			   num_emails_month_group = as.factor(num_emails_month_group)
			 ) %>% mutate(
			   num_emails_month_group = revalue(num_emails_month_group, 
			                                    c("0" = "none", 
			                                      "1" = "1/month", 
			                                      "2" = "2/month", 
			                                      "3" = "3+/month"))
			 ) 

clean_bang_select = clean_bang_select %>% 
			select(
				id, 
				age_group, 
				employment_sector,
				became_former_member,
				churn_type,
				length, 
				retention_3m,
				retention_6m,
				retention_12m,
				revenue_lifetime,
				membership,
				avg_monthly_rate,
				log_monthly_rate,
				monthly_rate_group,
				monthly_grouping_ver.1,
				monthly_rate_cutoff,
				num_breaks,
				num_renewals,
				attendance_rate,
				log_attendance_rate,
				attendance_rate_group,
				attendance_grouping_ver.1,
				attendance_rate_cutoff,
				ever_billing_issue,
				num_billing_issue,
				new_num_total, 
				log_new_num_total,
				num_emails_group,
				ever_email_month,
				num_emails_month,
				num_emails_month_group,
				log_num_emails_month,
				new_num_total,
				ever_cx,
				new_per_ticket_cx,
				log_new_per_ticket_cx,
				ever_scheduling,
				new_per_ticket_scheduling,
				log_new_per_ticket_scheduling,
				ever_service,
				new_per_ticket_service,
				log_new_per_ticket_service
			)

View(clean_bang_select)

```

## **Analysis Plan**

### DESCRIPTIVE STATISTICS 

  Based on the data type, we will use either mean +/- SD or median to summarize the distribution of a given variable. However in the case of non-normal distributed data, we will instead be using median.  This will be displayed on the appropriate medium.  Primarily, we are interested in observing the distribution of demographics (i.e. age + employment sector), attendance rates, number of breaks email correspondence, etc.  In comparing differences b/t groups, Student’s T-test will be used for continuous variable whilst the Pearson’s Chi-Square test will be run for categorical variables with significance cut-off set at p = 0.05. ANOVA will be used for cases where there are more than 3 groups for analyzing differences in continuous variable between groups with the Holm correction for pairwise adjustments.  For instances of non-normal distribution, the Mann-Whitney Tests, Kruskal Wallis test (w. Holm correction) will be used instead. 
  
  
  
### INFERENTIAL STATISTICS
  
  In order to assess the influence of various data gathered on membership churn, I will be looking to use a Cox Regression model in order to gain insight on how these factors play on length of membership prior to leaving.  This will be determined through two methods: (a) random survival forest as well as (b) Cox regressional analysis.  Additionally, the infuence of various predictors on retention status at 3-, 6- and 12-months were also examined through both (a) logisic regression analysis and (b) random forest modelling. The selection of predictors for the linear modelling approach (i.e. Cox-regression + logistic regression) were determined via stepwise regression using AIC as the measure for determining variable retention.  



#                                                                            **RESULTS**

## Overall 

  Looking at the overall number of members over the period of Jan 2018 to Oct 2020, there were 483 members (98 current vs. 385 former).  The majority of our members existed b/t the ages of 30-44 & the 45-64 age group.  Notably, most of the members came from the advertising/media/culture/art, technology/information, professional/technical services and financial/insurance sectors.  The most popular membership types were the 2x/week and 3x/week Hybrid Training memberships.  As it pertained to the length of membership, the median duration is 121 days (i.e. approx. 4 months) with the average monthly membership rate of ~ $350.  The average attendance rate for our members being approximately 60~ish% which isn't surprising as the majority of our former members cited the lack of availability or accessibility as a reason for leaving Bang Personal Training. However, it is important to recognize that the pandemic played a noticeable role in loss of membership as noted by the drop in membership in March 2020. 

```{r}

# PART A: Visualize - Unclean Data

finalized_bang %>% 
				ggplot(aes(x = age_group, fill = age_group)) +
				geom_bar(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(hjust = 0, face = 'bold')
				) + 
				xlab("Age Distribution (in Years)") + 
				ylab("Number of Members") + 
				labs(caption = "Figure1. Distribution of Bang Personal Training Members Across Age Groups") + 
				guides(fill = F) 

finalized_bang %>% 
				ggplot(aes(x = employment_sector, fill = employment_sector)) +
				geom_bar(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					axis.text.x = element_text(angle = 90, hjust = 1),
					plot.caption = element_text(hjust = 0, face = 'bold')
				) + 
				xlab("Employment Sectors") + 
				ylab("Number of Members") + 
				labs(caption = "Figure2. Distribution of Bang Personal Training Members Across Employment Sectors")+
				guides(fill = F) 

finalized_bang %>% 
				ggplot(aes(x = missing_value, fill = missing_value)) +
				geom_bar(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(hjust = 0, face = 'bold')
				) + 
				xlab("Those with Missing Variable") + 
				ylab("Number of Members") + 
				guides(fill = F) +
				labs(caption = "Figure3. Number of Bang Personal Training Members with Unidentified Demographic Variables")

finalized_bang %>% 
			ggplot(aes(x = length)) +
			geom_histogram(color = 'black', bins = 30, fill = 'steelblue2') + 
			theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Length of Bang Membership (in Days)") + 
			ylab("Number of Members") +		
			guides(fill = F) + 
			labs(caption = 'Figure4. Length of Membership for Bang Personal Training Members')

unclean_bang_longer_retention %>% 
			ggplot(aes(x = retention_status, fill = retention_type)) + 
			geom_bar(color = 'black') + 
			theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0)				
			) + 
			facet_wrap(vars(retention_type)) +
			xlab("Retention Status") + 
			ylab('Number of Members') + 
			guides(fill = F) + 
			labs(caption = 'Figure5. Continuous Retention Status for Bang Personal Training Members at 3-Months, 6-Months and 12-Months')

finalized_bang %>% 
			ggplot(aes(x = c(revenue_lifetime))) + 
			geom_histogram(color = 'black', bins = 30, fill = 'burlywood') + 
			theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0)				
			) +
			xlab("Lifetime Revenue (in $1000)") +
			ylab('Number of Members') + 
			guides(fill = F) + 
			labs(caption = 'Figure6. Lifetime Revenue of Bang Personal Training Members')

finalized_bang %>% 
				filter(!is.na(monthly_rate_group)) %>% 
				ggplot(aes(x = monthly_rate_group, fill = monthly_rate_group)) + 
				geom_bar(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					axis.text.x = element_text(angle = 90, color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0)	
				) + 
				xlab("Weighted Avg. Monthly Rate (in $)") +
				ylab("Number of Members") +
				guides(fill = F) +
				labs(caption = "Figure7. Bang Personal Training Members Grouped by Weighted Monthly Rates")

finalized_bang %>% 
			ggplot(aes(x = reason_to_leave, fill = reason_to_leave)) + 
			geom_bar(color = 'black') + 
			theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					axis.text.x = element_text(angle = 90, hjust = 1),
					plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Explanation for Discontinuing Membership") + 
			ylab("Number of Former Members") + 
			guides(fill = F) + 
			labs(caption = 'Figure8. Reasons for Discontinuing Membership Amongst Former Bang Personal Training Members')

finalized_bang %>% 
			ggplot(aes(x = churn_type, fill = churn_type)) + 
			geom_bar(color = 'black') + 
			theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					axis.text.x = element_text(angle = 90, hjust = 1),
					plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Type of Membership Churn") + 
			ylab("Number of Former Members") + 
			guides(fill = F)+ 
			labs(caption = 'Figure9. Churn Type of Former Bang Personal Training Members')

finalized_bang %>% 
			ggplot(aes(x = num_membership_change)) + 
			geom_bar(color = 'black') + 
			theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Number of Changes in Membership Type") + 
			ylab("Number of Members") + 
			guides(fill = F) + 
			labs(caption = 'Figure10. Number of Membership Changes Amongst Bang Personal Training Members')

finalized_bang %>% 
			ggplot(aes(x = num_breaks)) + 
			geom_histogram(color = 'black', fill = 'azure3', bins = 20) + 
			theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Number of Payment Cycle Breaks") +
			ylab("Total Bang Members") + 
			guides(fill = F) + 
			labs(caption = 'Figure11. Number of Payment Cycle Breaks Amongst Bang Personal Training Members')

finalized_bang %>% 
			ggplot(aes(x = num_renewals)) + 
			geom_histogram(color = 'black', fill = 'chartreuse', bins = 30) + 
			theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Number of Membership Renewals (per 66 days)") +
			ylab("Total Bang Members") + 
			guides(fill = F) + 
			labs(caption = 'Figure12. Number of Membership Renewals Amongst Bang Personal Training Members')

finalized_bang %>% 
			filter(!is.na(attendance_rate_group)) %>% 
			ggplot(aes(x = attendance_rate_group, fill = attendance_rate_group)) + 
			geom_bar(color = 'black') + 
			theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					axis.text.x = element_text(angle = 90, hjust = 1),
					plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Attendance Rates (%)") + 
			ylab("Number of Bang Personal Training Members") + 
			labs(caption = "Figure13. Bang Personal Training Members Grouped by Attendance Rate") + 
			guides(fill = F)


finalized_bang %>% 
      ggplot(aes(x = num_emails_month)) + 
      geom_histogram(color = 'black', fill = 'springgreen1', bins = 30) + 
      theme(
        panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0)
      ) + 
      xlab("Number of Non-Billing Email Interactions per month") + 
      ylab("Number of Members") + 
      guides(fill = F) + 
      labs(caption = "Figure14a. Number of Non-Billing Email Interactions Amongst Bang Personal Training Members")

finalized_bang %>% 
      ggplot(aes(x = num_billing_issue, fill = num_billing_issue)) + 
      geom_bar(color = 'black') + 
      theme(
        panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0)
      ) + 
      xlab("Number of Billing-Related Email Interactions") + 
      ylab("Number of Members") + 
      guides(fill = F) + 
      labs(caption = "Figure14b. Number of Billing Email Interactions Amongst Bang Personal Training Members")

unclean_bang_longer_new_per_emails %>% 
			ggplot(aes(x = email_type, y = email_percent, fill = email_type)) + 
			geom_boxplot(color = 'black') + 
			theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Types of Emails") + 
			ylab("Composition of Total Emails (in %)") + 
			guides(fill = F) + 
			labs(caption = 'Figure14c. Percent Composition of Types of Email-Interaction Between Bang Personal Training Members 
			     and Membership Service Staff')

unclean_bang_longer_status %>% 
  mutate(
        summarize_membership_status = ifelse(c(membership_status == "new/returning" | membership_status == "current"), "current member",
                                      ifelse(c(membership_status == "leaving" | membership_status == "new/returning"), "former member",
                                      ifelse(membership_status == "no", "never a member", NA)))
                ) %>% 
  mutate(
        summarize_membership_status = as.factor(summarize_membership_status)
          ) %>% 
  filter(summarize_membership_status != 'never a member') %>% 
  ggplot(aes(x = membership_period, fill = membership_period)) + 
  geom_bar(color = 'black') + 
  theme(
    panel.background = element_rect(fill = 'white'), 
    axis.text.x = element_text(angle = 90, hjust = 1),
    axis.line = element_line(colour = 'black'), 
    plot.caption = element_text(face = 'bold', hjust = 0),
    axis.text = element_text(color = 'black')
  ) +
  guides(fill = F) + 
  ylab("Number of Members") + 
  xlab("Month, Year") + 
  facet_wrap(vars(summarize_membership_status))  +
  labs(caption = "Figure15. Membership Count from January 2018 - October 2020")


```


## Impact of Age, Employment and Membership Type 

(NOTE: Going forward, we will be using the data set **WITHOUT** entries with missing demographic variables)

  Looking further into the distribution of members, there was significant differences observed with respect to Age x Employment Sector and Age x Membership Type. While there were many differences found, it was notable to find that the majority of those within the 30-44 crowd were from the Technology/Information as well as Professional/Technical Services sector whilst those in the 45-64 crowd were the predominant age group within the finance/insurance sector.  Additionally, although the 30-44 crowd were the predominant age group across most membership types, those in the 45-64 crowd were actually the predominant age group for distance coaching.  
  
  Looking at the impact of age, membership and employment sector on attendance rate, we see that attendance rate varied significantly with respect to age and employment sector, employment sector and membership type as well as membership type and age.  Notably we see that:

    * Greater attendance rates among those with 2x/week membership across various age groups relative to other membership types
    * Group membership were predominantly those within the 30-44 age category
    * Those within the Technology/Information sector had the highest attendance rates relative to all other employment sector; the lowest were those within the hospitality/retail/accommodation sector 
    * Across age groups, we see those within the entrepreneurial space having the lowest median attendance rate. 
    * Lowest length were found in the Social Services/Non-Profit + Hospitality/Retail/Accomodation sector across age and membership types 
    * Highest overall across age and membership types were noted amongst those in the Entrepreneural and Tech sector (particularly at age 30-44); interestingly those within the Health Care sector had a very high length of membership for those aged 30-44 
    * As it relates to membership types, 2x/week had the highest length of membership across age + employment sector. 
    
    
```{r}

clean_bang_final %>% 
			ggplot(aes(x = age_group, fill = age_group)) +
			geom_bar(color = 'black') +
			theme(
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line(color = 'black'),
				axis.text = element_text(color = 'black'),
				axis.text.x = element_text(angle = 90, hjust = 1),
				plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Age Distribution") +
			ylab("Number of Members") + 
			facet_wrap(vars(employment_sector)) +
			guides(fill = F) + 
			labs(caption = 'Figure16. Number of Bang Members by Age Group and Employment Sector (χ2 = 251.52, p < 0.001)')

clean_bang_final %>% 
			ggplot(aes(x = age_group, fill = age_group)) +
			geom_bar(color = 'black') +
			theme(
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line(color = 'black'),
				axis.text = element_text(color = 'black'),
				plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Age Distribution") +
			ylab("Number of Members") + 
			facet_wrap(vars(membership)) +
			guides(fill = F) + 
			labs(caption = 'Figure17. Number of Bang Members by Age Group and Membership Type (χ2 = 36.85, p = 0.045)')

clean_bang_final %>% 
			ggplot(aes(x = membership, fill = membership)) +
			geom_bar(color = 'black') +
			theme(
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line(color = 'black'),
				axis.text = element_text(color = 'black'),
				axis.text.x = element_text(angle = 90, hjust = 1),
				plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Membership Type") +
			ylab("Number of Members") + 
			facet_wrap(vars(employment_sector)) +
			guides(fill = F) + 
			labs(caption = 'Figure18. Number of Bang Members by Membership Type and Employment Sector (χ2 = 101.73, p = 0.187)')

clean_bang_final %>%
				ggplot(aes(x = age_group, y = attendance_rate, fill = age_group)) +
				geom_boxplot(color = 'black')+
				theme(				
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line(color = 'black'),
				axis.text = element_text(color = 'black'),
				axis.text.x = element_text(angle = 90, hjust = 1),
				plot.caption = element_text(face = 'bold', hjust = 0),
				strip.text.y = element_text(angle = 0)
				)+
				xlab('Age Group Distribution')+
				ylab("Attendance Rate (in %)") +
				facet_wrap(vars(employment_sector)) +
				guides(fill = F) + 
				labs(caption = 'Figure19. Attendance Rate of Bang Members by Age Groups and Employment Sector')

clean_bang_final %>%
				ggplot(aes(x = membership, y = attendance_rate, fill = membership)) +
				geom_boxplot(color = 'black')+
				theme(				
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line(color = 'black'),
				axis.text = element_text(color = 'black'),
				axis.text.x = element_text(angle = 90, hjust = 1),
				plot.caption = element_text(face = 'bold', hjust = 0),
				strip.text.y = element_text(angle = 0)
				)+
				xlab('Membership Type')+
				ylab("Attendance Rate (in %)") +
				facet_wrap(vars(employment_sector)) +
				guides(fill = F) + 
				labs(caption = 'Figure20. Attendance Rate of Bang Members by Membership Type and Employment Sector')

clean_bang_final %>%
				ggplot(aes(x = age_group, y = attendance_rate, fill = age_group)) +
				geom_boxplot(color = 'black')+
				theme(				
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line(color = 'black'),
				axis.text = element_text(color = 'black'),
				axis.text.x = element_text(angle = 90, hjust = 1),
				plot.caption = element_text(face = 'bold', hjust = 0),
				strip.text.y = element_text(angle = 0)
				)+
				xlab('Age Group Distribution')+
				ylab("Attendance Rate (in %)") +
				facet_wrap(vars(membership)) +
				guides(fill = F) + 
				labs(caption = 'Figure21. Attendance Rate of Bang Members by Age Groups and Membership Type')

clean_bang_final %>%
				ggplot(aes(x = age_group, y = length, fill = age_group)) +
				geom_boxplot(color = 'black')+
				theme(				
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line(color = 'black'),
				axis.text = element_text(color = 'black'),
				axis.text.x = element_text(angle = 90, hjust = 1),
				plot.caption = element_text(face = 'bold', hjust = 0),
				strip.text.y = element_text(angle = 0)
				)+
				xlab('Age Groups')+
				ylab("Length of Bang Membership (in Days)") +
				facet_wrap(vars(employment_sector)) +
				guides(fill = F) + 
				labs(caption = 'Figure22. Length of Membership by Age Groups and Employment Sector')

clean_bang_final %>%
				ggplot(aes(x = membership, y = length, fill = membership)) +
				geom_boxplot(color = 'black')+
				theme(				
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line(color = 'black'),
				axis.text = element_text(color = 'black'),
				axis.text.x = element_text(angle = 90, hjust = 1),
				plot.caption = element_text(face = 'bold', hjust = 0),
				strip.text.y = element_text(angle = 0)
				)+
				xlab('Membership Type')+
				ylab("Length of Bang Membership (in Days)") +
				facet_wrap(vars(employment_sector)) +
				guides(fill = F) + 
				labs(caption = 'Figure23. Length of Membership by Membership Type and Employment Sector')

clean_bang_final %>%
				ggplot(aes(x = age_group, y = length, fill = age_group)) +
				geom_boxplot(color = 'black')+
				theme(				
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line(color = 'black'),
				axis.text = element_text(color = 'black'),
				axis.text.x = element_text(angle = 90, hjust = 1),
				plot.caption = element_text(face = 'bold', hjust = 0),
				strip.text.y = element_text(angle = 0)
				)+
				xlab('Age Group')+
				ylab("Length of Bang Membership (in Days)") +
				facet_wrap(vars(employment_sector)) +
				guides(fill = F) + 
				labs(caption = 'Figure24. Length of Membership by Age Group and Membership Type')

```


## Current vs Former Members 

  It was found that there was roughly and equivalent split of current members across 3 age categories (18-29, 30-44 and 45-64) for the most popular membership type (3x/week) between current and former members.  However, overall, 30-44 was the most predominant age-group.  Consistent with the overall data, the most common sector have been those within the advertisement/art/media/culture sector.  
  
  There were difference in the number of breaks in payment cycle as it was found there was significantly greater number of payment cycle breaks amongst current members than with former members. Additionally, the number of renewals were found to be significantly higher among active members than former members. However, there were no differences with respect to attendance rates or with number of membership changes b/t current and former members. 
  
  As it pertains to weighted average monthly membership rates, there were no difference b/t current and former members. However, once average monthly rates were categorized, it was found that those that a significantly greater proportion of active members have a higher monthly membership rate than former members.   
  
  Looking at email interactions, it was shown that those that are active members were more significantly more likely to have reported ever having a billing-related issue as compared to former members.  Similarly, those that were current members were also found to have significantly greater percentage of their email interaction to be related to scheduling requests as compared to former members.  Interestingly enough, while not statistically significant, those that were former members had a greater number of service-related email interaction as compared to former members. This relationship was also noted with respect to the number of non-billing related email interactions per month as those that were current members reported significantly less email interactions as compared to those that were former members.  
  
```{r}

clean_bang_final %>% 
			ggplot(aes(x = current, fill = current)) + 
			geom_bar(color = 'black') +
			theme(
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line (color = 'black'),
				axis.text = element_text (color = 'black'),
				plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Current Membership Status") + 
			ylab("Number of Members") + 
			labs(caption = "Figure25. Number of Bang Members Based on Membership Status (as of 10-05-2020)") +
			guides(fill = F)

clean_bang_final %>% 
				ggplot(aes(x = current, fill = current)) + 
				geom_bar(color = 'black') +
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
				xlab("Current Membership Status") + 
				ylab("Number of Members") + 
				labs(caption = "Figure26. Membership Status of Bang Personal Training Members by Age and Employment Sector") +
				facet_grid(
					cols = vars(age_group),
					rows = vars(employment_sector)
				) +
				guides(fill = F)

clean_bang_final %>% 
				ggplot(aes(x = current, fill = current)) + 
				geom_bar(color = 'black') +
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
				xlab("Current Membership Status") + 
				ylab("Number of Members") + 
				labs(caption = "Figure27. Membership Status of Bang Personal Training Members by Age and Membership Type") +
				facet_grid(
					cols = vars(age_group),
					rows = vars(membership)
				) +
				guides(fill = F)	

clean_bang_final %>% 
				ggplot(aes(x = current, fill = current)) + 
				geom_bar(color = 'black') +
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					axis.text.x = element_text(angle = 45, hjust = 1),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
				xlab("Current Membership Status") + 
				ylab("Number of Members") + 
				labs(caption = "Figure28. Membership Status of Bang Personal Training Members by Employment Sector and Membership Type") +
				facet_grid(
					cols = vars(membership),
					rows = vars(employment_sector)
				) + 
				guides(fill = F)

shapiro.test(clean_bang_final$num_breaks) # Not a normal distribution 

wilcox.test(num_breaks ~ current, data = clean_bang_final) 
clean_bang_final %>% 
				ggplot(aes(x = current, y = num_breaks, fill = current)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
				xlab("Current Membership Status") + 
				ylab("Length of Bang Membership (in Days)") + 
				labs(caption = "Figure29. Number of Payment Cycle Breaks by Current Membership Status (W = 10640, p < 0.001)") + 
				guides(fill = F)

shapiro.test(clean_bang_final$num_renewals) # Not a normal distribution

wilcox.test(num_renewals ~ current, data = clean_bang_final)
clean_bang_final %>% 
				ggplot(aes(x = num_renewals, fill = current)) +
				geom_histogram(color = 'black', bins = 20) +
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
        facet_wrap(vars(current)) + 
        guides(fill = F) +
				xlab('Number of Membership Renewals (per 66 days)') + 
				ylab('Number of Members') + 
				labs(caption = "Figure30. Number of Membership Renewals by Current Membership Status (W = 10478, p < 0.001)")


shapiro.test(clean_bang_final$num_membership_change) # Not a normal distribution 

wilcox.test(num_membership_change ~ current, data = clean_bang_final)
clean_bang_final %>% 
				ggplot(aes(x =  num_membership_change, fill = current)) + 
				geom_histogram(color = 'black', bins = 20) + 
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
        facet_wrap(vars(current)) + 
        guides(fill = F) +
				xlab("Number of Membership Changes") + 
				ylab('Number of Members') + 
				labs(caption = 'Figure31. Number of Membership Changes by Current Membership Status (W = 15402, p = 0.129)') + 
				guides(fill = F)

shapiro.test(clean_bang_final$attendance_rate)
chisq.test(clean_bang_final$current, clean_bang_final$attendance_grouping_ver.1)

clean_bang_final %>% 
        ggplot(aes(x = attendance_grouping_ver.1, fill = attendance_grouping_ver.1)) + 
        geom_bar(color = 'black') + 
        theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
				xlab("Attendance Rates (in %)") +
        ylab("Number of Members") +
        facet_wrap(vars(current)) +
        labs(caption = "Figure32. Attendance Rate Groupings by Current Membership Status (χ2 = 10.63, p = 0.059)") +
        guides(fill = F)

shapiro.test(clean_bang_final$avg_monthly_rate) # Not a normal distribution 

wilcox.test(avg_monthly_rate ~ current, data = clean_bang_final)
clean_bang_final %>% 
				ggplot(aes(x =  avg_monthly_rate, fill = current)) +
				geom_histogram(color = 'black', bins = 20) +
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
        facet_wrap(vars(current)) + 
				xlab('Weighted Average Monthly Membership Rate (in $)') + 
				ylab('Number of Members') + 
				labs(caption = "Figure33a. Average Monthly Membership Rate by Current Membership Status (W = 15328, p = 0.256)")

chisq.test(clean_bang_final$current, clean_bang_final$monthly_rate_group)
clean_bang_final %>% 
        ggplot(aes(x = monthly_rate_group, fill = monthly_rate_group)) +
        geom_bar(color = 'black') + 
        theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					axis.text.x = element_text(angle = 90, hjust = 1),
					plot.caption = element_text(face = 'bold', hjust = 0)          
        ) + 
        facet_wrap(vars(current)) + 
        xlab("Weighted Average Monthly Membership Rate (in $)") +
        ylab("Number of members") + 
        guides(fill = F) +
        labs(caption = "Figure33b. Average Monthly Membership Rate Groupings by Current Membership Status (χ2 = 21.87, p = 0.025)")


chisq.test(clean_bang_final$num_billing_issue, clean_bang_final$current)
clean_bang_final %>% 
					ggplot(aes(x = num_billing_issue, fill = num_billing_issue)) + 
					geom_bar(color = 'black') + 
					theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0),
					axis.text.x = element_text(angle = 90, hjust = 1)
					) + 
					facet_wrap(vars(current)) +
					guides(fill = F) +
					xlab("Number of Billing Related Email Interactions") + 
					ylab("Number of Members") + 
					labs(caption = "Figure34a. Number of Billing-Related Email Interactions by Current Membership Status (χ2 = 4.75, p = 0.093)")

chisq.test(clean_bang_final$ever_billing_issue, clean_bang_final$current)
clean_bang_final %>% 
					ggplot(aes(x = ever_billing_issue, fill = ever_billing_issue)) + 
					geom_bar(color = 'black') + 
					theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0),
					axis.text.x = element_text(angle = 90, hjust = 1)
					) + 
					facet_wrap(vars(current)) +
					guides(fill = F) +
					xlab("Ever Have a Billing Related Email Interactions") + 
					ylab("Number of Members") + 
					labs(caption = "Figure34b. Status of Ever Having a Billing-Related Email Interaction by Current Membership Status 
					     (χ2 = 3.94, p = 0.047)")


shapiro.test(clean_bang_final$new_per_ticket_cx) # Not normal distribution

wilcox.test(new_per_ticket_cx ~ current, data = clean_bang_final)
clean_bang_final %>% 
				ggplot(aes(x = current, y = new_per_ticket_cx, fill = current)) +
				geom_boxplot(color = 'black') +
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
        guides(fill = F) +
				xlab('Membership Status') + 
				ylab('Percent of Total Email Interactions Relating to CX (in %)') + 
				labs(caption = "Figure35. Percent of CX-Related Email Interactions by Current Membership Status (W = 15993, p = 0.574)")

shapiro.test(clean_bang_final$new_per_ticket_scheduling) # Not normal distribution

wilcox.test(new_per_ticket_scheduling ~ current, data = clean_bang_final)
clean_bang_final %>% 
				ggplot(aes(x = current, y = new_per_ticket_scheduling, fill = current)) +
				geom_boxplot(color = 'black') +
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
        guides(fill = F) +
				xlab('Membership Status') + 
				ylab('Percent of Total Email Interactions Relating to Scheduling (in %)') + 
				labs(caption = "Figure36. Percent of Scheduling-Related Email Interactions by Current Membership Status 
				     (W = 14302, p = 0.037)")

shapiro.test(clean_bang_final$new_per_ticket_service) # Not normal distribution

wilcox.test(new_per_ticket_service ~ current, data = clean_bang_final)
clean_bang_final %>% 
				ggplot(aes(x = current, y = new_per_ticket_service, fill = current)) +
				geom_boxplot(color = 'black') +
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
				xlab('Membership Status') + 
        guides(fill = F) +
				ylab('Percent of Total Email Interactions Relating to Service (in %)') + 
				labs(caption = "Figure37. Percent of Service-Related Email Interactions by Current Membership Status 
				     (W = 18718, p = 0.054)")


shapiro.test(clean_bang_final$new_num_total) # not normally distributed 

wilcox.test(new_num_total ~ current, data = clean_bang_final)
clean_bang_final %>% 
				ggplot(aes(x = current, y = new_num_total, fill = current)) +
				geom_boxplot(color = 'black') +
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
				xlab('Membership Status') + 
        guides(fill = F) +
				ylab('Number of Non-Billing Email Interactions') + 
				labs(caption = "Figure38a. Non-Billing-Related Email Interactions by Current Membership Status
				     (W = 12510, p < 0.001)")


shapiro.test(clean_bang_final$num_emails_month) # not normally distributed 

wilcox.test(num_emails_month ~ current, data = clean_bang_final)
clean_bang_final %>% 
				ggplot(aes(x = current, y = num_emails_month, fill = current)) +
				geom_boxplot(color = 'black') +
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
				xlab('Membership Status') + 
        guides(fill = F) +
				ylab('Number of Non-Billing Email Interactions (per Month)') + 
				labs(caption = "Figure38b. Non-Billing-Related Email Interactions/Month by Current Membership Status
				     (W = 22726, p < 0.001)")


```

  
## Length of Membership

Examining the length of membership across age groups, significantly longer membership length was observed in those aged 30-44 as compared to 18-29.  This difference was also noted in terms of membership types with those with a 2x/week membership had significantly longer membership length as compared to 3x/week.  As it relates to attendance rates, those that attended 70%-79% of the time had significantly longer membership length as compared to those engaging in less than 50% of the time.  

In terms of email interactions, those that reported any billing-related issues were found to have longer membership rates than those without.  Looking at the other types of email interactions, there was a significant correlation with increased percentage of email interaction with length of membership.  In fact this was supported when examining the relationship between total non-billing related email interactions and length of membership. 

Lastly in terms of average monthly rate, those with 350 to 449 per month were found to have significantly longer membership length as compared to all other monthly rates.

```{r}

kruskal.test(length ~ age_group, data = clean_bang_final)
clean_bang_final %>% dunn_test(length ~ age_group, p.adjust.method =  'holm')
clean_bang_final %>% 
			ggplot(aes(x = age_group, y = length, fill = age_group)) + 
			geom_boxplot(color = 'black') +
			theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Age Groups") +
			ylab("Length of Membership at Bang Personal Training (in Days)") + 
			labs(caption = "Figure39. Length of Membership Distributed Across Age Groups (H = 15.06, p = 0.005).  
					Following Pairwise Comparisons, Longer Membership Length Observed Amongst 30-44 
					as compared to 45-64 (Z = 3.86, p = 0.001)") + 
			guides(fill = F)


kruskal.test(length ~ employment_sector, data = clean_bang_final)
clean_bang_final %>% dunn_test(length ~ employment_sector, p.adjust.method =  'holm')
clean_bang_final %>% 
			ggplot(aes(x = employment_sector, y = length, fill = employment_sector)) + 
			geom_boxplot(color = 'black') +
			theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					axis.text.x = element_text(angle = 90, hjust = 1),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Employment Sector") +
			ylab("Length of Membership at Bang Personal Training (in Days)") + 
			labs(caption = "Figure40. Length of Membership Distributed Across 
			Employment Sector (H = 28.53, p = 0.019). There was No Significant Difference 
			Following Pairwise Comparisons") + 
			guides(fill = F)


kruskal.test(length ~ membership, data = clean_bang_final)
clean_bang_final %>% dunn_test(length ~ membership, p.adjust.method =  'holm')
clean_bang_final %>% 
			ggplot(aes(x = membership, y = length, fill = membership)) + 
			geom_boxplot(color = 'black') +
			theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Membership Type") +
			ylab("Length of Membership at Bang Personal Training (in Days)") + 
			labs(caption = "Figure41. Length of Membership Distributed Across Membership Type (H = 19.94, p = 0.003. 
					After Pairwise Adjustment, Longer Membership Length Observed Amongst 2x/Week vs. 3x/Week 
					(Z = 4.07, p = 0.001)") + 
			guides(fill = F)

kruskal.test(length ~ attendance_rate_group, data = clean_bang_final)
dunn_test(length ~ attendance_rate_group, data = clean_bang_final, p.adjust.method = 'holm')
clean_bang_final %>% 
					ggplot(aes(x = attendance_rate_group, y = length, fill = attendance_rate_group)) + 
					geom_boxplot(color = 'black') + 
					theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0),
					axis.text.x = element_text(angle = 90, hjust = 1)
					) + 
					guides(fill = F) +
					xlab("Attendance Rate (in %)") + 
					ylab("Length of Membership at Bang Personal Training (in Days)") + 
					labs(caption = "Figure42a. Length of Membership by Attendance Rate 
					     (H = 40.94, p < 0.001)")

kruskal.test(length ~ attendance_grouping_ver.1, data = clean_bang_final)
dunn_test(length ~ attendance_grouping_ver.1, data = clean_bang_final, p.adjust.method = 'holm')
clean_bang_final %>% 
					ggplot(aes(x = attendance_grouping_ver.1, y = length, fill = attendance_grouping_ver.1)) + 
					geom_boxplot(color = 'black') + 
					theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0),
					axis.text.x = element_text(angle = 90, hjust = 1)
					) + 
					guides(fill = F) +
					xlab("Attendance Rate (in %)") + 
					ylab("Length of Membership at Bang Personal Training (in Days)") + 
					labs(caption = "Figure42b. Length of Membership by Attendance Rate (H = 13.48, p = 0.009). 
							After pairwise adjustments, longer membership duration b/t those with 70%-79.99% attendance rate
							as compared to 0-49.99% (Z = 3.40, p = 0.007)")

kruskal.test(length ~ num_billing_issue, data = clean_bang_final)
dunn_test(length ~ num_billing_issue, data = clean_bang_final, p.adjust.method = 'holm')
clean_bang_final %>% 
					ggplot(aes(x = num_billing_issue, y = length, fill = num_billing_issue)) + 
					geom_boxplot(color = 'black') + 
					theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0),
					axis.text.x = element_text(angle = 90, hjust = 1)
					) + 
					guides(fill = F) +
					xlab("Number of Billing-Related Email Interactions") + 
					ylab("Length of Membership at Bang Personal Training (in Days)") + 
					labs(caption = "Figure43a. Length of Membership by Number of Billing-Related Email Interactions 
					(H = 31.24, p < 0.001). Following Pairwise Comparisons, Greater Membership Lengths 
					Noted for Members with 2 or More such Interactions.")

wilcox.test(length ~ ever_billing_issue, data = clean_bang_final)
clean_bang_final %>% 
					ggplot(aes(x = ever_billing_issue, y = length, fill = ever_billing_issue)) + 
					geom_boxplot(color = 'black') + 
					theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0),
					) + 
					guides(fill = F) +
					xlab("Ever Have a Billing-Related Email Interaction") + 
					ylab("Length of Membership at Bang Personal Training (in Days)") + 
					labs(caption = "Figure43b. Length of Membership by Status of Ever Having a 
					     Billing-Related Issue (W = 13570, p < 0.001)")


cor.test(x = clean_bang_final$new_per_ticket_cx, y = clean_bang_final$length, method = 'spearman')
clean_bang_final %>% 
				ggplot(aes(x = new_per_ticket_cx, y = length)) + 
				geom_point(color = 'black', size = 1) + 
				geom_smooth(method = 'gam') +
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
				xlab("Percent of Total Email Interaction Relating to CX (in %)") + 
				ylab("Length of Membership at Bang Personal Training (in Days)") +
				labs(caption = "Figure44. Length of Membership By Percentage of Email Interactions Relating to CX 
				     (ρ = 0.241, p < 0.001)")

cor.test(x = clean_bang_final$new_per_ticket_scheduling, y = clean_bang_final$length, method = 'spearman')
clean_bang_final %>% 
				ggplot(aes(x = new_per_ticket_scheduling, y = length)) + 
				geom_point(color = 'black', size = 1) + 
				geom_smooth(method = 'gam') +
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
				xlab("Percent of Total Email Interaction Relating to Scheduling (in %)") + 
				ylab("Length of Membership at Bang Personal Training (in Days)") +
				labs(caption = "Figure45. Length of Membership By Percentage of Email Interactions 
				     Relating to Scheduling (ρ = 0.487, p < 0.001)")

cor.test(x = clean_bang_final$new_per_ticket_service, y = clean_bang_final$length, method = 'spearman')
clean_bang_final %>% 
				ggplot(aes(x = new_per_ticket_service, y = length)) + 
				geom_point(color = 'black', size = 1) + 
				geom_smooth(method = 'gam') +
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
				xlab("Percent of Total Email Interaction Relating to Service (in %)") + 
				ylab("Length of Membership at Bang Personal Training (in Days)") +
				labs(caption = "Figure46. Length of Membership By Percentage of Email Interactions Relating to Service 
				     (ρ = -0.476, p < 0.001)")

cor.test(x = clean_bang_final$new_num_total, y = clean_bang_final$length, method = 'spearman')
clean_bang_final %>% 
        ggplot(aes(x = new_num_total, y = length)) + 
        geom_point(color = 'black', size = 1) +
        geom_smooth(method = 'gam') + 
        theme(
          panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0)
        ) + 
        xlab("Number of Total Email Interactions") + 
        ylab("Length of Membership at Bang Personal Training (in Days)") + 
        labs(caption = 'Figure47a. Length of Membership by Total Number of Non-Billing Emails 
             (ρ = 0.781, p < 0.001)')

cor.test(x = clean_bang_final$num_emails_month, y = clean_bang_final$length, method = 'spearman')
clean_bang_final %>% 
        ggplot(aes(x = new_num_total, y = length)) + 
        geom_point(color = 'black', size = 1) +
        geom_smooth(method = 'gam') + 
        theme(
          panel.background = element_rect(fill = 'white'),
					axis.line = element_line(color = 'black'),
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0)
        ) + 
        xlab("Number of Total Email Interactions") + 
        ylab("Length of Membership at Bang Personal Training (in Days)") + 
        labs(caption = 'Figure47b. Length of Membership by Total Number of Non-Billing Email Interactions per Month 
             (ρ = -0.564, p < 0.001)')

kruskal.test(length ~ monthly_grouping_ver.1, data = clean_bang_final)
dunn_test(length ~ monthly_grouping_ver.1, data = clean_bang_final, p.adjust.method = 'holm')
clean_bang_final %>% 
					ggplot(aes(x = monthly_grouping_ver.1, y = length, fill = monthly_grouping_ver.1)) + 
					geom_boxplot(color = 'black') + 
					theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0),
					axis.text.x = element_text(angle = 90, hjust = 1)
					) + 
					guides(fill = F) +
					xlab("Attendance Rate (in %)") + 
					ylab("Length of Membership at Bang Personal Training (in Days)") + 
					labs(caption = "Figure48. Length of Membership by Monthly Membership Rate (H = 71.33, p < 0.001)") 


```

## Retention Status at 3-Months, 6-Months and 12-Months 

  Looking at membership retention across the three time points, it was found that the rates of retention are 54.6% at 3 months, 46.8% at 6 months and 33.8% at 12 months.  Notably it was found that retention status significantly differed between employment sectors at 3 and 6 months.  This difference was also noted with respect to membership types as well.  It was also found that those that had a higher attendance rate also were more likely to have remained a member at Bang.  This relationship appeared to not have changed across all three time point. Similarly, there were also significant differences with respect to average monthly membership rates with greater retention rates across all time points with those with 350/month to 399/month as a membership rate.
  
  Looking at the impact of email interactions, those that had continued their membership reported more billing-related email interactions than those that did not.  Further look into the other types of email interactions, there were greater percentage of CX and scheduling-related email interactions amongst those that had maintained their membership at Bang Personal Training at each time point.  However, there was a significantly lower percentage of service-related email interactions amongst those that had maintained their membership as compared to those that did not. Overall, those that retained their Bang Personal Training membership were found to have greater email interactions than those that did not across all time points. However, there is a lower number of email interaction per month amongst those that retained their membership, which was evident across all time points. 
  
```{r}

clean_bang_final %>% 
			ggplot(aes(x = retention_3m, fill = age_group)) +
			geom_bar(color = 'black') + 
			theme(
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line(color = 'black'),
				axis.text = element_text(color = 'black'), 
				plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Retention Status at 3-Months") +
			ylab("Number of Members") + 
			facet_wrap(vars(age_group)) +
			guides(fill = F) + 
			labs(caption = 'Figure49. Continuous Membership Retention at 3-Months Across Age Groups 
			     (χ2 = 8.28, p = 0.082)') 

clean_bang_final %>% 
			ggplot(aes(x = retention_6m, fill = age_group)) +
			geom_bar(color = 'black') + 
			theme(
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line(color = 'black'),
				axis.text = element_text(color = 'black'), 
				plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Retention Status at 6-Months") +
			ylab("Number of Members") + 
			facet_wrap(vars(age_group)) +
			guides(fill = F) + 
			labs(caption = 'Figure50. Continuous Membership Retention at 6-Months Across Age Groups 
			     (χ2 = 8.47, p = 0.076)')

clean_bang_final %>% 
			ggplot(aes(x = retention_12m, fill = age_group)) +
			geom_bar(color = 'black') + 
			theme(
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line(color = 'black'),
				axis.text = element_text(color = 'black'), 
				plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Retention Status at 12-Months") +
			ylab("Number of Members") + 
			facet_wrap(vars(age_group)) +
			guides(fill = F) + 
			labs(caption = 'Figure51. Continuous Membership Retention at 12-Months Across Age Groups 
			     (χ2 = 7.92, p = 0.094)') 


clean_bang_final %>% 
			ggplot(aes(x = retention_3m, fill = employment_sector)) +
			geom_bar(color = 'black') + 
			theme(
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line(color = 'black'),
				axis.text = element_text(color = 'black'), 
				plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Retention Status at 3-Months") +
			ylab("Number of Members") + 
			facet_wrap(vars(employment_sector)) +
			guides(fill = F) + 
			labs(caption = 'Figure52. Continuous Membership Retention at 3-Months Across Employment Sectors 
			     (χ2 = 29.48, p = 0.014)') 

clean_bang_final %>% 
			ggplot(aes(x = retention_6m, fill = employment_sector)) +
			geom_bar(color = 'black') + 
			theme(
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line(color = 'black'),
				axis.text = element_text(color = 'black'), 
				plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Retention Status at 6-Months") +
			ylab("Number of Members") + 
			facet_wrap(vars(employment_sector)) +
			guides(fill = F) + 
			labs(caption = 'Figure53. Continuous Membership Retention at 6-Months Across Employment Sectors
			     (χ2 = 27.14, p = 0.028)') 

clean_bang_final %>% 
			ggplot(aes(x = retention_12m, fill = employment_sector)) +
			geom_bar(color = 'black') + 
			theme(
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line(color = 'black'),
				axis.text = element_text(color = 'black'), 
				plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Retention Status at 12-Months") +
			ylab("Number of Members") + 
			facet_wrap(vars(employment_sector)) +
			guides(fill = F) + 
			labs(caption = 'Figure54. Continuous Membership Retention at 12-Months Across Employment Sectors 
			     (χ2 = 22.96, p = 0.085)') 


clean_bang_final %>% 
			ggplot(aes(x = retention_3m, fill = membership)) +
			geom_bar(color = 'black') + 
			theme(
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line(color = 'black'),
				axis.text = element_text(color = 'black'), 
				plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Retention Status at 3-Months") +
			ylab("Number of Members") + 
			facet_wrap(vars(membership)) +
			guides(fill = F) + 
			labs(caption = 'Figure55. Continuous Membership Retention at 3-Months Across Membership Types 
			     (χ2 = 16.99, p = 0.009)') 

clean_bang_final %>% 
			ggplot(aes(x = retention_6m, fill = membership)) +
			geom_bar(color = 'black') + 
			theme(
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line(color = 'black'),
				axis.text = element_text(color = 'black'), 
				plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Retention Status at 6-Months") +
			ylab("Number of Members") + 
			facet_wrap(vars(membership)) +
			guides(fill = F) + 
			labs(caption = 'Figure56. Continuous Membership Retention at 6-Months Across Membership Types 
			     (χ2 = 18.40, p = 0.005)') 

clean_bang_final %>% 
			ggplot(aes(x = retention_12m, fill = membership)) +
			geom_bar(color = 'black') + 
			theme(
				panel.background = element_rect(fill = 'white'),
				axis.line = element_line(color = 'black'),
				axis.text = element_text(color = 'black'), 
				plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Retention Status at 12-Months") +
			ylab("Number of Members") + 
			facet_wrap(vars(membership)) +
			guides(fill = F) + 
			labs(caption = 'Figure57. Continuous Membership Retention at 12-Months Across Membership Types 
			     (χ2 = 22.02, p = 0.001)') 

clean_bang_final %>% wilcox_test(attendance_rate ~ retention_3m) %>% add_significance()
clean_bang_final %>% wilcox_test(attendance_rate ~ retention_6m) %>% add_significance()
clean_bang_final %>% wilcox_test(attendance_rate ~ retention_12m) %>% add_significance()

kruskal.test(attendance_rate[retention_status == "yes"] ~ retention_type[retention_status == "yes"], data = clean_bang_longer_retention)
dunnTest(attendance_rate[retention_status == "yes"] ~ retention_type[retention_status == "yes"], data = clean_bang_longer_retention, method = 'holm')

clean_bang_final %>% 
				ggplot(aes(x = retention_3m ,y = attendance_rate, fill = retention_3m)) + 
				geom_boxplot(color = 'black') +
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0) 
				) + 
				xlab("Retention Status at 3-Months") +
				ylab("Attendance Rate (in %)") + 
				labs(caption = 'Figure58. Attendance Rate of Bang Personal Training Members by 3-Month Membership Retention Status 
				     (W = 20526, p = 0.002)') +
				guides(fill = F)

clean_bang_final %>% 
				ggplot(aes(x = retention_6m ,y = attendance_rate, fill = retention_6m)) + 
				geom_boxplot(color = 'black') +
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0) 
				) + 
				xlab("Retention Status at 6-Months") +
				ylab("Attendance Rate (in %)") + 
				labs(caption = 'Figure59. Attendance Rate of Bang Personal Training Members by 6-Month Membership Retention Status
				     (W = 20674, p = 0.002)') +
				guides(fill = F) 

clean_bang_final %>% 
				ggplot(aes(x = retention_12m ,y = attendance_rate, fill = retention_12m)) + 
				geom_boxplot(color = 'black') +
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0) 
				) + 
				xlab("Retention Status at 12-Months") +
				ylab("Attendance Rate (in %)") + 
				labs(caption = 'Figure60. Attendance Rate of Bang Personal Training Members by 12-Month Membership Retention Status 
				     (W = 18576, p = 0.003)') +
				guides(fill = F)

clean_bang_longer_retention %>% 
				ggplot(aes(x = retention_status, y = attendance_rate, fill = retention_status)) +
				geom_boxplot(color = 'black') +
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.text = element_text(color = 'black'), 
					axis.line = element_line(color = 'black')
				) + 
				facet_wrap(vars(retention_type)) +
				guides(fill = F) + 
				xlab("Retention Status") + 
				ylab("Attendance Rate (in %)") + 
				labs(caption = "Figure61. Attendance Rate by Continuous Retention Status of Bang Personal Training Members Across 3-, 6- and 12-Months 
				     (H = 0.443, p = 0.801)")


chisq.test(clean_bang_final$monthly_rate_group, clean_bang_final$retention_3m)
clean_bang_final %>%
					ggplot(aes(x = retention_3m, fill = retention_3m)) + 
					geom_bar(color = 'black') + 
					theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0), 
					axis.text.x = element_text(angle = 90, hjust = 1)
					) + 
					facet_wrap(vars(monthly_rate_group)) +
					guides(fill = F) +
					xlab("Retention Status (at 3-Months)") + 
					ylab("Number of Members") + 
					labs(caption = "Figure62. Retention Status of Bang Personal Training Members at 3-Months by Attendance Rate 
					     (χ2 = 61.45, p <0.001)")


chisq.test(clean_bang_final$monthly_rate_group, clean_bang_final$retention_6m)
clean_bang_final %>%
					ggplot(aes(x = retention_6m, fill = retention_6m)) + 
					geom_bar(color = 'black') + 
					theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0), 
					axis.text.x = element_text(angle = 90, hjust = 1)
					) + 
					facet_wrap(vars(monthly_rate_group)) +
					guides(fill = F) +
					xlab("Retention Status (at 6-Months)") + 
					ylab("Number of Members") + 
					labs(caption = "Figure63. Retention Status of Bang Personal Training Members at 6-Months by Attendance Rate 
					     (χ2 = 58.15, p < 0.001)")

chisq.test(clean_bang_final$monthly_rate_group, clean_bang_final$retention_12m)
clean_bang_final %>%
					ggplot(aes(x = retention_12m, fill = retention_12m)) + 
					geom_bar(color = 'black') + 
					theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0), 
					axis.text.x = element_text(angle = 90, hjust = 1)
					) + 
					facet_wrap(vars(monthly_rate_group)) +
					guides(fill = F) +
					xlab("Retention Status (at 12-Months)") + 
					ylab("Number of Members") + 
					labs(caption = "Figure64. Retention Status of Bang Personal Training Members at 12-Months by Attendance Rate 
					     (χ2 = 57.04, p < 0.001)")

clean_bang_longer_retention %>% 
				ggplot(aes(x = retention_status,  fill = retention_status)) +
				geom_bar(color = 'black') +
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.text = element_text(color = 'black'), 
					axis.line = element_line(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0),
					strip.text.y = element_text(angle = 0)		
				) + 
				facet_grid(
					cols = vars(retention_type),
					rows = vars(monthly_rate_group)
				) +
				guides(fill = F) + 
				xlab("Retention Status") + 
				ylab("Number of Members") + 
				labs(caption = "Figure65. Continuous Retention Status of Bang Personal Training Members 
				     Across 3-, 6- and 12-Months by Monthly Membership Rates.")


chisq.test(clean_bang_final$retention_3m, clean_bang_final$num_billing_issue)
chisq.test(clean_bang_final$retention_6m, clean_bang_final$num_billing_issue)
chisq.test(clean_bang_final$retention_12m, clean_bang_final$num_billing_issue)

clean_bang_final %>% 
  ggplot(aes(x = retention_3m, fill = retention_3m)) + 
  geom_bar(color = 'black') + 
  theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0)     
  ) + 
  guides(fill = F) + 
  facet_wrap(vars(num_billing_issue)) +
  xlab("Retention Status at 3-Months") + 
  ylab("Number of members") + 
  labs(caption = "Figure66. Continuous Retention Status at 3 months by Number of Billing Issue 
       (χ2 = 22.24, p < 0.001)")

clean_bang_final %>% 
  ggplot(aes(x = retention_6m, fill = retention_6m)) + 
  geom_bar(color = 'black') + 
  theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0)     
  ) + 
  guides(fill = F) + 
  facet_wrap(vars(num_billing_issue)) +
  xlab("Retention Status at 6-Months") + 
  ylab("Number of members") + 
  labs(caption = "Figure67. Continuous Retention Status at 6 months by Number of Billing Issue
       (χ2 = 26.07, p < 0.001)")

clean_bang_final %>% 
  ggplot(aes(x = retention_12m, fill = retention_12m)) + 
  geom_bar(color = 'black') + 
  theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0)     
  ) + 
  guides(fill = F) + 
  facet_wrap(vars(num_billing_issue)) +
  xlab("Retention Status at 12-Months") + 
  ylab("Number of members") + 
  labs(caption = "Figure68. Continuous Retention Status at 12 months by Number of Billing Issue 
       (χ2 = 29.34, p < 0.001)")




clean_bang_final %>% wilcox_test(new_per_ticket_cx ~ retention_3m) %>% add_significance()
clean_bang_final %>% wilcox_test(new_per_ticket_cx ~ retention_6m) %>% add_significance()
clean_bang_final %>% wilcox_test(new_per_ticket_cx ~ retention_12m) %>% add_significance()
kruskal.test(new_per_ticket_cx[retention_status == "yes"] ~ retention_type[retention_status == "yes"], data = clean_bang_longer_retention)
dunnTest(new_per_ticket_cx[retention_status == "yes"] ~ retention_type[retention_status == "yes"], data = clean_bang_longer_retention, method = 'holm')

clean_bang_final %>% 
				ggplot(aes(x = retention_3m, y = new_per_ticket_cx, fill = retention_3m)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0) 
				) + 
				guides(fill = F) +
				xlab("Retention Status at 3-Months") +
				ylab("Percent of Total Email Interaction Relating to CX (in %)") + 
				labs(caption = 'Figure69. Continuous Retention Status at 3-Months of Bang Personal Training Members By 
				     Percentage of Email Interactions Relating to CX (W = 19284.5, p < 0.001)')

clean_bang_final %>% 
				ggplot(aes(x = retention_6m, y = new_per_ticket_cx, fill = retention_6m)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0) 
				) + 
				guides(fill = F) +
				xlab("Retention Status at 6-Months") +
				ylab("Percent of Total Email Interaction Relating to CX (in %)") + 
				labs(caption = 'Figure70. Continuous Retention Status at 6-Months of Bang Personal Training Members By 
				     Percentage of Email Interactions Relating to CX (W = 19388, p < 0.001)')

clean_bang_final %>% 
				ggplot(aes(x = retention_12m, y = new_per_ticket_cx, fill = retention_12m)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0) 
				) + 
				guides(fill = F) +
				xlab("Retention Status at 12-Months") +
				ylab("Percent of Total Email Interaction Relating to CX (in %)") + 
				labs(caption = 'Figure71. Continuous Retention Status at 12-Months of Bang Personal Training Members 
				     By Percentage of Email Interactions Relating to CX (W = 16706.5, p < 0.001)')

clean_bang_longer_retention %>% 
	ggplot(aes(x = retention_status, y = new_per_ticket_cx, fill = retention_status)) +
	geom_boxplot(color = 'black') +
	theme(
		panel.background = element_rect(fill = 'white'), 
		axis.text = element_text(color = 'black'), 
		axis.line = element_line(color = 'black')
	) + 
	facet_wrap(vars(retention_type)) +
	guides(fill = F) + 
	xlab("Retention Status") + 
	ylab("Percentage of CX-Related Email Interactions") + 
	labs(caption = "Figure72. Percentage of Email Interactions Relating to CX 
	     by Continuous Retention Status of Bang Personal Training Members Across 3-, 6- and 12-Months 
	     (H = 0.956, p = 0.602)")



clean_bang_final %>% wilcox_test(new_per_ticket_scheduling ~ retention_3m) %>% add_significance()
clean_bang_final %>% wilcox_test(new_per_ticket_scheduling ~ retention_6m) %>% add_significance()
clean_bang_final %>% wilcox_test(new_per_ticket_scheduling ~ retention_12m) %>% add_significance()
kruskal.test(new_per_ticket_scheduling[retention_status == "yes"] ~ retention_type[retention_status == "yes"], data = clean_bang_longer_retention)
dunnTest(new_per_ticket_scheduling[retention_status == "yes"] ~ retention_type[retention_status == "yes"], data = clean_bang_longer_retention, method = 'holm')

clean_bang_final %>% 
				ggplot(aes(x = retention_3m, y = new_per_ticket_scheduling, fill = retention_3m)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0) 
				) + 
				guides(fill = F) +
				xlab("Retention Status at 3-Months") +
				ylab("Percent of Total Email Interaction Relating to Scheduling (in %)") + 
				labs(caption = 'Figure73. Continuous Retention Status at 3-Months of Bang Personal Training Members By 
				     Percentage of Email Interactions Relating to Scheduling (W = 13837, p < 0.001)')

clean_bang_final %>% 
				ggplot(aes(x = retention_6m, y = new_per_ticket_scheduling, fill = retention_6m)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0) 
				) + 
				guides(fill = F) +
				xlab("Retention Status at 6-Months") +
				ylab("Percent of Total Email Interaction Relating to Scheduling (in %)") + 
				labs(caption = 'Figure74. Continuous Retention Status at 6-Months of Bang Personal Training Members By 
				     Percentage of Email Interactions Relating to Scheduling (W = 12520.5, p < 0.001)')

clean_bang_final %>% 
				ggplot(aes(x = retention_12m, y = new_per_ticket_scheduling, fill = retention_12m)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0) 
				) + 
				guides(fill = F) +
				xlab("Retention Status at 12-Months") +
				ylab("Percent of Total Email Interaction Relating to Scheduling (in %)") + 
				labs(caption = 'Figure75. Continuous Retention Status at 12-Months of Bang Personal Training Members By 
				     Percentage of Email Interactions Relating to Scheduling (W = 9877, p < 0.001)')

clean_bang_longer_retention %>% 
	ggplot(aes(x = retention_status, y = new_per_ticket_scheduling, fill = retention_status)) +
	geom_boxplot(color = 'black') +
	theme(
		panel.background = element_rect(fill = 'white'), 
		axis.text = element_text(color = 'black'), 
		axis.line = element_line(color = 'black')
	) + 
	facet_wrap(vars(retention_type)) +
	guides(fill = F) + 
	xlab("Retention Status") + 
	ylab("Percentage of Scheduling-Related Email Interactions") + 
	labs(caption = "Figure76. Percentage of Email Interactions Relating to Scheduling by Continuous Retention Status of Bang Personal Training Members 
	Across Retention Status 3-, 6- and 12-Months (H = 8.46, p = 0.015). 
	Following Pairwise Comparisons, Greater Proportion of Scheduling-Related Email Interactions Observed Amongst Members that 
	Retain Membership at 12-Months than at 3-Months (Z = 2.91, p = 0.011)")



clean_bang_final %>% wilcox_test(new_per_ticket_service ~ retention_3m) %>% add_significance()
clean_bang_final %>% wilcox_test(new_per_ticket_service ~ retention_6m) %>% add_significance()
clean_bang_final %>% wilcox_test(new_per_ticket_service ~ retention_12m) %>% add_significance()
kruskal.test(new_per_ticket_service[retention_status == "yes"] ~ retention_type[retention_status == "yes"], data = clean_bang_longer_retention)
dunnTest(new_per_ticket_service[retention_status == "yes"] ~ retention_type[retention_status == "yes"], data = clean_bang_longer_retention, method = 'holm')


clean_bang_final %>% 
				ggplot(aes(x = retention_3m, y = new_per_ticket_service, fill = retention_3m)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0) 
				) + 
				guides(fill = F) +
				xlab("Retention Status at 3-Months") +
				ylab("Percent of Total Email Interaction Relating to Scheduling (in %)") + 
				labs(caption = 'Figure77. Continuous Retention Status at 3-Months of Bang Personal Training Members 
				     By Percentage of Email Interactions Relating to Scheduling (W = 35410.5, p < 0.001)')

clean_bang_final %>% 
				ggplot(aes(x = retention_6m, y = new_per_ticket_service, fill = retention_6m)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0) 
				) + 
				guides(fill = F) +
				xlab("Retention Status at 6-Months") +
				ylab("Percent of Total Email Interaction Relating to Scheduling (in %)") + 
				labs(caption = 'Figure78. Continuous Retention Status at 6-Months of Bang Personal Training Members 
				     By Percentage of Email Interactions Relating to Scheduling (W = 36710.5, p < 0.001)')

clean_bang_final %>% 
				ggplot(aes(x = retention_12m, y = new_per_ticket_service, fill = retention_12m)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0) 
				) + 
				guides(fill = F) +
				xlab("Retention Status at 12-Months") +
				ylab("Percent of Total Email Interaction Relating to Scheduling (in %)") + 
				labs(caption = 'Figure79. Continuous Retention Status at 12-Months of Bang Personal Training Members 
				     By Percentage of Email Interactions Relating to Scheduling (W = 34179.5, p < 0.001)')

clean_bang_longer_retention %>% 
	ggplot(aes(x = retention_status, y = new_per_ticket_service, fill = retention_status)) +
	geom_boxplot(color = 'black') +
	theme(
		panel.background = element_rect(fill = 'white'), 
		axis.text = element_text(color = 'black'), 
		axis.line = element_line(color = 'black')
	) + 
	facet_wrap(vars(retention_type)) +
	guides(fill = F) + 
	xlab("Retention Status") + 
	ylab("Percentage of Scheduling-Related Email Interactions") + 
	labs(caption = "Figure80. Percentage of Email Interactions Relating to Service by 
	Continuous Retention Status of Bang Personal Training Members Across Retention Status 3-, 6- and 12-Months (H = 7.34, p = 0.025). 
	Following Pairwise Comparisons, Greater Proportion of Service-Related Email Interactions Observed Amongst 
	Members that Retain Membership at 3-Months than at 12-Months (Z = - 2.71 , p = 0.020)")




clean_bang_final %>% wilcox_test(new_num_total ~ retention_3m) %>% add_significance()
clean_bang_final %>% wilcox_test(new_num_total ~ retention_6m) %>% add_significance()
clean_bang_final %>% wilcox_test(new_num_total ~ retention_12m) %>% add_significance()
kruskal.test(new_num_total[retention_status == "yes"] ~ retention_type[retention_status == "yes"], data = clean_bang_longer_retention)
dunnTest(new_num_total[retention_status == "yes"] ~ retention_type[retention_status == "yes"], data = clean_bang_longer_retention, method = 'holm')


clean_bang_final %>% wilcox_test(num_emails_month ~ retention_3m) %>% add_significance()
clean_bang_final %>% wilcox_test(num_emails_month ~ retention_6m) %>% add_significance() 
clean_bang_final %>% wilcox_test(num_emails_month ~ retention_12m) %>% add_significance() 
kruskal.test(num_emails_month[retention_status == "yes"] ~ retention_type[retention_status == "yes"], data = clean_bang_longer_retention)
dunnTest(num_emails_month[retention_status == "yes"] ~ retention_type[retention_status == "yes"], data = clean_bang_longer_retention, method = 'holm') 



clean_bang_final %>% 
				ggplot(aes(x = retention_3m, y = new_num_total, fill = retention_3m)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0) 
				) + 
				guides(fill = F) +
				xlab("Retention Status at 3-Months") +
				ylab("Total Number of Email Interaction") + 
				labs(caption = 'Figure81a. Continuous Retention Status at 3-Months of Bang Personal Training Members 
				     By Total Number of Non-Billing Email Interactions (W = 6059, p < 0.001)')

clean_bang_final %>% 
				ggplot(aes(x = retention_3m, y = num_emails_month, fill = retention_3m)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0) 
				) + 
				guides(fill = F) +
				xlab("Retention Status at 3-Months") +
				ylab("Total Number of Email Interaction") + 
				labs(caption = 'Figure81b. Continuous Retention Status at 3-Months of Bang Personal Training Members 
				     By Number of Non-Billing Email Interactions per Month (W = 40874, p < 0.001)')



clean_bang_final %>% 
				ggplot(aes(x = retention_6m, y = new_num_total, fill = retention_6m)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0) 
				) + 
				guides(fill = F) +
				xlab("Retention Status at 6-Months") +
				ylab("Total Number of Email Interaction") + 
				labs(caption = 'Figure82a. Continuous Retention Status at 6-Months of Bang Personal Training Members 
				     By Total Number of Non-Billing Email Interactions (W = 4900.5, p < 0.001)')

clean_bang_final %>% 
				ggplot(aes(x = retention_6m, y = num_emails_month, fill = retention_6m)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0) 
				) + 
				guides(fill = F) +
				xlab("Retention Status at 6-Months") +
				ylab("Number of Email Interactions (per Month)") + 
				labs(caption = 'Figure82b. Continuous Retention Status at 6-Months of Bang Personal Training Members 
				     By Number of Non-Billing Email Interactions per Month (W = 40174, p < 0.001)')



clean_bang_final %>% 
				ggplot(aes(x = retention_12m, y = new_num_total, fill = retention_12m)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0) 
				) + 
				guides(fill = F) +
				xlab("Retention Status at 12-Months") +
				ylab("Total Number of Email Interaction") + 
				labs(caption = 'Figure83a. Continuous Retention Status at 12-Months of Bang Personal Training Members 
				     By Total Number of Non-Billing Email Interactions (W = 3364, p < 0.001)')

clean_bang_final %>% 
				ggplot(aes(x = retention_12m, y = num_emails_month, fill = retention_12m)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'), 
					axis.line = element_line(color = 'black'), 
					axis.text = element_text(color = 'black'),
					plot.caption = element_text(face = 'bold', hjust = 0) 
				) + 
				guides(fill = F) +
				xlab("Retention Status at 12-Months") +
				ylab("Number of Email Interaction (per Month)") + 
				labs(caption = 'Figure83b. Continuous Retention Status at 12-Months of Bang Personal Training Members 
				     By Number of Non-Billing Email Interactions (w = 32838, p < 0.001)')



clean_bang_longer_retention %>% 
	ggplot(aes(x = retention_status, new_num_total, fill = retention_status)) +
	geom_boxplot(color = 'black') +
	theme(
		panel.background = element_rect(fill = 'white'), 
		axis.text = element_text(color = 'black'), 
		axis.line = element_line(color = 'black')
	) + 
	facet_wrap(vars(retention_type)) +
	guides(fill = F) + 
	xlab("Retention Status") + 
	ylab("Total Number of Email Interactions") + 
	labs(caption = "Figure84a. Number ofNon-Billing Email Interactions by 
	     Continuous Retention Status of Bang Personal Training Members Across Retention Status 3-, 6- and 12-Months 
	     (H = 21.33, p < 0.001).")

clean_bang_longer_retention %>% 
	ggplot(aes(x = retention_status, num_emails_month, fill = retention_status)) +
	geom_boxplot(color = 'black') +
	theme(
		panel.background = element_rect(fill = 'white'), 
		axis.text = element_text(color = 'black'), 
		axis.line = element_line(color = 'black')
	) + 
	facet_wrap(vars(retention_type)) +
	guides(fill = F) + 
	xlab("Retention Status") + 
	ylab("Number of Email Interactions (per Month)") + 
	labs(caption = "Figure84b. Number of Non-Billing Email Interactions per Month by 
	     Continuous Retention Status of Bang Personal Training Members Across Retention Status 3-, 6- and 12-Months (H = 0.152, p = 0.927).")


```
  
  
## Reason to Leave 

  Examining past members, it was found that there were significant differences in rationale for leaving Bang Personal Training across age groups and membership types.  Whilst lack of accessibility or availability in schedule was the most commonly cited reason amongst those aged 30-44, financial cost of the membership was found to join this rationale as the most commonly cited reason for those aged 45-64.  However for those aged 18-29, time-based arrangement was commonly cited as the most prevalent reason to leave Bang Personal Training.  In terms of membership types, those that were in the popular 3x/week membership were found to have left due to lack of availability or accessibility to use the membership.  Although this was the most commonly cited reason, those that were in the 2x/week membership also cited moving away or desire to pursue other fitness interest for discontinuing membership. Interestingly enough, those with group memberships predominantly left due to the 2020 Pandemic.  

  Significant differences in citing reasons to discontinue membership were also noted across various attendance rates and average monthly rates. Notably, those that often cite financial cost or a time-based arrangement as a reason to discontinue membership tend to have the highest attendance rate. On the otherhand, those that had ghosted us or had cited lack of accessibility or availability tend to attend their appointments less than 50% of the time. As it relates to monthly membership rates, those citing lacking accessibility/availability tend to have higher membership rates compared to other cited reasons. Lastly, examining email interactions, it was found that there were significant differences with respect to both various types of email interactions.  
  
```{r}

former_bang %>% 
			ggplot(aes(x = age_group, fill = age_group)) + 
			geom_bar(color = 'black') +
			theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					axis.text.x = element_text(angle = 90, hjust = 1),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Age Groups") +
			ylab("Number of Members") +
			facet_wrap(vars(reason_to_leave)) +  
			labs(caption = "Figure85. Reasons for Discontinuing Membership by Former Bang Personal Training Members Distributed Across Age Groups 
			     (χ2 = 58.25, p = 0.031)") + 
			guides(fill = F) 

former_bang %>% 
			ggplot(aes(x = employment_sector, fill = employment_sector)) + 
			geom_bar(color = 'black') +
			theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					axis.text.x = element_text (angle = 90),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Employment Sector") +
			ylab("Number of Members") +
			facet_wrap(vars(reason_to_leave)) +  
			labs(caption = "Figure86. Reasons for Discontinuing Membership by Former Bang Personal Training Members Distributed Across Employment Sector 
			     (χ2 = 170.04, p = 0.126)") +
			guides(fill = F)

former_bang %>% 
			ggplot(aes(x = membership, fill = membership)) + 
			geom_bar(color = 'black') +
			theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					strip.text.y = element_text(angle = 0),
					axis.text.x = element_text (angle = 90),
					plot.caption = element_text(face = 'bold', hjust = 0)
			) + 
			xlab("Membership Types") +
			ylab("Number of Members") +
			facet_wrap(vars(reason_to_leave)) +  
			labs(caption = "Figure87. Reasons for Discontinuing Membership by Former Bang Personal Training Members Distributed Across Membership Types 
			     (χ2 = 87.41, p = 0.012)") + 
			guides(fill = F)

former_bang %>% 
				ggplot(aes(x = attendance_grouping_ver.1, fill = attendance_grouping_ver.1)) + 
				geom_bar(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					axis.text.x = element_text (angle = 90, hjust = 1),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)					
				) + 
				facet_wrap(vars(reason_to_leave)) +
 				xlab("Attendance Rate (in %)") +
				ylab("Number of Members") + 
				guides(fill = F) +
				labs(caption = "Figure88. Attendance Rate of Former Bang Personal Training Members by Reasons to Discontinue Membership 
				     (χ2 = 90.12, p < 0.001)")

former_bang %>% 
				ggplot(aes(x = monthly_rate_group, fill = monthly_rate_group)) + 
				geom_bar(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					axis.text.x = element_text (angle = 90, hjust = 1),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)					
				) + 
				facet_wrap(vars(reason_to_leave)) +
 				xlab("Weighted Average Monthly Rate (in $)") +
				ylab("Number of Members") + 
				guides(fill = F) +
				labs(caption = "Figure89. Average Monthly Rate of Former Bang Personal Training Members by Reasons to Discontinue Membership 
				     (χ2 = 140.11, p < 0.028)")

former_bang %>% 
				ggplot(aes(x = num_billing_issue, fill = num_billing_issue)) + 
				geom_bar(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					axis.text.x = element_text (angle = 90, hjust = 1),
					strip.text.y = element_text(angle = 0),
					plot.caption = element_text(face = 'bold', hjust = 0)	
				) + 
				facet_wrap(vars(reason_to_leave)) +
 				xlab("Number of Billing-Related Email Interactions") +
				ylab("Number of Members") + 
				guides(fill = F) +
				labs(caption = "Figure90. Number of Email Interactions Relating to Billing by Former Bang Personal Training Members by 
				     Reasons to Discontinue Membership (χ2 = 49.80, p < 0.001)")

kruskal.test(new_per_ticket_cx ~ reason_to_leave, data = former_bang)
dunn_test(new_per_ticket_cx ~ reason_to_leave, data = former_bang, p.adjust.method = 'holm')
former_bang %>% 
				ggplot(aes(x = reason_to_leave, y = new_per_ticket_cx, fill = reason_to_leave)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					axis.text.x = element_text (angle = 90),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
				xlab("Reasons to Discontinue Membership") +
				ylab("Percent of Total Email Interaction Relating to CX (in %)") + 
				labs(caption = "Figure91. Percentage of Email Interactions Relating to CX by Former Bang Personal Training Members by Reasons to Discontinue Membership 
				     (W = 19.63, p = 0.032). Pairwise comparisons saw signicant lower percentage of CX-related Email Interactions between those that left Bang 
				     due to financial cost and those that left as a result of moving away (Z = 3.36, p = 0.043) ") +
				guides(fill = F)

kruskal.test(new_per_ticket_scheduling ~ reason_to_leave, data = former_bang)
dunn_test(new_per_ticket_scheduling ~ reason_to_leave, data = former_bang, p.adjust.method = 'holm')
former_bang %>% 
				ggplot(aes(x = reason_to_leave, y = new_per_ticket_scheduling, fill = reason_to_leave)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					axis.text.x = element_text (angle = 90),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
				xlab("Reasons to Discontinue Membership") +
				ylab("Percent of Total Email Interaction Relating to Scheduling (in %)") + 
				labs(caption = "Figure92. Percentage of Email Interactions Relating to Scheduling by Former Bang Personal Training Members by Reasons to 
				     Discontinue Membership (W = 32.77, p < 0.001)") +
				guides(fill = F)

kruskal.test(new_per_ticket_service ~ reason_to_leave, data = former_bang)
dunn_test(new_per_ticket_service ~ reason_to_leave, data = former_bang, p.adjust.method = 'holm')
former_bang %>% 
				ggplot(aes(x = reason_to_leave, y = new_per_ticket_service, fill = reason_to_leave)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					axis.text.x = element_text (angle = 90),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
				xlab("Reasons to Discontinue Membership") +
				ylab("Percent of Total Email Interaction Relating to Service (in %)") + 
				labs(caption = "Figure93. Percentage of Email Interactions Relating to Service by Former Bang Personal Training Members by Reasons to 
				     Discontinue Membership (W = 20.45, p = 0.025)") +
				guides(fill = F)

kruskal.test(new_num_total ~ reason_to_leave, data = former_bang)
dunn_test(new_num_total ~ reason_to_leave, data = former_bang, p.adjust.method = 'holm')
former_bang %>% 
				ggplot(aes(x = reason_to_leave, y = new_num_total, fill = reason_to_leave)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					axis.text.x = element_text (angle = 90),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
				xlab("Reasons to Discontinue Membership") +
				ylab("Total Non-Billing-Related Email Interactions") + 
				labs(caption = "Figure94a. Total Number of Non-Billing-Related Email Interactions Relating to Service by Former Bang Personal Training Members 
				     by Reasons to Discontinue Membership (W = 58.12, p < 0.001)") +
				guides(fill = F)


kruskal.test(num_emails_month ~ reason_to_leave, data = former_bang)
dunn_test(num_emails_month ~ reason_to_leave, data = former_bang, p.adjust.method = 'holm')
former_bang %>% 
				ggplot(aes(x = reason_to_leave, y = num_emails_month, fill = reason_to_leave)) + 
				geom_boxplot(color = 'black') + 
				theme(
					panel.background = element_rect(fill = 'white'),
					axis.line = element_line (color = 'black'),
					axis.text = element_text (color = 'black'),
					axis.text.x = element_text (angle = 90),
					plot.caption = element_text(face = 'bold', hjust = 0)
				) + 
				xlab("Reasons to Discontinue Membership") +
				ylab("Non-Billing-Related Email Interactions (per Month)") + 
				labs(caption = "Figure95b. Number of Non-Billing-Related Email Interactions per Month Relating to Service by Former Bang Personal Training Members by 
				Reasons to Discontinue Membership (W = 31.53, p < 0.001).  Following pairwise comparisons, lacked availability reporing more email interactions than those that moved away 
				(Z = - 3.31, p = 0.049), along with those that had 'ghosted us' with more email interactions than those that moved away (Z = -3.80, p = 0.008), 
				and those that had left due to the Pandemic (Z = -3.61, p = 0.016)") +
				guides(fill = F)

```
  
## Modelling Length of Bang Personal Training Membership 

  Examining the length of membership of members, it was found to range from as low as 2 days to as much as 3790 days with the median duration length being around 4.5 months. Based on the kaplan meier curves, it was suspected that age, employment sector, membership, attendance rate, average monthly rate and number of billing issues. 
  
```{r, fig.height= 10}

ggsurvplot(
			fit = survfit(Surv(length, became_former_member) ~ 1, data = clean_bang_select),
			xlab = "Time (in Days)",
			ylab = "Probability of Remaining a Member of Bang Personal Training",
			legend = 'none',
			surv.median.line = 'hv',
			caption = "Figure96. Kaplan-Meier Estimates of Length of Membership"
			)

ggsurvplot(
	fit = survfit(Surv(length, became_former_member) ~ age_group, data = clean_bang_select),
	xlab = "Time (in Days)",
	ylab = "Probability of Remaining a Member of Bang Personal Training",
	legend = 'none',
	legend.title = 'Age Groups',
	legend.labs = c("Under 18", "18-29", "30-44", "45-64", "65+"),
	caption = "Figure97. Kaplan-Meier Estimates of Length of Membership across Age Groups"
	) + 
	theme_survminer(
		font.caption = c(12, 'bold', 'black')
	)

ggsurvplot(
	fit = survfit(Surv(length, became_former_member) ~ employment_sector, data = clean_bang_select),
	xlab = "Time (in Days)",
	ylab = "Probability of Remaining a Member of Bang Personal Training",
	legend = 'none',
	legend.title = 'Employment Sector',
	legend.labs = c("Other", "Advertising/Media", "Entrepreneur", "Finance/Insurance",
			"Government/Legal", "Health Care", "Hospitality/Retail", "Manufacturing/Trade",
			"Natural Resource/Energy", "Professional/Technical Services", "Real Estate/Construction",
			"Science/Academic", "Social Services", "Student", "Technology", "Transportation"),
	caption = "Figure98. Kaplan-Meier Estimates of Length of Membership across Employment Sectors"
	) + 
	theme_survminer(
		font.caption = c(12, 'bold', 'black')
	)
		
	ggsurvplot(
	fit = survfit(Surv(length, became_former_member) ~ membership, data = clean_bang_select),
	xlab = "Time (in Days)",
	ylab = "Probability of Remaining a Member of Bang Personal Training",
	legend = 'none',
	legend.title = 'membership',
	legend.labs = c("1x", "2x", "3x", "4x", "unlimited", "group", "distance"),
	caption = "Figure99. Kaplan-Meier Estimates of Length of Membership Across Membership Types"
	) + 
	theme_survminer(
		font.caption = c(12, 'bold', 'black')
	)
	
	ggsurvplot(
	fit = survfit(Surv(length, became_former_member) ~ attendance_grouping_ver.1, data = clean_bang_select),
	xlab = "Time (in Days)",
	ylab = "Probability of Remaining a Member of Bang Personal Training",
	legend = 'none',
	legend.title = 'membership',
	legend.labs = c("0-49.99", "50-59.99", "60-69.99", "70-79.99", "80-89.99", "90-100"),
	caption = "Figure100. Kaplan-Meier Estimates of Length of Membership Across Attendance Groupings"
	) + 
	theme_survminer(
		font.caption = c(12, 'bold', 'black')
	)
	
	ggsurvplot(
	fit = survfit(Surv(length, became_former_member) ~ monthly_rate_group, data = clean_bang_select),
	xlab = "Time (in Days)",
	ylab = "Probability of Remaining a Member of Bang Personal Training",
	legend = 'none',
	legend.title = 'Average Monthly Rate',
	legend.labs = c('0-99.99', '100-149.99', '150-199.99', '200-249.99', '250-299.99', '300-349.99', '350-399.99', '400-449.99', '450-499.99', '500-549.99', '550-599.99', '600+'),
	caption = "Figure101. Kaplan-Meier Estimates of Length of Membership Across Weighted Averages of Monthly Membership Rates"
	) + 
	theme_survminer(
		font.caption = c(12, 'bold', 'black')
	)

ggsurvplot(
	fit = survfit(Surv(length, became_former_member) ~ num_billing_issue, data = clean_bang_select),
	xlab = "Time (in Days)",
	ylab = "Probability of Remaining a Member of Bang Personal Training",
	legend = 'none',
	legend.title = 'Number of Billing-Related Emails',
	legend.labs = c('no billing issue', 'one billing issue', 'two or more billing issue'),
	caption = "Figure102. Kaplan-Meier Estimates of Length of Membership Across Number of Billing-Related Email Interactions"
	) + 
	theme_survminer(
		font.caption = c(12, 'bold', 'black')
	)

```
  
Seeing as I would like to gain some insight on how certain variable in our data set would play a role in predicting length of membership, this would in effect be performing a survival analysis.  As such, I would be approaching this through two means: one is through Random Survival Forest (data science~y way) and the other is through the Cox Regression Proportional Hazard model.  For the second case, as there will be assumptions that needs to be satisfied in order for the model to be "valid", several tests will need to be conducted to ensure this (as noted in this [YouTube Video](https://www.youtube.com/watch?v=QAgtZKpKj9M&ab_channel=MarinStatsLectures-RProgramming%26Statistics)).  As such, there will likely be the use of log-transformation or categorization of certain numeric variables that will be included into this model.  

NOTE: For reference: random survival forest was modelled similarly as shown [here](https://www.youtube.com/watch?v=LsCUXzAxDXw&ab_channel=VamsidharAmbatipudi)

### CHURN ANALYSIS - RANDOM SURVIVAL FOREST  
  
  In developing the Random Survival Forest, I'll need the dataset to only include variables that I would like to be tested to explain outcomes from happening.  Thus a separate dataset will need to be created that contains only the variables that are of interest to us to determine churn outcomes.  This will include: 
* age_group 
* employment_sector
* became_former_member (necessary for censoring)
* length (necessary as dependent variable)
* membership 
* monthly_rate_group
* attendance_grouping_ver.1
* num_emails_month
* ever_emails_month
* ever_billing_issue
* new_per_ticket_cx
* ever_cx
* new_per_ticket_scheduling
* ever_scheduling
* new_per_ticket_service
* ever_service

  Using the random survival forest specific dataset, I've split the data set 80:20 with respect to training:test.  In forming the training model, which has an error rate of **16.95%**, it was found that the error rate in predicting membership length to churn with the test data was **17.59%** (NOTE: this would be equivalent to the C-index via 1 - error rate, so 0.8241), so overall an OK model.  Looking at the various ways to modify the parameters, it was found that the error rate more-or-less stabilized after 1000 trees as evident by the marginal differences in error rates at the higher number of trees. Similarly, findings were found with respect to mtry with the largest being between 7 and the default of 3.  
  
  Examining the importance of all of the testable predictors in impacting the outcome of predicting churn, it was found that the **number of non-billing email interactions per month** played the largest role, followed by ever having a CX-related email interaction, percent composition of scheduling-related email interaction, ever having a scheduling-related email interaction, percent composition of CX-related email interaction and percent composition of service-related email interaction.  The rest plays a minimal importance.  It is important to note that neither has a negative impact on membership churn. Notably, the degree of importance appears to hold regardless of the method of computing variable importance. Interestingly, looking at all of the possible combination of interactions of variables, doesn't appear to be one.   


```{r}

# STEP 1: Create a RSF-specific dataset 

clean_bang_rsf = clean_bang_select %>% 
                    select(
                      age_group,
                      employment_sector,
                      became_former_member,
                      length, 
                      membership, 
                      avg_monthly_rate, 
                      attendance_grouping_ver.1,
                      ever_email_month,
                      num_emails_month,
                      ever_billing_issue, 
                      ever_cx,
                      new_per_ticket_cx,
                      ever_scheduling,
                      new_per_ticket_scheduling,
                      ever_service,
                      new_per_ticket_service
                    )

View(clean_bang_rsf)

# STEP 2: Partition the data set into training data & testing data

training.index.rsf = createDataPartition(clean_bang_rsf$length, p = 0.8, list = FALSE)
clean_bang_rsf.train = clean_bang_rsf[training.index.rsf,]
clean_bang_rsf.test = clean_bang_rsf[-training.index.rsf,]

# STEP 3: Formulate the training model + modify parameters 

# modify the number of trees
train.model.base = rfsrc(Surv(length, became_former_member) ~ ., data = clean_bang_rsf.train, ntree = 500, splitrule = "logrank", importance = TRUE)
train.model = rfsrc(Surv(length, became_former_member) ~ ., data = clean_bang_rsf.train, ntree = 1000, splitrule = "logrank", importance = TRUE)
train.model.1 = rfsrc(Surv(length, became_former_member) ~ ., data = clean_bang_rsf.train, ntree = 2000, splitrule = "logrank", importance = TRUE)
train.model.2 = rfsrc(Surv(length, became_former_member) ~ ., data = clean_bang_rsf.train, ntree = 3000, splitrule = "logrank", importance = TRUE)
train.model.3 = rfsrc(Surv(length, became_former_member) ~ ., data = clean_bang_rsf.train, ntree = 4000, splitrule = "logrank", importance = TRUE)

train.model.base  # 287 membership churn out of a possible 358 occured in this dataset (~ 80.2%); err.rate = 16.34%
train.model       # 287 membership churn out of a possible 358 occured in this dataset (~ 80.2%); err.rate = 16.06%
train.model.1     # 287 membership churn out of a possible 358 occured in this dataset (~ 80.2%); err.rate = 16.20%  
train.model.2     # 287 membership churn out of a possible 358 occured in this dataset (~ 80.2%); err.rate = 16.26%
train.model.3     # 287 membership churn out of a possible 358 occured in this dataset (~ 80.2%); err.rate = 16.16%

plot(train.model.base)
plot(train.model) 
plot(train.model.1) 
plot(train.model.2) 
plot(train.model.3) 

# modify mtry 
train.model.a = rfsrc(Surv(length, became_former_member) ~ ., data = clean_bang_rsf.train, ntree = 2000, splitrule = "logrank", importance = TRUE, mtry = 1)
train.model.b = rfsrc(Surv(length, became_former_member) ~ ., data = clean_bang_rsf.train, ntree = 2000, splitrule = "logrank", importance = TRUE, mtry = 2)
train.model.c = rfsrc(Surv(length, became_former_member) ~ ., data = clean_bang_rsf.train, ntree = 2000, splitrule = "logrank", importance = TRUE, mtry = 3)
train.model.d = rfsrc(Surv(length, became_former_member) ~ ., data = clean_bang_rsf.train, ntree = 2000, splitrule = "logrank", importance = TRUE, mtry = 4)
train.model.e = rfsrc(Surv(length, became_former_member) ~ ., data = clean_bang_rsf.train, ntree = 2000, splitrule = "logrank", importance = TRUE, mtry = 5)
train.model.f = rfsrc(Surv(length, became_former_member) ~ ., data = clean_bang_rsf.train, ntree = 2000, splitrule = "logrank", importance = TRUE, mtry = 6)
train.model.g = rfsrc(Surv(length, became_former_member) ~ ., data = clean_bang_rsf.train, ntree = 2000, splitrule = "logrank", importance = TRUE, mtry = 7)
train.model.h = rfsrc(Surv(length, became_former_member) ~ ., data = clean_bang_rsf.train, ntree = 2000, splitrule = "logrank", importance = TRUE, mtry = 8)
train.model.i = rfsrc(Surv(length, became_former_member) ~ ., data = clean_bang_rsf.train, ntree = 2000, splitrule = "logrank", importance = TRUE, mtry = 9)
train.model.j = rfsrc(Surv(length, became_former_member) ~ ., data = clean_bang_rsf.train, ntree = 2000, splitrule = "logrank", importance = TRUE, mtry = 10)

train.model.a    # 287 membership churn out of a possible 358 occured in this dataset (~ 80.2%); err.rate =  19.56%
train.model.b    # 287 membership churn out of a possible 358 occured in this dataset (~ 80.2%); err.rate =  17.51%
train.model.c    # 287 membership churn out of a possible 358 occured in this dataset (~ 80.2%); err.rate =  16.52%
train.model.d    # 287 membership churn out of a possible 358 occured in this dataset (~ 80.2%); err.rate =  16.24%
train.model.e    # 287 membership churn out of a possible 358 occured in this dataset (~ 80.2%); err.rate =  16.03%
train.model.f    # 287 membership churn out of a possible 358 occured in this dataset (~ 80.2%); err.rate =  16.08%
train.model.g    # 287 membership churn out of a possible 358 occured in this dataset (~ 80.2%); err.rate =  16.11%
train.model.h    # 287 membership churn out of a possible 358 occured in this dataset (~ 80.2%); err.rate =  15.95%
train.model.i    # 287 membership churn out of a possible 358 occured in this dataset (~ 80.2%); err.rate =  16.06%
train.model.j    # 287 membership churn out of a possible 358 occured in this dataset (~ 80.2%); err.rate =  16.08%


train.model.proposed = rfsrc(Surv(length, became_former_member) ~ ., data = clean_bang_rsf.train, ntree = 2000, splitrule = "logrank", importance = TRUE, mtry = 7)
train.model.proposed     # 287 membership churn out of a possible 358 occured in this dataset (~ 80.2%); err.rate = 16.95%

# STEP 4: Determining the important variables within the forest model 

vimp(train.model, importance = "permute")$importance 
vimp(train.model, importance = "random")$importance

vimp(train.model.proposed, importance = 'permute')$importance
vimp(train.model.proposed, importance = 'random')$importance

plot(gg_vimp(train.model.proposed)) # Top Predictors = num_emails_month, ever_cx, new_per_ticket_scheduling, ever_scheduling, new_per_ticket_cx, new_per_ticket_service

var.select(train.model.proposed, method = 'md') # Top predictors: num_emails_month > new_per_ticket_scheduling > new_per_ticket_service > ever_cx > new_per_ticket_cx
max.model.3 <- max.subtree(train.model.proposed)
max.model.3$topvars # Top predictors: num_emails_month, ever_cx, new_per_ticket_scheduling, avg_monthly_rate, new_per_ticket_service, new_per_ticket_cx

train.model.proposed.ver1 = rfsrc(Surv(length, became_former_member) ~ num_emails_month + 
                                    new_per_ticket_scheduling + 
                                    new_per_ticket_service + 
                                    ever_cx + 
                                    new_per_ticket_cx,
                                    data = clean_bang_rsf.train, ntree = 2000, mtry = 7, splitrule = 'logrank', importance = TRUE)

train.model.proposed.ver1 # 287 membership churn out of a possible 358 occured in this dataset (~ 80.2%); err.rate = 16.88%



# STEP 5: Explore any potential interaction effects that may exist within the model 

find.interaction(train.model.proposed, nvar = 10, method = 'vimp') 
plot(gg_interaction(train.model.proposed))  

# Higher values indicate lower interactivity with target variable marked in red. Overall, there doesn't seem to be an interactive effect found 


# STEP 6: Evaluate the performance of the training model with test data set and compare

pred_churn = predict(train.model.proposed, clean_bang_rsf.test, outcome = 'test')
pred_churn # Out of 89 individuals, 66 were found to have reported to have churn.  However in terms of the model predicting outcomes, there was an error rate of 17.59%

pred_churn.a = predict(train.model.proposed.ver1, clean_bang_rsf.test, outcome = 'test')
pred_churn.a # out of 89 individuals, 66 found to have reported to churn membership. However in terms of model predicting outcomes, there was an error rate of 17.28%

plot(gg_rfsrc(pred_churn, by = "attendance_grouping_ver.1")) +
  labs(y = "Membership Survival (%)", x = "Number of Days") + 
  coord_cartesian(ylim = c(-0.01, 1.01)) + 
  theme_bw() + 
  labs(caption = "Predicted Length of Membership Retention by Attendance Rates")
  
plot(gg_rfsrc(pred_churn, by = "age_group")) +
  labs(y = "Membership Survival (%)", x = "Number of Days") + 
  coord_cartesian(ylim = c(-0.01, 1.01)) + 
  theme_bw() + 
  labs(caption = "Predicted Length of Membership Retention by Age")

plot(gg_rfsrc(pred_churn, by = "employment_sector")) +
  labs(y = "Membership Survival (%)", x = "Number of Days") + 
  coord_cartesian(ylim = c(-0.01, 1.01)) + 
  theme_bw() + 
  labs(caption = "Predicted Length of Membership Retention by Employment Sector")

plot(gg_rfsrc(pred_churn, by = "ever_email_month")) +
  labs(y = "Membership Survival (%)", x = "Number of Days") + 
  coord_cartesian(ylim = c(-0.01, 1.01)) + 
  theme_bw() + 
  labs(caption = "Predicted Length of Membership Retention by Ever Having an Email Interactions per Month")

plot(gg_rfsrc(pred_churn, by = "ever_cx")) +
  labs(y = "Membership Survival (%)", x = "Number of Days") + 
  coord_cartesian(ylim = c(-0.01, 1.01)) + 
  theme_bw() + 
  labs(caption = "Predicted Length of Membership Retention by Ever Having a CX-Related Email Interactions per Month")

plot(gg_rfsrc(pred_churn, by = "ever_scheduling")) +
  labs(y = "Membership Survival (%)", x = "Number of Days") + 
  coord_cartesian(ylim = c(-0.01, 1.01)) + 
  theme_bw() + 
  labs(caption = "Predicted Length of Membership Retention by Ever Having a Scheduling-Related Email Interactions per Month")

plot(gg_rfsrc(pred_churn, by = "ever_service")) +
  labs(y = "Membership Survival (%)", x = "Number of Days") + 
  coord_cartesian(ylim = c(-0.01, 1.01)) + 
  theme_bw() + 
  labs(caption = "Predicted Length of Membership Retention by Ever Having a Service-Related Email Interactions per Month")


```

### CHURN ANALYSIS : COX-REGRESSION PROPORTIONAL HAZARD MODEL

Through a bi-directional Stepwise Regression to determine retained predictors of membership length before membership loss through a training dataset partitioning (80%),
it was found that the variables that were retained were: 

(a) number of non-billing related email interactions per month 
(b) ever having a non-billing related email interaction 
(c) percent composition of email interactions relating to scheduling 
(d) percent composition of email interactions relating to CX
(e) ever having a CX-related email interaction  
(f) attendance rate
(g) age 
(h) weighted average monthly membership rate 
(i) ever having a billing-related email interaction  
(j) ever having a scheduling-related email interaction  

However, this model failed to meet either the assumptions of proportionlity or non-linearity.  The model met assumption following the removal of (i) ever having a billing-related email interaction, (ii) weighted average monthly membership rate, (iii) number of non-billing email interactions per month, along with the stratification by age groups. This new proposed model was found to have an error rate of 22.55% (C-statistic = 0.7745). Using this model to predict outcomes with the test data, it was found that the error rate was 22.44% (C-statistic = 0.7766). Overall, the model appears to be decent. 
  
  
  In observing the impact of each of these predictors with the entire data set, it was found that: 

* Compared to those that attended less than 50% of their possible allowance, those that attended 50%-59% of the time had a 0.551 times the change in odds of leaving whilst those that attended 70%-89% of the time had a 0.570 times change in the odds of leaving. 

* Those that had ever had an email interaction in a given month were found to have a **6.28** times the change in odds of leaving as compared to those that had not had an email interaction in a given month.

* While there was no significant impact with respect to those that did have an scheduling-related email interaction as compared to those that did not, there appears to be a 0.985 times the change in odds of leaving for those that had a 1 factor increase in the percent composition of scheduling-related email interactions. 

* Lastly with respect to those that had a 1 factor increase in the percent composition of CX-related email interactions, there was also a 1.03 times the change in odds of leaving. However, there was a large reduction in odds of leaving amongst those that ever had a CX-related email interaction as compared to those that did not. 

```{r}


# STEP 1: Partition data set to a training + testing data set 

training.index.cox = createDataPartition(clean_bang_select$length, p = 0.8, list = FALSE) 
clean_bang_cox.train = clean_bang_select[training.index.cox,] 
clean_bang_cox.test = clean_bang_select[-training.index.cox,]

survival.object = with(clean_bang_select, Surv(length, became_former_member))

# STEP 2a: Model selection using backward selection

selectCox(Surv(length, became_former_member) ~  age_group + 
                             employment_sector + 
                             membership +
                             attendance_grouping_ver.1 + 
                             monthly_rate_group + 
                             ever_billing_issue + 
                             num_emails_month + 
                             ever_email_month + 
                             new_per_ticket_scheduling +
                             ever_scheduling + 
                             new_per_ticket_service + 
                             ever_service +
                             new_per_ticket_cx + 
                             ever_cx,
                             data = clean_bang_cox.train,
                             rule = "aic")$In

# Top variables retained were: "num_emails_month", "ever_email_month", "new_per_ticket_scheduling", "new_per_ticket_cx" and "ever_cx"

# STEP 2a: Model selection using bi-direction stepwise regression selection


start.cox = coxph(Surv(length, became_former_member) ~ 1, data = clean_bang_cox.train)
all.cox = coxph(Surv(length, became_former_member) ~ age_group + 
                             employment_sector + 
                             membership +
                             attendance_grouping_ver.1 + 
                             monthly_rate_group + 
                             ever_billing_issue + 
                             num_emails_month + 
                             ever_email_month + 
                             new_per_ticket_scheduling +
                             ever_scheduling + 
                             new_per_ticket_service + 
                             ever_service +
                             new_per_ticket_cx + 
                             ever_cx, data = clean_bang_cox.train)

step(start.cox, direction = 'both', scope = formula(all.cox))

# new_per_ticket_scheduling, num_emails_month, ever_cx, ever_email_month, new_per_ticket_cx, attendance_grouping_ver.1, age_group, monthly_rate_group, ever_billing_issue and ever_scheduling



testing = cph(Surv(length, became_former_member) ~  
                num_emails_month + 
                ever_email_month + 
                new_per_ticket_scheduling + 
                new_per_ticket_cx + 
                ever_cx + 
                attendance_grouping_ver.1 +
                age_group + 
                monthly_rate_group + 
                ever_billing_issue + 
                ever_scheduling, data = clean_bang_cox.train, x = T, y = T, surv = T)

# Step 3a: Testing Assumption of the Model 

cox.zph(testing) # Issue with num_emails_month + new_per_ticket_cx

plot(	predict(testing), 
	residuals(testing, type = "deviance"), 
	xlab = "fitted values", 
	ylab = "residuals", 
	main = "residual plot", las = 1
)

abline(h = 0)


lines(smooth.spline(predict(testing), residuals(testing, type = 'deviance')), col = 'red')    

# Not even close to satisfying the assumptions of non-linearity; need to do some re-working  



# Step 3b: Rework predictor selection + Re-testing Assumption of the Model 

proposed.cox.model.train = cph(Surv(length, became_former_member) ~  
                ever_email_month + 
                new_per_ticket_scheduling + 
                new_per_ticket_cx + 
                ever_cx + 
                attendance_grouping_ver.1 +
                strat(age_group) + 
                ever_scheduling, data = clean_bang_cox.train, x = T, y = T, surv = T)


cox.zph(proposed.cox.model.train) # Holds the assumption of proportionality 

plot(
	predict(proposed.cox.model.train), 
	residuals(proposed.cox.model.train, type = "deviance"), 
	xlab = "fitted values", 
	ylab = "residuals", 
	main = "residual plot", las = 1
)

abline(h = 0)

lines(smooth.spline(predict(proposed.cox.model.train), residuals(proposed.cox.model.train, type = 'deviance')), col = 'red') # meh

train_surv = with(clean_bang_cox.train, Surv(length, became_former_member))
train.estimates = survest(proposed.cox.model.train, newdata = clean_bang_cox.train, times = 69)$surv
rcorr.cens(train.estimates, train_surv) # c = 0.7745 (aka. err.rate = 22.55%)

# Step 4: validating my proposed mode with test data set 

test_surv = with(clean_bang_cox.test, Surv(length, became_former_member)) # this is the survival object in which to test against 
estimates = survest(proposed.cox.model.train, newdata = clean_bang_cox.test, times = 69)$surv # time is just arbitrary here; survival estimates based on the training model using the test data set 
rcorr.cens(estimates, test_surv)  # C = 0.7756 or err.rate = 22.44%



# Step 5: Summary of the whole dataset using the proposed model

cox.model.churn = coxph(Surv(length, became_former_member) ~  
                ever_email_month + 
                new_per_ticket_scheduling + 
                new_per_ticket_cx + 
                ever_cx + 
                attendance_grouping_ver.1 +
                strata(age_group) + 
                ever_scheduling, data = clean_bang_select)

summary(cox.model.churn) # C-statistic = 0.781
AIC(cox.model.churn) # 2649.277
vif(cox.model.churn) # No issue of collinearity here 

cox.model.churn.a = coxph(Surv(length, became_former_member) ~  
                ever_email_month + 
                new_per_ticket_scheduling + 
                new_per_ticket_cx + 
                ever_cx + 
                attendance_grouping_ver.1 +
                ever_scheduling, data = clean_bang_select)

ggforest(cox.model.churn.a, main = "Hazard Ratio of the Proposed Cox-Regression Model") 

# Note: no idea on how to include the strata function into the ggforest
```

## Modeling retention status at 3-/6- and 12- months. 

### RETENTION ANALYSIS: Membership status at 3-Months via Random Forest 
   
   Using the random survival forest specific dataset, I've split the data set 80:20 with respect to training:test.  In forming the training model, which has an error rate of **6.69%**, it was found that the error rate in predicting membership length to churn with the test data was **10.23%**. So really a large differential.  Looking at the various ways to modify the parameters, it was found that the error rate more-or-less stabilized after 1000 trees as evident by the marginal differences in error rates at the higher number of trees. However, in terms of tuning this model, I've adjusted the model to include ntree = 2000 and mtry at 4.  Examining the importance of each variable used in this model, it was found that number of non-billing email interaction played the largest role, followed by the percent composition of non=billing related email interactions (scheduling, service and CX).
   
```{r}


# Step 1: Create a specific data set to be used for retention status analysis  

clean_bang_retention_3m = clean_bang_select %>% 
  select(
    age_group, 
    employment_sector, 
    retention_3m,
    avg_monthly_rate,
    attendance_grouping_ver.1,
    ever_email_month,
    num_emails_month,
    ever_billing_issue, 
    ever_cx,
    new_per_ticket_cx,
    ever_scheduling,
    new_per_ticket_scheduling,
    ever_service,
    new_per_ticket_service
  )

# Step 2: create a partition of this data set by splitting it based on retention status at 3 Months

trainIndex_3m = createDataPartition(clean_bang_retention_3m$retention_3m, p = 0.8, list = FALSE)
clean_bang_retention_3m.train = clean_bang_retention_3m[trainIndex_3m,] 
clean_bang_retention_3m.test = clean_bang_retention_3m[-trainIndex_3m,] 

# Step 3: Create a random forest model using training data 

training.model.3m = randomForest(retention_3m ~., data = clean_bang_retention_3m.train, proximity = T)
training.model.3m # OOB error rate is 8.71%

# Step 4: Create a data frame to see how the error rate changes as a function of increasing number of trees (currently capped at 500)

oob.error.data.3m = data.frame(
  Trees = rep(1:nrow(training.model.3m$err.rate), times = 3),
  Type = rep(c("OOB", "no", 'yes'), each = nrow(training.model.3m$err.rate)),
  Error = c(training.model.3m$err.rate[, "OOB"], 
            training.model.3m$err.rate[,"no"], 
            training.model.3m$err.rate[, 'yes']))

View(oob.error.data.3m)

ggplot(data = oob.error.data.3m, aes (x = Trees, y = Error)) + geom_line(aes(color = Type))

# Step 4a: Add more trees and see what happens: 

training.model.3m_ver1 = randomForest(retention_3m ~., data = clean_bang_retention_3m.train, proximity = T, ntree = 1000)
training.model.3m_ver2 = randomForest(retention_3m ~., data = clean_bang_retention_3m.train, proximity = T, ntree = 2000)
training.model.3m_ver3 = randomForest(retention_3m ~., data = clean_bang_retention_3m.train, proximity = T, ntree = 3000)

training.model.3m # REFERENCE
training.model.3m_ver1 # 9.47%
training.model.3m_ver2 # 9.75%
training.model.3m_ver3 # 9.75%

oob.error.data.3m_ver1 = data.frame(
  Trees = rep(1:nrow(training.model.3m_ver1$err.rate), times = 3),
  Type = rep(c("OOB", "no", 'yes'), each = nrow(training.model.3m_ver1$err.rate)),
  Error = c(training.model.3m_ver1$err.rate[, "OOB"], 
            training.model.3m_ver1$err.rate[,"no"], 
            training.model.3m_ver1$err.rate[, 'yes']))

oob.error.data.3m_ver2 = data.frame(
  Trees = rep(1:nrow(training.model.3m_ver2$err.rate), times = 3),
  Type = rep(c("OOB", "no", 'yes'), each = nrow(training.model.3m_ver2$err.rate)),
  Error = c(training.model.3m_ver2$err.rate[, "OOB"], 
            training.model.3m_ver2$err.rate[,"no"], 
            training.model.3m_ver2$err.rate[, 'yes']))

oob.error.data.3m_ver3 = data.frame(
  Trees = rep(1:nrow(training.model.3m_ver3$err.rate), times = 3),
  Type = rep(c("OOB", "no", 'yes'), each = nrow(training.model.3m_ver3$err.rate)),
  Error = c(training.model.3m_ver3$err.rate[, "OOB"], 
            training.model.3m_ver3$err.rate[,"no"], 
            training.model.3m_ver3$err.rate[, 'yes']))

ggplot(data = oob.error.data.3m_ver1, aes (x = Trees, y = Error)) + geom_line(aes(color = Type))
ggplot(data = oob.error.data.3m_ver2, aes (x = Trees, y = Error)) + geom_line(aes(color = Type))
ggplot(data = oob.error.data.3m_ver3, aes (x = Trees, y = Error)) + geom_line(aes(color = Type))

# Looks like we did a worse job with increasing number of trees, but this leveled off after 2000. 

# STEP 3B: Fine tuning mtry 

oob.values <- vector(length = 10)
for(i in 1:10) {
  temp.model <- randomForest(retention_3m ~., data = clean_bang_retention_3m.train, mtry = i, ntree = 2000)
  oob.values[i] <- temp.model$err.rate[nrow(temp.model$err.rate), 1]
}

oob.values

# Looks like optimal value is 4

proposed.training.model.3m =  randomForest(retention_3m ~., data = clean_bang_retention_3m.train, proximity = T, mtry = 4, ntree = 2000) # err.rate = 6.69%

attributes(proposed.training.model.3m)
proposed.training.model.3m$confusion


# Step 4: Test this proposed model against testing data 

pred_3m_rf <- predict(proposed.training.model.3m, newdata = clean_bang_retention_3m.test)
head(pred_3m_rf)
head(clean_bang_retention_3m.test$retention_3m)

cbind(pred_3m_rf, clean_bang_retention_3m.test$retention_3m)

results_3m = data.frame(
  individuals = rep(1:nrow(clean_bang_retention_3m.test)),
  prediction = pred_3m_rf,
  truth = clean_bang_retention_3m.test$retention_3m
)
results_3m

confusionMatrix(pred_3m_rf, clean_bang_retention_3m.test$retention_3m) # accuracy = 0.8977 or err.rate of 10.23%


# STEP 5: Determining which variables are important predictors 

varImp(proposed.training.model.3m)
varImpPlot(proposed.training.model.3m, sort = T, main = "Predictor Importance Ranking")
importance(proposed.training.model.3m)
varUsed(proposed.training.model.3m)

# Examining the model, it seems that num_emails_month played the most important role in predicting outcomes follwed by the percent compositions from each of the non-billing email interactions ( CX > scheduling > service). 

# Step 5a: Examining the effects of each variable on retention status (Top 4 predictors)

partialPlot(proposed.training.model.3m, clean_bang_retention_3m.test, num_emails_month, "no", main = "Marginal Effect of num_emails_month on the probability of not retaining membership at 3-Months")

partialPlot(proposed.training.model.3m, clean_bang_retention_3m.test, new_per_ticket_scheduling, "no", main = "Marginal Effect of new_per_ticket_scheduling on the probability of not retaining membership at 3-Months")

partialPlot(proposed.training.model.3m, clean_bang_retention_3m.test, new_per_ticket_service, "no", main = "Marginal Effect of new_per_ticket_service on the probability of not retaining membership at 3-Months")

partialPlot(proposed.training.model.3m, clean_bang_retention_3m.test, new_per_ticket_cx, "no", main = "Marginal Effect of new_per_ticket_cx on the probability of not retaining membership at 3-Months")

```

### RETENTION ANALYSIS: Membership status at 6-Months via Random Forest 
   
   Using the random survival forest specific dataset, I've split the data set 80:20 with respect to training:test.  In forming the training model, which has an error rate of **7.24%**, it was found that the error rate in predicting membership length to churn with the test data was **7.52%**, which is not a very good sign.  Looking at the various ways to modify the parameters, it was found that the error rate more-or-less stabilized after 1000 trees as evident by the marginal differences in error rates at the higher number of trees. However, in terms of tuning this model, I've adjusted the model to include ntree = 1000 and mtry at 3.  Examining the importance of each variable used in this model, it was found that number of non-billing email interaction played the largest role, followed by the percent composition of non-billing related email interactions (scheduling, service and CX).

```{r}

clean_bang_retention_6m = clean_bang_select %>% 
  select(
    age_group, 
    employment_sector, 
    retention_6m,
    avg_monthly_rate,
    attendance_grouping_ver.1,
    ever_email_month,
    num_emails_month,
    ever_billing_issue, 
    ever_cx,
    new_per_ticket_cx,
    ever_scheduling,
    new_per_ticket_scheduling,
    ever_service,
    new_per_ticket_service
  )

# Step 2: create a partition of this data set by splitting it based on retention status at 6 Months

trainIndex_6m = createDataPartition(clean_bang_retention_6m$retention_6m, p = 0.8, list = FALSE)
clean_bang_retention_6m.train = clean_bang_retention_6m[trainIndex_6m,] 
clean_bang_retention_6m.test = clean_bang_retention_6m[-trainIndex_6m,] 

# Step 3: Create a random forest model using training data 

training.model.6m = randomForest(retention_6m ~., data = clean_bang_retention_6m.train, proximity = T)
training.model.6m # OOB error rate is 7.24%

# Step 4: Create a data frame to see how the error rate changes as a function of increasing number of trees (currently capped at 500)

oob.error.data.6m = data.frame(
  Trees = rep(1:nrow(training.model.6m$err.rate), times = 3),
  Type = rep(c("OOB", "no", 'yes'), each = nrow(training.model.6m$err.rate)),
  Error = c(training.model.6m$err.rate[, "OOB"], 
            training.model.6m$err.rate[,"no"], 
            training.model.6m$err.rate[, 'yes']))

View(oob.error.data.6m)

ggplot(data = oob.error.data.6m, aes (x = Trees, y = Error)) + geom_line(aes(color = Type))

# Step 4a: Add more trees and see what happens: 

training.model.6m_ver1 = randomForest(retention_6m ~., data = clean_bang_retention_6m.train, proximity = T, ntree = 1000)
training.model.6m_ver2 = randomForest(retention_6m ~., data = clean_bang_retention_6m.train, proximity = T, ntree = 2000)
training.model.6m_ver3 = randomForest(retention_6m ~., data = clean_bang_retention_6m.train, proximity = T, ntree = 3000)

training.model.6m # REFERENCE
training.model.6m_ver1 # 9.19%
training.model.6m_ver2 # 8.64%
training.model.6m_ver3 # 8.64%

oob.error.data.6m_ver1 = data.frame(
  Trees = rep(1:nrow(training.model.6m_ver1$err.rate), times = 3),
  Type = rep(c("OOB", "no", 'yes'), each = nrow(training.model.6m_ver1$err.rate)),
  Error = c(training.model.6m_ver1$err.rate[, "OOB"], 
            training.model.6m_ver1$err.rate[,"no"], 
            training.model.6m_ver1$err.rate[, 'yes']))

oob.error.data.6m_ver2 = data.frame(
  Trees = rep(1:nrow(training.model.6m_ver2$err.rate), times = 3),
  Type = rep(c("OOB", "no", 'yes'), each = nrow(training.model.6m_ver2$err.rate)),
  Error = c(training.model.6m_ver2$err.rate[, "OOB"], 
            training.model.6m_ver2$err.rate[,"no"], 
            training.model.6m_ver2$err.rate[, 'yes']))

oob.error.data.6m_ver3 = data.frame(
  Trees = rep(1:nrow(training.model.6m_ver3$err.rate), times = 3),
  Type = rep(c("OOB", "no", 'yes'), each = nrow(training.model.6m_ver3$err.rate)),
  Error = c(training.model.6m_ver3$err.rate[, "OOB"], 
            training.model.6m_ver3$err.rate[,"no"], 
            training.model.6m_ver3$err.rate[, 'yes']))

ggplot(data = oob.error.data.6m_ver1, aes (x = Trees, y = Error)) + geom_line(aes(color = Type))
ggplot(data = oob.error.data.6m_ver2, aes (x = Trees, y = Error)) + geom_line(aes(color = Type))
ggplot(data = oob.error.data.6m_ver3, aes (x = Trees, y = Error)) + geom_line(aes(color = Type))

# Looks like we did a worse job with increasing number of trees, but this leveled off after 2000. 

# STEP 3B: Fine tuning mtry 

oob.values <- vector(length = 10)
for(i in 1:10) {
  temp.model <- randomForest(retention_6m ~., data = clean_bang_retention_6m.train, mtry = i, ntree = 1000)
  oob.values[i] <- temp.model$err.rate[nrow(temp.model$err.rate), 1]
}

oob.values

# Looks like optimal value is 4

proposed.training.model.6m =  randomForest(retention_6m ~., data = clean_bang_retention_6m.train, proximity = T, mtry = 3, ntree = 1000) # err.rate = 7.52%

proposed.training.model.6m$confusion


# Step 4: Test this proposed model against testing data 

pred_6m_rf <- predict(proposed.training.model.6m, newdata = clean_bang_retention_6m.test)
head(pred_6m_rf)
head(clean_bang_retention_6m.test$retention_6m)

cbind(pred_6m_rf, clean_bang_retention_6m.test$retention_6m)

results_6m = data.frame(
  individuals = rep(1:nrow(clean_bang_retention_6m.test)),
  prediction = pred_6m_rf,
  truth = clean_bang_retention_6m.test$retention_6m
)
results_6m

confusionMatrix(pred_6m_rf, clean_bang_retention_6m.test$retention_6m) # accuracy = 0.8295 or err.rate of 17.05%

# STEP 5: Determining which variables are important predictors 

varImp(proposed.training.model.6m)
varImpPlot(proposed.training.model.6m, sort = T, main = "Predictor Importance Ranking")
importance(proposed.training.model.6m)
varUsed(proposed.training.model.6m)

# Examining the model, it seems that num_emails_month played the most important role in predicting outcomes follwed by the percent compositions from each of the non-billing email interactions (scheduling >  service > CX). 

# Step 5a: Examining the effects of each variable on retention status (Top 4 predictors)

partialPlot(proposed.training.model.6m, clean_bang_retention_6m.test, num_emails_month, "no", main = "Marginal Effect of num_emails_month on the probability of not retaining membership at 6-Months")

partialPlot(proposed.training.model.6m, clean_bang_retention_6m.test, new_per_ticket_scheduling, "no", main = "Marginal Effect of new_per_ticket_scheduling on the probability of not retaining membership at 6-Months")

partialPlot(proposed.training.model.6m, clean_bang_retention_6m.test, new_per_ticket_service, "no", main = "Marginal Effect of new_per_ticket_service on the probability of not retaining membership at 6-Months")

partialPlot(proposed.training.model.6m, clean_bang_retention_6m.test, new_per_ticket_cx, "no", main = "Marginal Effect of new_per_ticket_cx on the probability of not retaining membership at 6-Months")


```
   

### RETENTION ANALYSIS: Membership status at 12-Months via Random Forest 
   
   Using the random survival forest specific data set, I've split the data set 80:20 with respect to training:test.  In forming the training model, which has an error rate of **12.01**, it was found that the error rate in predicting membership length to churn with the test data was **12.36%**.  Looking at the various ways to modify the parameters, it was found that the error rate more-or-less stabilized after 1000 trees as evident by the marginal differences in error rates at the higher number of trees. However, in terms of tuning this model, I've adjusted the model to include ntree = 2000 and mtry at 3.  Examining the importance of each variable used in this model, it was found that number of non-billing email interaction played the largest role, followed by the percent composition of non-billing related email interactions (scheduling, service and CX).
  
```{r}

clean_bang_retention_12m = clean_bang_select %>% 
  select(
    age_group, 
    employment_sector, 
    retention_12m,
    avg_monthly_rate,
    attendance_grouping_ver.1,
    ever_email_month,
    num_emails_month,
    ever_billing_issue, 
    ever_cx,
    new_per_ticket_cx,
    ever_scheduling,
    new_per_ticket_scheduling,
    ever_service,
    new_per_ticket_service
  )

# Step 2: create a partition of this data set by splitting it based on retention status at 12 Months

trainIndex_12m = createDataPartition(clean_bang_retention_12m$retention_12m, p = 0.8, list = FALSE)
clean_bang_retention_12m.train = clean_bang_retention_12m[trainIndex_12m,] 
clean_bang_retention_12m.test = clean_bang_retention_12m[-trainIndex_12m,] 

# Step 3: Create a random forest model using training data 

training.model.12m = randomForest(retention_12m ~., data = clean_bang_retention_12m.train, proximity = T)
training.model.12m # OOB error rate is 12.85%

# Step 4: Create a data frame to see how the error rate changes as a function of increasing number of trees (currently capped at 500)

oob.error.data.12m = data.frame(
  Trees = rep(1:nrow(training.model.12m$err.rate), times = 3),
  Type = rep(c("OOB", "no", 'yes'), each = nrow(training.model.12m$err.rate)),
  Error = c(training.model.12m$err.rate[, "OOB"], 
            training.model.12m$err.rate[,"no"], 
            training.model.12m$err.rate[, 'yes']))

View(oob.error.data.12m)

ggplot(data = oob.error.data.12m, aes (x = Trees, y = Error)) + geom_line(aes(color = Type))

# Step 4a: Add more trees and see what happens: 

training.model.12m_ver1 = randomForest(retention_12m ~., data = clean_bang_retention_12m.train, proximity = T, ntree = 1000)
training.model.12m_ver2 = randomForest(retention_12m ~., data = clean_bang_retention_12m.train, proximity = T, ntree = 2000)
training.model.12m_ver3 = randomForest(retention_12m ~., data = clean_bang_retention_12m.train, proximity = T, ntree = 3000)

training.model.12m # REFERENCE
training.model.12m_ver1 # 12.85%
training.model.12m_ver2 # 11.01%
training.model.12m_ver3 # 11.01%

oob.error.data.12m_ver1 = data.frame(
  Trees = rep(1:nrow(training.model.12m_ver1$err.rate), times = 3),
  Type = rep(c("OOB", "no", 'yes'), each = nrow(training.model.12m_ver1$err.rate)),
  Error = c(training.model.12m_ver1$err.rate[, "OOB"], 
            training.model.12m_ver1$err.rate[,"no"], 
            training.model.12m_ver1$err.rate[, 'yes']))

oob.error.data.12m_ver2 = data.frame(
  Trees = rep(1:nrow(training.model.12m_ver2$err.rate), times = 3),
  Type = rep(c("OOB", "no", 'yes'), each = nrow(training.model.12m_ver2$err.rate)),
  Error = c(training.model.12m_ver2$err.rate[, "OOB"], 
            training.model.12m_ver2$err.rate[,"no"], 
            training.model.12m_ver2$err.rate[, 'yes']))

oob.error.data.12m_ver3 = data.frame(
  Trees = rep(1:nrow(training.model.12m_ver3$err.rate), times = 3),
  Type = rep(c("OOB", "no", 'yes'), each = nrow(training.model.12m_ver3$err.rate)),
  Error = c(training.model.12m_ver3$err.rate[, "OOB"], 
            training.model.12m_ver3$err.rate[,"no"], 
            training.model.12m_ver3$err.rate[, 'yes']))

ggplot(data = oob.error.data.12m_ver1, aes (x = Trees, y = Error)) + geom_line(aes(color = Type))
ggplot(data = oob.error.data.12m_ver2, aes (x = Trees, y = Error)) + geom_line(aes(color = Type))
ggplot(data = oob.error.data.12m_ver3, aes (x = Trees, y = Error)) + geom_line(aes(color = Type))

# Looks like we did a worse job with increasing number of trees, but this leveled off after 1000. 

# STEP 3B: Fine tuning mtry 

oob.values <- vector(length = 10)
for(i in 1:10) {
  temp.model <- randomForest(retention_12m ~., data = clean_bang_retention_12m.train, mtry = i, ntree = 1000)
  oob.values[i] <- temp.model$err.rate[nrow(temp.model$err.rate), 1]
}

oob.values

# Looks like optimal value is 8

proposed.training.model.12m =  randomForest(retention_12m ~., data = clean_bang_retention_12m.train, proximity = T, mtry = 8, ntree = 1000) # err.rate = 13.41%

proposed.training.model.12m$confusion


# Step 4: Test this proposed model against testing data 

pred_12m_rf <- predict(proposed.training.model.12m, newdata = clean_bang_retention_12m.test)
head(pred_12m_rf)
head(clean_bang_retention_12m.test$retention_12m)

cbind(pred_12m_rf, clean_bang_retention_12m.test$retention_12m)

results_12m = data.frame(
  individuals = rep(1:nrow(clean_bang_retention_12m.test)),
  prediction = pred_12m_rf,
  truth = clean_bang_retention_12m.test$retention_12m
)
results_12m

confusionMatrix(pred_12m_rf, clean_bang_retention_12m.test$retention_12m) # accuracy = 0.9326 or err.rate of 6.74%

# STEP 5: Determining which variables are important predictors 

varImp(proposed.training.model.12m)
varImpPlot(proposed.training.model.12m, sort = T, main = "Predictor Importance Ranking")
importance(proposed.training.model.12m)
varUsed(proposed.training.model.12m)

# Examining the model, it seems that num_emails_month played the most important role in predicting outcomes follwed by the percent compositions from each of the non-billing email interactions (scheduling > CX > service). 

# Step 5a: Examining the effects of each variable on retention status (Top 4 predictors)

partialPlot(proposed.training.model.12m, clean_bang_retention_12m.test, num_emails_month, "no", main = "Marginal Effect of num_emails_month on the probability of not retaining membership at 12-Months")

partialPlot(proposed.training.model.12m, clean_bang_retention_12m.test, new_per_ticket_scheduling, "no", main = "Marginal Effect of new_per_ticket_scheduling on the probability of not retaining membership at 12-Months")

partialPlot(proposed.training.model.12m, clean_bang_retention_12m.test, new_per_ticket_service, "no", main = "Marginal Effect of new_per_ticket_service on the probability of not retaining membership at 12-Months")

partialPlot(proposed.training.model.12m, clean_bang_retention_12m.test, new_per_ticket_cx, "no", main = "Marginal Effect of new_per_ticket_cx on the probability of not retaining membership at 12-Months")

```
   
### RETENTION ANALYSIS: 3 Months via Logistic Regression 

  In generating a logistic regression model for membership status at 3-month, it was found that the variables that were retained through bi-directional stepwise regression through partitioned data (80-:20) were 
      * number of non-billing email interactions per month 
      * status of ever having a CX-related email interaction 
      * status of ever having a non-billing email interaction 
      * percent composition of total interactions being CX-related email interactions
      * percent composition of total interactions being scheduling-related email interactions
      * status of ever having a service-related email interaction
  
  In cross-validating the proposed model through the validation set approach as well as repeated K-fold validation that the accuracy of the model ranged b/t **86.36% - 91.60%**. The major predictors turned out to be num_emails_month, new_per_ticket_scheduling, ever_cx and new_per_ticket_cx.  


```{r}
# Step 1: Partition data

trainIndex_3m = createDataPartition(clean_bang_select$retention_3m, p = 0.8, list = F)

clean_bang_select.3m_train = clean_bang_select[trainIndex_3m,] # This is the Training Data (80% of the data)
clean_bang_select.3m_test = clean_bang_select[-trainIndex_3m,] # This is the Testing Data (20% of the data)


# Step 2: Bi-directional Stepwise regression 

model.start.train_3m = glm(retention_3m ~ 1, data = clean_bang_select.3m_train , family = binomial(link = 'logit'))
model.all.train_3m = glm(retention_3m ~ age_group + 
					employment_sector + 
					membership + 
					attendance_grouping_ver.1 + 
					monthly_rate_group + 
					ever_email_month + 
					num_emails_month + 
					ever_cx+
					new_per_ticket_cx + 
					ever_service+
					new_per_ticket_service +
					ever_scheduling +
					new_per_ticket_scheduling, 
					data = clean_bang_select.3m_train , family = binomial(link = 'logit'))

step(model.start.train_3m, direction = 'both', scope = formula(model.all.train_3m))

model.retained.train_3m = glm(retention_3m ~ num_emails_month + 
                                new_per_ticket_scheduling + 
                                ever_cx + 
                                new_per_ticket_cx + 
                                ever_email_month + 
                                ever_service, 
                                family = binomial(link = "logit"), data = clean_bang_select.3m_train)

# Step 3: Assessing the proposed model

summary(model.retained.train_3m)
AIC(model.retained.train_3m) # 153.79
exp(cbind(OR = coef(model.retained.train_3m), confint.default(model.retained.train_3m)))
varImp(model.retained.train_3m, sort = T) # Biggest predictors = num_emails_month, new_per_ticket_scheduling, ever_cx, new_per_ticket_cx


# Step 4a: validating the proposed model 

pred_3m_log <- predict(model.retained.train_3m, newdata = clean_bang_select.3m_test)
pred_3m_log = ifelse(pred_3m_log > 0.5, 'yes', 'no')
table(pred_3m_log, clean_bang_select.3m_test$retention_3m)

accuracy = table(pred_3m_log, clean_bang_select.3m_test[, "retention_3m"])
accuracy
sum(diag(accuracy))/sum(accuracy)

mean(pred_3m_log == clean_bang_select.3m_test$retention_3m) # 86.36% accuracy (or err.rate = 13.64%)


# Step 4b: repeated k-fold validation 

repeat_ctrl <- trainControl(method = "repeatedcv", number = 10, repeats = 3)
proposed.model.retained.3m = train(retention_3m ~ num_emails_month + 
                                new_per_ticket_scheduling + 
                                ever_cx + 
                                new_per_ticket_cx + 
                                ever_email_month + 
                                ever_service, 
                                data = clean_bang_select, 
                                method = 'glm',
                                family = 'binomial',
                                trControl = repeat_ctrl, tuneLength = 5)

proposed.model.retained.3m # accuracy = 91.6%


# Step 4c: k-fold validation 

ctrl = trainControl(method = 'cv', number = 10)
proposed.model.retained.3m = train(retention_3m ~ num_emails_month + 
                                new_per_ticket_scheduling + 
                                ever_cx + 
                                new_per_ticket_cx + 
                                ever_email_month + 
                                ever_service,
                                data = clean_bang_select, 
                                method = 'glm',
                                family = 'binomial',
                                trControl = ctrl, tuneLength = 5)

proposed.model.retained.3m # accuracy 91.48%


# Step 5: sumamry of proposed model on original data set

log.model.3m = glm(retention_3m ~ num_emails_month + 
                                new_per_ticket_scheduling + 
                                ever_cx + 
                                new_per_ticket_cx + 
                                ever_email_month + 
                                ever_service, 
                                family = binomial(link = 'logit'), data = clean_bang_select)

summary(log.model.3m)
exp(cbind(OR = coef(log.model.3m), confint.default(log.model.3m)))
exp(coef(log.model.3m))
vif(log.model.3m) # A potential concern of collinearity regarding ever_cx + new_per_ticket_cx
AIC(log.model.3m)

```
   
### RETENTION ANALYSIS: 6-Months via Logistic Regression


  In generating a logistic regression model for membership status at 6-month, it was found that the variables that were retained through bi-directional stepwise regression through partitioned data (80-:20) were 
          * number of non-billing email interactions per month 
          * percent composition of scheduling-related email interactions 
          * Status of ever having a non-billing-related email interaction
          * status of ever haivng a CX-related email interaction
          * percent composition of service-related email interactions 
          * percent composition of CX-related email interactions  
  
  In cross-validating the proposed model through the validation set approach as well as repeated K-fold validation that the accuracy of the model ranged b/t **85.22% - 90.44%**. The major predictors turned out to be num_emails_month, new_per_ticket_scheduling, ever_cx and ever_email_month.  

```{r}

# Step 1: Partition data

trainIndex_6m = createDataPartition(clean_bang_select$retention_6m, p = 0.8, list = F)

clean_bang_select.6m_train = clean_bang_select[trainIndex_6m,] # This is the Training Data (80% of the data)
clean_bang_select.6m_test = clean_bang_select[-trainIndex_6m,] # This is the Testing Data (20% of the data)


# Step 2: Bi-directional Stepwise regression 

model.start.train_6m = glm(retention_6m ~ 1, data = clean_bang_select.6m_train, family = binomial(link = 'logit'))
model.all.train_6m = glm(retention_6m ~ age_group + 
					employment_sector + 
					membership + 
					attendance_grouping_ver.1 + 
					monthly_rate_group + 
					ever_email_month + 
					num_emails_month + 
					ever_cx+
					new_per_ticket_cx + 
					ever_service+
					new_per_ticket_service +
					ever_scheduling +
					new_per_ticket_scheduling, 
					data = clean_bang_select.6m_train, family = binomial(link = 'logit'))

step(model.start.train_6m, direction = 'both', scope = formula(model.all.train_6m))

model.retained.train_6m = glm(retention_6m ~ num_emails_month + 
                                new_per_ticket_scheduling + 
                                ever_cx + 
                                ever_email_month + 
                                new_per_ticket_service +
                                new_per_ticket_cx, 
                                family = binomial(link = "logit"), data = clean_bang_select.6m_train)

# Step 3: Assessing the proposed model

summary(model.retained.train_6m)
AIC(model.retained.train_6m)# 191.86
exp(cbind(OR = coef(model.retained.train_6m), confint.default(model.retained.train_6m)))
varImp(model.retained.train_6m, sort = T) # Top predictors are: num_emails_month, new_per_ticket_scheduling, ever_cx, ever_email_month and new_per_ticket_service 


# Step 4a: validating the proposed model 

pred_6m_log <- predict(model.retained.train_6m, newdata = clean_bang_select.6m_test)
pred_6m_log = ifelse(pred_6m_log > 0.5, 'yes', 'no')
table(pred_6m_log, clean_bang_select.6m_test$retention_6m)

accuracy = table(pred_6m_log, clean_bang_select.6m_test[, "retention_6m"])
accuracy
sum(diag(accuracy))/sum(accuracy)

mean(pred_6m_log == clean_bang_select.6m_test$retention_6m) # 85.22% or err.rate of 14.78%


# Step 4b: repeated k-fold validation 

repeat_ctrl <- trainControl(method = "repeatedcv", number = 10, repeats = 3)
proposed.model.retained.6m = train(retention_6m ~ num_emails_month + 
                                new_per_ticket_scheduling + 
                                ever_cx + 
                                ever_email_month + 
                                new_per_ticket_service +
                                new_per_ticket_cx, 
                                data = clean_bang_select, 
                                method = 'glm',
                                family = 'binomial',
                                trControl = repeat_ctrl, tuneLength = 5)

proposed.model.retained.6m # accuracy = 90.44%


# Step 4c: k-fold validation 

ctrl = trainControl(method = 'cv', number = 10)
proposed.model.retained.6m = train(retention_6m ~ num_emails_month + 
                                new_per_ticket_scheduling + 
                                ever_cx + 
                                ever_email_month + 
                                new_per_ticket_service +
                                new_per_ticket_cx, 
                                data = clean_bang_select, 
                                method = 'glm',
                                family = 'binomial',
                                trControl = ctrl, tuneLength = 5)

proposed.model.retained.6m # accuracy 89.91%


# Step 5: sumamry of proposed model on original data set

log.model.6m = glm(retention_6m ~ num_emails_month + 
                                new_per_ticket_scheduling + 
                                ever_cx + 
                                ever_email_month + 
                                new_per_ticket_service +
                                new_per_ticket_cx, 
                                family = binomial(link = "logit"), 
                                data = clean_bang_select)

summary(log.model.6m)
AIC(log.model.6m)
exp(coef(log.model.6m))
vif(log.model.6m)
exp(cbind(OR = coef(log.model.6m), confint.default(log.model.6m)))

``` 

### RETENTION ANALYSIS: 12M Membership Retention Status 

 In generating a logistic regression model for membership status at 12-month, it was found that the variables that were retained through bi-directional stepwise regression through partitioned data (80-:20) were 
 
          * status of ever haivng a CX-related email interaction
          * percent composition of scheduling-related email interactions
          * percent composition of service-related email interactions
          * Status of ever having a non-billing email interaction
          * monthly membership rates
          * number of non-billing related email interaction per month. 
          
  In cross-validating the proposed model through the validation set approach as well as repeated K-fold validation that the accuracy of the model ranged b/t **86.76% - 90.00%**. The major predictors turned out to be ever_cx, new_per_ticket_scheduling, num_emails_month and ever_email_month.  

```{r}

# Step 1: Partition data

trainIndex_12m = createDataPartition(clean_bang_select$retention_12m, p = 0.8, list = F)

clean_bang_select.12m_train = clean_bang_select[trainIndex_12m,] # This is the Training Data (80% of the data)
clean_bang_select.12m_test = clean_bang_select[-trainIndex_12m,] # This is the Testing Data (20% of the data)


# Step 2: Bi-directional Stepwise regression 

model.start.train_12m = glm(retention_12m ~ 1, data = clean_bang_select.12m_train, family = binomial(link = 'logit'))
model.all.train_12m = glm(retention_12m ~ age_group + 
					employment_sector + 
					membership + 
					attendance_grouping_ver.1 + 
					monthly_rate_group + 
					ever_email_month + 
					num_emails_month + 
					ever_cx+
					new_per_ticket_cx + 
					ever_service+
					new_per_ticket_service +
					ever_scheduling +
					new_per_ticket_scheduling, 
					data = clean_bang_select.12m_train, family = binomial(link = 'logit'))

step(model.start.train_12m, direction = 'both', scope = formula(model.all.train_12m))

model.retained.train_12m = glm(retention_12m ~ new_per_ticket_scheduling + 
                                 num_emails_month + 
                                 ever_cx + 
                                 ever_email_month + 
                                 monthly_rate_group + 
                                 new_per_ticket_service, 
                                family = binomial(link = "logit"), 
                               data = clean_bang_select.12m_train)


# Step 3: Assessing the proposed model

summary(model.retained.train_12m)
AIC(model.retained.train_12m) # 169.274
exp(cbind(OR = coef(model.retained.train_12m), confint.default(model.retained.train_12m)))
varImp(model.retained.train_12m, sort = T) # Top predictors are:new_per_ticket_scheduling, num_emails_month, ever_email_month and ever_cx


# Step 4: validating the proposed model 

pred_12m_log <- predict(model.retained.train_12m, newdata = clean_bang_select.12m_test)
pred_12m_log = ifelse(pred_12m_log > 0.5, 'yes', 'no')
table(pred_12m_log, clean_bang_select.12m_test$retention_12m)

accuracy = table(pred_12m_log, clean_bang_select.12m_test[, "retention_12m"])
accuracy
sum(diag(accuracy))/sum(accuracy)

mean(pred_12m_log == clean_bang_select.12m_test$retention_12m) # 88.76% or err.rate of 11.24%


#Step 4b: repeated k-fold validation 

repeat_ctrl <- trainControl(method = "repeatedcv", number = 10, repeats = 3)
proposed.model.retained.12m = train(retention_12m ~ new_per_ticket_scheduling + 
                                 num_emails_month + 
                                 ever_cx + 
                                 ever_email_month + 
                                 monthly_rate_group + 
                                 new_per_ticket_service, 
                                data = clean_bang_select, 
                                method = 'glm',
                                family = 'binomial',
                                trControl = repeat_ctrl, tuneLength = 5)

proposed.model.retained.12m # accuracy = 90.00%


# Step 4c: k-fold validation 

ctrl = trainControl(method = 'cv', number = 10)
proposed.model.retained.12m = train(retention_12m ~ new_per_ticket_scheduling + 
                                 num_emails_month + 
                                 ever_cx + 
                                 ever_email_month + 
                                 monthly_rate_group + 
                                 new_per_ticket_service, 
                                data = clean_bang_select, 
                                method = 'glm',
                                family = 'binomial',
                                trControl = ctrl, tuneLength = 5)

proposed.model.retained.12m # accuracy 89.96%


# Step 5: sumamry of proposed model on original data set

log.model.12m = glm(retention_12m ~ new_per_ticket_scheduling + 
                                 num_emails_month + 
                                 ever_cx + 
                                 ever_email_month + 
                                 monthly_rate_group + 
                                 new_per_ticket_service, 
                                family = binomial(link = "logit"), 
                                data = clean_bang_select)


summary(log.model.12m)
AIC(log.model.12m)
exp(coef(log.model.12m))
vif(log.model.12m)
exp(cbind(OR = coef(log.model.12m), confint.default(log.model.12m)))

```


# **DISCUSSION**

 During this analysis, several notable results were shown that can be taken in our approach to ensuring membership retention. 

1) The most commonly noted reason for membership churn being related to finance + lack of accessibility/availability.  There were several findings that seemed to support this such as:
		* The majority of our clientele being in scheduling demanding fields: technology, advertising/media and finance. 
		* Majority having an attendance rate of less than 70% 
		* Approx. 1/3 of total email interaction with staff pertaining to scheduling or rescheduling requests. 

2) While the median membership length was approximately 4.5 months, this differed across membership type and demographics 

		* Technology sector having one of the longest membership duration as compared to others VS. government/social services + retail/accommodation/hospitality having the lowest
		* 30-44 demographic had the longest membership length out of all age groups 
		* 2x/week membership > 3x/week membership in terms of length. Interestingly, those that have unlimited number of Hybrid sessions also tend to have a longer membership retention
		* Monthly rates b/t 300-399 appear to be "sweet spot" in terms of length of membership with noticeable degradation in membership length with rates beyond $400

3) The impact of the COVID pandemic has significantly reduced the clientele by 31% from our initial shutdown.  This was cited as the 3rd most common reason for membership loss over the last two years.  

4) The importance of customer interactions was also noted. 

Namely, it was found that an increase in the number of non-billing email interaction per month was associated with an increased odds of membership churn.  However in terms of type of email interaction, having even a single CX-related email interaction outside of the onboarding process was found to significantly increased the odds of membership retention at 3-, 6- and 12-months. Although significant, the impact of an increasing the number of CX-related email interaction had a small decrease in the odds of membership churn.  

In terms of improving retention status, efforts should be made with respect to minimizing the drop in attendance seeing as we are not going to be changing our business model anytime soon.  Habit-focus development appears to be a key area to dive into to address this issue.  Namely the adoption of a "fallback" option could be introduced and highlighted early on during the on-boarding transition phase highlighting strategies to prepare and implement for situations of inevitable scheduling disruptions.  From the membership-service end, a work flow could be developed to track and assess attendance across several time points over a 90 day span to see what really is the best membership is for a new member.  While the default option has been the push to 3x/week, this option has been shown to fail to sustain membership retention over 3-months as compared to the 2x/week option.  This is possibly due to the sense of inadequate return in value considering the noticeable price point, along with some potential difficulty to attend enough sessions to justify said price point. 

Possible solutions can be 
(1) revision into pricing --> considering that most current members were under older or modified pricing as compared to the updated membership rates 
(2) reframing return of value based on attendance or provide lower cost additions to justify membership price point (i.e. increased group class schedule, nutritional-habit coaching, etc.)
(3) early membership service team intervention to handle finding out the right membership type based on previous attendance rates --> similar to those wine/snackbox subscription where we will find the best solution for the member for their value = improve CX --> this can be stratified based on certain demographics 
(4) Improving on schedule availability could be an option 

